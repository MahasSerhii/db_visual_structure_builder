<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Graph Editor (Offline)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load D3.js for graph visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <!-- Load html2canvas for image download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Custom styles for the graph visualization */
        .node-group { cursor: grab; }
        .node-group:active { cursor: grabbing; }
        .node-rect { 
            stroke: #E5E7EB; /* Lighter Stroke */
            stroke-width: 1.5px; 
            rx: 8; /* Slightly smaller radius */
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.05)); /* Very soft shadow */
            transition: all 0.2s ease;
        }
        .node-rect:hover {
            stroke: #6366F1;
            filter: drop-shadow(0 10px 15px rgba(99, 102, 241, 0.15));
        }

        .link-line { fill: none; transition: all 0.3s; } 
        .link-line:hover { opacity: 0.7; cursor: pointer; }
        .link-text { fill: #6B7280; font-size: 10px; font-family: 'Inter', sans-serif; pointer-events: none; opacity: 0.8; transition: opacity 0.2s;}
        .link-group:hover .link-text { opacity: 1; font-weight: 600; }
        
        .prop-color-input { -webkit-appearance: none; appearance: none; border: none; width: 12px; height: 12px; padding: 0; background: none; cursor: pointer; }

        .curve-handle { opacity: 0; transition: opacity 0.2s; }
        .link-path:hover + .curve-handle { opacity: 1; }
        
        /* New Styles for Link Icon */
        .doc-link-icon { font-size: 12px; fill: rgba(255,255,255,0.7); cursor: pointer; transition: fill 0.2s;}
        .doc-link-icon:hover { fill: #FFD700; }

        /* Minimal Sidebar Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #E5E7EB; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #D1D5DB; }

        /* Accordion Styles */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: sweep .3s ease-in-out; }
        @keyframes sweep { 0% {opacity: 0; margin-top: -10px} 100% {opacity: 1; margin-top: 0px} }
        
        /* Chatbot Animations */
        @keyframes pulse-once {
            0% { transform: scale(0.95); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pulse-once {
            animation: pulse-once 0.3s ease-out forwards;
        }
        .animation-fade-in-up {
            animation: fadeInUp 0.3s ease-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Dark Mode Overrides */
        body.dark { background-color: #111827; color: #F9FAFB; }
        body.dark #sidebar, body.dark .bg-white { background-color: #1F2937 !important; color: #F9FAFB !important; border-color: #374151 !important; }
        body.dark .bg-gray-50, body.dark .bg-gray-100 { background-color: #111827 !important; color: #E5E7EB !important; border-color: #374151 !important; }
        body.dark input, body.dark select, body.dark textarea { background-color: #374151 !important; color: white !important; border-color: #4B5563 !important; }
        body.dark .text-gray-500, body.dark .text-gray-600, body.dark .text-gray-700 { color: #9CA3AF !important; }
        body.dark .text-gray-800, body.dark .text-gray-900 { color: #F3F4F6 !important; }
        body.dark .border-gray-200, body.dark .border-gray-300 { border-color: #4B5563 !important; }
        
        /* Dark Mode for Modals Specifically */
        body.dark .fixed .bg-white { background-color: #1F2937 !important; border-color: #374151 !important; }
        body.dark .fixed .bg-gray-50 { background-color: #111827 !important; }

        /* Graph Grid Background (School Book Style) */
        #diagram-container {
            background-color: #ffffff;
            background-image: 
                linear-gradient(#e5e7eb 1px, transparent 1px),
                linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }
        body.dark #diagram-container {
            background-color: #111827;
            background-image: 
                linear-gradient(#374151 1px, transparent 1px),
                linear-gradient(90deg, #374151 1px, transparent 1px);
            border-color: #374151 !important;
        }
        
        /* Dark Mode: Remove opaque modal background */
        body.dark .bg-gray-50\/50 {
            background-color: transparent !important;
        }

        /* Lock Blinking Animation - Vanish */
        .blink-lock .lock-icon-path {
            animation: vanish-animation 0.5s ease-in-out 1;
        }
        @keyframes vanish-animation {
            0% { opacity: 1; }
            20% { opacity: 0; }
            80% { opacity: 0; }
            100% { opacity: 1; }
        }

        /* Custom Tooltip */
        #custom-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 250px;
            white-space: pre-wrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        /* Wait, we can't use JS variables in CSS keyframes. 
           The transform in JS was: translate(${MIN_BOX_WIDTH/2 - 24}, -8) scale(0.7)
           MIN_BOX_WIDTH is 200. So 100 - 24 = 76.
           translate(76px, -8px) scale(0.7)
        */
        @keyframes shake-animation {
            0% { transform: translate(76px, -8px) scale(0.7) rotate(0deg); }
            20% { transform: translate(76px, -8px) scale(0.7) rotate(-20deg); }
            40% { transform: translate(76px, -8px) scale(0.7) rotate(15deg); }
            60% { transform: translate(76px, -8px) scale(0.7) rotate(-10deg); }
            80% { transform: translate(76px, -8px) scale(0.7) rotate(5deg); }
            100% { transform: translate(76px, -8px) scale(0.7) rotate(0deg); }
        }
        .locked-cursor {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex text-gray-900 font-sans transition-colors duration-300">

    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <!-- Sidebar (Component Manager) -->
    <div id="sidebar" class="w-80 bg-white flex flex-col transition-[width] duration-300 ease-in-out border-r border-gray-200 shadow-xl z-50 shrink-0 relative">
        
        <!-- Toggle Button (Arrow Tab) -->
        <button id="sidebar-toggle" onclick="toggleSidebar()" class="absolute -right-5 top-1/2 -translate-y-1/2 bg-white border-y border-r border-gray-200 text-gray-400 hover:text-indigo-600 rounded-r-xl w-5 h-16 shadow-md z-50 flex items-center justify-center transition-colors outline-none focus:outline-none group">
             <svg id="sidebar-icon" class="w-3 h-3 transition-transform duration-300 transform rotate-180 group-hover:scale-125" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </button>

        <!-- Top Navigation (Air Design) -->
        <div id="sidebar-nav" class="flex justify-around items-center p-3 border-b border-gray-100 bg-white gap-2 z-10">
            <button onclick="switchTab('create')" id="btn-tab-create" class="nav-btn p-2 rounded-xl hover:bg-indigo-50 text-indigo-600 transition relative group active-tab">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <div class="absolute top-full mt-2 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap z-50 shadow-lg" data-i18n="tooltipNewComp">New Component</div>
            </button>
            <button onclick="switchTab('connect')" id="btn-tab-connect" class="nav-btn p-2 rounded-xl hover:bg-emerald-50 text-gray-400 hover:text-emerald-600 transition relative group">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                <div class="absolute top-full mt-2 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap z-50 shadow-lg" data-i18n="tooltipConnect">Connect</div>
            </button>
            <button onclick="switchTab('data')" id="btn-tab-data" class="nav-btn p-2 rounded-xl hover:bg-blue-50 text-gray-400 hover:text-blue-600 transition relative group">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>
                <div class="absolute top-full mt-2 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap z-50 shadow-lg" data-i18n="tooltipData">Data & Export</div>
            </button>
             <button onclick="switchTab('settings')" id="btn-tab-settings" class="nav-btn p-2 rounded-xl hover:bg-gray-100 text-gray-400 hover:text-gray-700 transition relative group">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <div class="absolute top-full mt-2 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap z-50 shadow-lg" data-i18n="tooltipSettings">Settings</div>
            </button>
        </div>

        <!-- Main Content (Forms) -->
        <div id="sidebar-content" class="flex-grow overflow-y-auto w-full transition-opacity duration-200 p-6 relative custom-scrollbar">
            
            <!-- Tab: Create -->
            <div id="tab-create" class="tab-content space-y-4 animation-fade-in text-left">
                <div class="flex items-center justify-between mb-2">
                     <h3 class="text-xs font-bold uppercase tracking-wider text-gray-400" data-i18n="createComp">Create Component</h3>
                </div>

                <!-- Create Component -->
                <div class="space-y-3">
                    <input type="text" id="node-title" class="w-full bg-gray-50 border border-gray-300 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 rounded-lg p-2 text-sm transition" placeholder="Title (Required)" data-i18n-placeholder="titleReq" data-i18n-title="enterCompId" title="Enter the component ID or Title">
                    <textarea id="node-description" class="w-full bg-gray-50 border border-gray-300 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 rounded-lg p-2 text-sm h-16 transition" placeholder="Description" data-i18n-placeholder="descPlaceholder" title="Enter a description for the component"></textarea>
                    
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-gray-600" data-i18n="boxColor">Box Color:</label>
                        <input type="color" id="node-color" class="flex-grow h-8 bg-gray-50 border border-gray-300 rounded-lg p-1 cursor-pointer transition" value="#6366F1">
                    </div>

                    <div id="prop-section" class="border border-gray-200 p-3 rounded-lg bg-gray-50">
                        <p class="text-xs font-semibold text-gray-600 mb-2" data-i18n="properties">Properties</p>
                        
                        <!-- JSON Import Section -->
                        <div class="mb-3">
                            <details class="text-[10px] text-gray-500">
                                <summary class="cursor-pointer hover:text-indigo-600 flex items-center gap-1 font-medium select-none" data-i18n="importPropsJson">
                                    <span>‚öôÔ∏è</span> Import Properties from JSON
                                </summary>
                                <div class="mt-2 p-2 bg-white border border-gray-200 rounded-lg shadow-sm">
                                    <textarea id="json-prop-input-sidebar" class="w-full h-16 text-[10px] font-mono p-2 bg-gray-50 border border-gray-200 rounded resize-none focus:border-indigo-500 outline-none" placeholder='e.g. { "field": "VARCHAR", "price": 100 }' data-i18n-placeholder="jsonPlaceholder"></textarea>
                                    <p class="text-[9px] text-gray-400 mt-1 mb-2" data-i18n="jsonLimitNote">Note: Max 20 properties will be imported.</p>
                                    <div class="flex gap-2 mt-2">
                                         <button onclick="parseJsonProps('json-prop-input-sidebar', 'prop-list', 'detect')" class="flex-1 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 text-[10px] font-bold py-1.5 rounded transition border border-indigo-200" title="Values like 10 become 'number'" data-i18n="detectTypes" data-i18n-title="jsonDetectTitle">
                                            Detect Types
                                        </button>
                                        <button onclick="parseJsonProps('json-prop-input-sidebar', 'prop-list', 'raw')" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-[10px] font-bold py-1.5 rounded transition border border-gray-300" title="Values like 'NVARCHAR' become type 'NVARCHAR'" data-i18n="useValues" data-i18n-title="jsonRawTitle">
                                            Use Values as Types
                                        </button>
                                    </div>
                                </div>
                            </details>
                        </div>

                        <div id="prop-list" class="space-y-2"></div>
                        <button id="add-prop-btn" onclick="addPropInput()" class="w-full mt-3 px-3 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 text-xs font-medium rounded-lg transition" data-i18n="addPropBtn">+ Add Property</button>
                    </div>

                    <button onclick="createNewComponent()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 rounded-xl shadow-lg shadow-emerald-200 dark:shadow-none transition transform hover:scale-[1.01]" data-i18n="createCompBtn">
                        Create Component Box
                    </button>
                    
                    <div class="mt-4 border-t border-gray-200 pt-4">
                        <label class="text-xs font-semibold text-gray-500 mb-2 block" data-i18n="bulkImportLabel">Bulk Import from JSON Files</label>
                        <div class="flex items-center gap-2">
                             <input type="file" id="bulk-comp-files" multiple accept=".json" class="hidden" onchange="processBulkComponentFiles(this)">
                             <button onclick="document.getElementById('bulk-comp-files').click()" class="w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-600 font-semibold py-2 rounded-xl border border-indigo-200 transition text-xs flex items-center justify-center gap-2" data-i18n="bulkImportBtn">
                                Select JSON Files
                             </button>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1" data-i18n="bulkImportNote">Filename = Component Name. Content = Properties.</p>
                    </div>
                </div>
            </div>

            <!-- Tab: Connect -->
            <div id="tab-connect" class="tab-content space-y-4 hidden animation-fade-in text-left">
                 <h3 class="text-xs font-bold uppercase tracking-wider text-gray-400" data-i18n="createDep">Connect Nodes</h3>
                 <div class="p-3 bg-emerald-50 rounded-lg border border-emerald-100 text-emerald-800 text-xs">
                    <strong data-i18n="tipPrefix">Tip:</strong> <span data-i18n="sidebarTip">You can also drag property dots on the graph to connect them visually!</span>
                 </div>
                 
                 <div class="space-y-4 mt-2">
                    <div>
                        <label class="text-xs font-semibold text-gray-600 mb-1 block" data-i18n="sourceComp">Source Component</label>
                        <select id="conn-source" onchange="updatePropSelects('source')" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 text-sm">
                            <option value="" data-i18n="selectSource">-- Select Source --</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="text-xs font-semibold text-gray-600 mb-1 block" data-i18n="sourcePropOpt">Source Property (Optional)</label>
                        <select id="conn-source-prop" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 text-xs" disabled>
                            <option value="" data-i18n="selectSourceProp">-- Select Source Prop --</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="text-xs font-semibold text-gray-600 mb-1 block" data-i18n="targetComp">Target Component</label>
                        <select id="conn-target" onchange="updatePropSelects('target')" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 text-sm">
                            <option value="" data-i18n="selectTarget">-- Select Target --</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="text-xs font-semibold text-gray-600 mb-1 block" data-i18n="targetPropOpt">Target Property (Optional)</label>
                        <select id="conn-target-prop" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 text-xs" disabled>
                            <option value="" data-i18n="selectTargetProp">-- Select Target Prop --</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="text-xs font-semibold text-gray-600 mb-1 block" data-i18n="connLabelOpt">Connection Label (Optional)</label>
                        <input type="text" id="conn-label" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 text-sm" placeholder="Label (e.g., imports)" data-i18n-placeholder="labelPlaceholder">
                    </div>
                    
                    <button onclick="createConnection()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 rounded-xl shadow-lg shadow-emerald-200 dark:shadow-none transition transform hover:scale-[1.01]" data-i18n="connectCompBtn">Connect Components</button>
                 </div>
            </div>

            <!-- Tab: Data -->
            <div id="tab-data" class="tab-content space-y-5 hidden animation-fade-in text-left">
                 <h3 class="text-xs font-bold uppercase tracking-wider text-gray-400" data-i18n="firebaseSync">Collab & Sync</h3>
                 
                 <!-- Firebase Sync Section -->
                 <div class="p-4 bg-white rounded-lg border border-indigo-200 shadow-sm space-y-3">
                     <div class="text-xs font-bold text-gray-700 flex justify-between items-center">
                         <span>Live Sync (Firebase)</span>
                         <span id="fb-status" class="w-2 h-2 rounded-full bg-gray-300" title="Disconnected"></span>
                     </div>
                     
                     <div id="fb-config-section">
                        <textarea id="fb-config-json" rows="3" placeholder='Paste Config JSON {"apiKey":...}' class="w-full text-[10px] p-2 border border-gray-200 rounded mb-2 font-mono scrollbar-hide"></textarea>
                        
                        <div class="flex items-center mb-2">
                            <input id="fb-remember" type="checkbox" class="w-3 h-3 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="fb-remember" class="ml-2 text-xs text-gray-600">Remember Connection</label>
                        </div>

                        <button onclick="initFirebase()" class="w-full py-1.5 text-xs bg-gray-900 text-white rounded font-medium hover:bg-gray-800 transition">Set Config & Init</button>
                     </div>
                     
                     <div id="fb-room-section" class="hidden">
                        <div class="flex justify-between items-end mb-1">
                             <label class="block text-[10px] text-gray-500">Room Name:</label>
                             <button onclick="disconnectAndReset()" class="text-[9px] text-red-500 hover:text-red-700 transition mb-0.5 font-bold underline">Disconnect / Change API Key</button>
                        </div>
                        <input id="fb-room-id" type="text" placeholder="Enter Room Name" class="w-full text-xs p-2 border border-gray-200 rounded mb-2 font-bold text-indigo-700">
                        <div class="flex gap-2">
                            <button id="btn-connect-room" onclick="connectToRoom()" class="flex-1 py-1.5 text-xs bg-indigo-600 text-white rounded font-medium hover:bg-indigo-700 transition shadow-sm" data-i18n="connectCreateBtn">Connect / Create</button>
                            <button onclick="shareRoomLink()" class="py-1 px-3 text-xs bg-emerald-50 text-emerald-600 border border-emerald-200 rounded hover:bg-emerald-100 transition" title="Copy Link" data-i18n-title="copyLinkTitle">üîó</button>
                            <button id="btn-drop-room" onclick="dropRoom()" class="hidden py-1 px-3 text-xs bg-red-50 text-red-600 border border-red-200 rounded hover:bg-red-100 transition items-center justify-center" title="Drop / Clear All Room Data (Dangerous)" data-i18n-title="dropRoomTitle">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                        </div>
                        <div id="active-users-list" class="flex flex-wrap gap-1 mt-2 min-h-[20px]"></div>
                     </div>
                 </div>

                 <div id="data-mgmt-wrapper" class="mb-2">
                     <details class="group bg-gray-50 border border-gray-200 rounded-lg open:shadow-sm transition-all duration-300">
                        <summary class="flex justify-between items-center font-semibold cursor-pointer list-none p-4 text-gray-600 hover:text-indigo-600 transition">
                            <span class="text-xs block flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>
                                <span data-i18n="backupRestore">Backup / Restore Options</span> 
                            </span>
                            <div class="flex items-center gap-2">
                                <span class="bg-indigo-100 text-indigo-600 text-[9px] px-1.5 py-0.5 rounded font-bold">DATA</span>
                                <span class="transition-transform duration-300 group-open:rotate-180">
                                    <svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="16"><path d="M6 9l6 6 6-6"></path></svg>
                                </span>
                            </div>
                        </summary>
                        <div class="px-4 pb-4 border-t border-gray-100 pt-3 grid grid-cols-1 gap-3">
                             <button onclick="openCSVModal()" class="w-full text-left p-3 text-xs font-medium text-gray-600 hover:bg-white hover:text-indigo-600 border border-transparent hover:border-indigo-100 hover:shadow-sm rounded transition flex items-center gap-3">
                                 <svg class="w-5 h-5 text-gray-400 group-hover:text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                 <div>
                                     <div class="font-bold" data-i18n="importExportCsv">Import / Export Excel (CSV)</div>
                                     <div class="text-[9px] text-gray-400 mt-0.5" data-i18n="bulkEdit">Bulk edit in Excel</div>
                                 </div>
                             </button>
                             
                             <button onclick="exportJSON()" class="w-full text-left p-3 text-xs font-medium text-gray-600 hover:bg-white hover:text-indigo-600 border border-transparent hover:border-indigo-100 hover:shadow-sm rounded transition flex items-center gap-3">
                                 <svg class="w-5 h-5 text-gray-400 group-hover:text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                                 <div>
                                     <div class="font-bold" data-i18n="backupJson">Backup JSON</div>
                                     <div class="text-[9px] text-gray-400 mt-0.5" data-i18n="saveAllData">Save all data</div>
                                 </div>
                             </button>
                             
                             <button onclick="document.getElementById('import-file').click()" class="w-full text-left p-3 text-xs font-medium text-gray-600 hover:bg-white hover:text-indigo-600 border border-transparent hover:border-indigo-100 hover:shadow-sm rounded transition flex items-center gap-3">
                                 <svg class="w-5 h-5 text-gray-400 group-hover:text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                 <div>
                                     <div class="font-bold" data-i18n="restoreJson">Restore JSON</div>
                                     <div class="text-[9px] text-gray-400 mt-0.5" data-i18n="loadBackup">Load backup</div>
                                 </div>
                             </button>
                             <input type="file" id="import-file" class="hidden" accept=".json" onchange="importJSON(this)">
                        </div>
                     </details>
                 </div>
                 
                 <button onclick="showHistoryModal()" class="w-full text-left p-4 text-xs font-medium text-indigo-600 hover:bg-indigo-50 rounded-lg transition flex items-center gap-3 border border-indigo-200 bg-white shadow-sm mb-2">
                     <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                     <div>
                         <div class="font-bold" data-i18n="history">Activity History</div>
                         <div class="text-[10px] text-gray-500 mt-0.5" data-i18n="viewChanges">View changes</div>
                     </div>
                 </button>

                 <button onclick="downloadImage()" class="w-full text-left p-4 text-xs font-medium text-indigo-600 hover:bg-indigo-50 rounded-lg transition flex items-center gap-3 border border-indigo-200 bg-white shadow-sm mb-4">
                     <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                     <div>
                         <span class="font-bold" data-i18n="downloadImage">Download Graph as Image</span>
                         <div class="text-[9px] text-gray-500 mt-0.5">PNG Format</div>
                     </div>
                 </button>
            </div>
            
            <!-- Tab: Settings -->
             <div id="tab-settings" class="tab-content space-y-5 hidden animation-fade-in text-left">
                 <h3 class="text-xs font-bold uppercase tracking-wider text-gray-400" data-i18n="generalSettings">Settings & Info</h3>
                 
                 <div class="space-y-3">
                     <button onclick="toggleTheme()" class="w-full text-left p-4 text-xs font-medium text-gray-600 hover:bg-gray-50 rounded-lg transition flex items-center gap-3 border border-gray-200">
                         <span id="theme-icon-sidebar" class="text-2xl">üåô</span>
                         <div>
                             <div class="font-bold" data-i18n="toggleTheme">Toggle Theme</div>
                             <div class="text-[10px] text-gray-500 mt-0.5" data-i18n="switchTheme">Switch between light/dark mode</div>
                         </div>
                     </button>
                     
                     <details class="group bg-gray-50 border border-gray-200 rounded-lg open:shadow-sm transition-all duration-300">
                        <summary class="flex justify-between items-center font-semibold cursor-pointer list-none p-4 text-gray-600 hover:text-indigo-600 transition">
                            <span class="text-xs block" data-i18n="userProfile">User Profile</span>
                            <span class="transition-transform duration-300 group-open:rotate-180">
                                <svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="16"><path d="M6 9l6 6 6-6"></path></svg>
                            </span>
                        </summary>
                        <div class="px-4 pb-4 border-t border-gray-100 pt-3 space-y-2">
                             <div>
                                 <label class="text-[10px] text-gray-500 uppercase font-bold" data-i18n="yourName">Your Name</label>
                                 <div class="flex gap-2">
                                     <input type="text" id="settings-username" class="w-full text-xs p-2 border border-gray-300 rounded focus:border-indigo-500 outline-none" placeholder="User Name">
                                     <button onclick="saveSettingsName()" class="bg-indigo-600 text-white text-xs px-3 py-2 rounded hover:bg-indigo-700 transition" data-i18n="save">Save</button>
                                 </div>
                             </div>
                             <div>
                                 <label class="text-[10px] text-gray-500 uppercase font-bold" data-i18n="yourColor">Your Color</label>
                                 <div class="flex gap-2 items-center">
                                     <input type="color" id="settings-usercolor" class="w-8 h-6 rounded border border-gray-300 cursor-pointer" onchange="saveSettingsColor(this.value)">
                                     <span class="text-[10px] text-gray-400" data-i18n="userColorDesc">Used for your cursor & history</span>
                                 </div>
                             </div>
                        </div>
                     </details>

                     <details class="group bg-gray-50 border border-gray-200 rounded-lg open:shadow-sm transition-all duration-300">
                        <summary class="flex justify-between items-center font-semibold cursor-pointer list-none p-4 text-gray-600 hover:text-indigo-600 transition">
                            <span class="text-xs block" data-i18n="defaultColors">Default Colors</span>
                            <span class="transition-transform duration-300 group-open:rotate-180">
                                <svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="16"><path d="M6 9l6 6 6-6"></path></svg>
                            </span>
                        </summary>
                        <div class="px-4 pb-4 border-t border-gray-100 pt-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs text-gray-500" data-i18n="defCompBg">Component Background</span>
                                <input type="color" id="pref-comp-bg" onchange="saveColorPref('comp-bg', this.value)" class="w-8 h-6 rounded cursor-pointer border border-gray-300">
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-500" data-i18n="defPropText">Property Color</span>
                                <input type="color" id="pref-prop-text" onchange="saveColorPref('prop-text', this.value)" class="w-8 h-6 rounded cursor-pointer border border-gray-300">
                            </div>
                        </div>
                     </details>
                     
                     <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                         <label class="text-xs font-semibold text-gray-600 mb-2 block" data-i18n="language">Language</label>
                         <select id="lang-select-sidebar" onchange="changeLanguage(this.value)" class="w-full text-xs bg-white border border-gray-200 rounded-lg p-2 text-gray-600 focus:outline-none focus:ring-1 focus:ring-indigo-500 cursor-pointer">
                            <option value="en">üá∫üá∏ English</option>
                            <option value="de">üá©üá™ Deutsch</option>
                            <option value="cs">üá®üáø ƒåe≈°tina</option>
                            <option value="fr">üá´üá∑ Fran√ßais</option>
                            <option value="uk">üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                            <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                         </select>
                     </div>

                     <!-- Danger Zone (Moved) -->
                     
                     <button onclick="openHelpModal()" class="w-full text-left p-4 text-xs font-medium text-indigo-600 hover:bg-indigo-50 rounded-lg transition flex items-center gap-3 border border-indigo-200">
                         <div>
                             <div class="font-bold" data-i18n="helpInstructions">Help & Instructions</div>
                             <div class="text-[10px] text-gray-500 mt-0.5" data-i18n="learnHow">Learn how to use</div>
                         </div>
                     </button>
                     
                     <button onclick="resetDashboard()" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg text-xs font-medium transition" data-i18n="resetDashboard">üóëÔ∏è Reset Dashboard</button>
                     
                     <!-- Danger Zone -->
                     <div class="mt-4 p-4 border border-red-200 rounded-lg bg-red-50">
                        <h4 class="text-[10px] font-bold text-red-600 mb-2 uppercase tracking-wider" data-i18n="dangerZone">Danger Zone</h4>
                        <button onclick="clearAllAppData()" class="w-full text-center py-2 text-xs font-bold text-white bg-red-600 hover:bg-red-700 rounded transition shadow-sm" data-i18n="clearAppData">
                            Clear All App Data & Reset
                        </button>
                        <p class="text-[9px] text-red-400 mt-2 text-center" data-i18n="clearAppDataDesc">Delete local storage, settings, and cache.</p>
                     </div>
                 </div>
             </div>
        
        </div>
        
        <!-- Sidebar Footer (Static) -->
        <div id="sidebar-footer" class="p-4 border-t border-gray-200 bg-gray-50 shrink-0 transition-all duration-300">
            <button id="contact-btn" onclick="openContactModal()" class="w-full mb-3 p-2 bg-white hover:bg-gray-100 rounded-lg transition flex items-center justify-center gap-2 border border-gray-200 shadow-sm relative overflow-hidden">
                <svg id="contact-icon" class="w-6 h-6 text-gray-600 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                <span id="contact-btn-text" class="text-xs font-medium text-gray-700 transition-opacity duration-300 whitespace-nowrap" data-i18n="contactUs">Contact Us</span>
            </button>
            <div id="footer-copyright-wrapper" class="relative">
                <p id="footer-copyright" class="text-[10px] text-center text-gray-400 whitespace-nowrap origin-center" data-i18n="copyright">Copyright ¬© 2026 | Developer: magas.sergio@gmail.com</p>
            </div>
        </div>

    </div>

    <!-- Main Diagram Area -->
    <div id="app" class="flex-grow flex flex-col p-8 min-h-screen relative transition-colors duration-300">
        <div class="flex justify-between items-center mb-4 gap-4">
             <div class="flex-grow min-w-0">
                <input type="text" id="main-graph-title" class="text-3xl font-bold text-gray-800 w-full  px-3 bg-transparent focus:outline-none focus:border-indigo-500 transition border-b border-transparent truncate" placeholder="Untitled Graph" data-i18n-placeholder="untitledGraph" oninput="syncGraphName(this.value)" onmouseover="this.title=this.value">
             </div>
             <!-- Header Controls (Theme, Lang, Global Lock) -->
             <div id="header-controls" class="flex items-stretch gap-2 shrink-0 h-8">
                <!-- Connection Status Badge -->
                <div id="connection-status-badge" onclick="switchTab('connect')" class="hidden md:flex items-center gap-1.5 px-2 rounded-lg bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-[10px] text-gray-500 dark:text-gray-400 font-medium transition select-none cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700">
                    <span id="conn-status-text" data-i18n="localMode">Local</span>
                </div>

                 <!-- Current User Badge (New) -->
                <div id="user-badge" class="group relative cursor-pointer px-2 flex items-center justify-center transition" onclick="switchTab('settings')" title="Your Profile (Click to Edit)">
                    <div id="user-badge-circle" class="w-6 h-6 rounded-full bg-gray-300 text-[10px] flex items-center justify-center text-white font-bold shadow-sm">
                        ?
                    </div>
                </div>

                <!-- Comments Toggle -->
                <button onclick="toggleCommentsWindow()" id="comments-toggle-btn" class="px-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400 transition flex items-center justify-center border border-transparent hover:border-gray-100 relative" title="Toggle Comments">
                     <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                     <span id="unread-comments-badge" class="hidden absolute -top-1 -right-1 flex h-2 w-2">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                     </span>
                </button>
                
                <!-- Global Lock Toggle -->
                <button onclick="toggleGlobalLock()" id="global-lock-btn" class="px-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400 transition flex items-center justify-center border border-transparent hover:border-gray-100" title="Lock All Components">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h1.9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10z"></path></svg>
                </button>
                <button onclick="toggleTheme()" class="px-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-200 transition flex items-center justify-center" title="Toggle Theme">
                    <span id="theme-icon">üåô</span>
                </button>
             </div>
        </div>
        <div id="diagram-container" class="flex-grow bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden relative">
            <!-- D3.js SVG will be appended here via JS -->
            
            <!-- Comment Overlay: Captures clicks in Comment Mode -->
            <!-- Using custom cursor directly in style here to be sure -->
            <div id="comment-overlay" onclick="handleCommentOverlayClick(event)" class="absolute inset-0 z-30 hidden" style="cursor: url('data:image/svg+xml;utf8,<svg width=\'32\' height=\'32\' viewBox=\'0 0 32 32\' fill=\'none\' xmlns=\'http://www.w3.org/2000/svg\'><path d=\'M28 20C28 21.1 27.1 22 26 22H10L4 26V6C4 4.9 4.9 4 6 4H26C27.1 4 28 4.9 28 6V20Z\' fill=\'%234F46E5\' stroke=\'white\' stroke-width=\'2\'/><path d=\'M16 10V16M13 13H19\' stroke=\'white\' stroke-width=\'2\' stroke-linecap=\'round\'/></svg>') 4 26, crosshair;"></div>
            
            <div id="drag-hint" class="absolute bottom-4 left-4 text-xs text-gray-400 p-2 pointer-events-none transition-opacity duration-300" data-i18n="dragHint">
                Drag nodes to move ‚Ä¢ Drag properties to connect ‚Ä¢ Click lines to edit
            </div>
        </div>

        <!-- Draggable FABs (Clean Layout) -->
        <div id="fab-container" class="z-40 pointer-events-none fixed inset-0 overflow-hidden">
             <!-- Help Button (Draggable) - BLACK -->
            <button id="fab-help" onclick="handleFabClick('help')" class="pointer-events-auto absolute bottom-40 right-8 bg-black hover:bg-gray-800 text-white w-12 h-12 rounded-full shadow-md transition-all active:scale-95 flex items-center justify-center select-none cursor-move" title="AI Help & FAQ" data-i18n-title="fabHelpTitle">
                 <span class="text-lg font-bold">?</span>
            </button>
            
            <!-- Add Button (Draggable) -->
            <!-- Components Button (Violet) -->
             <button id="fab-components" onclick="toggleComponentWindow()" class="pointer-events-auto absolute bottom-56 right-8 bg-violet-600 hover:bg-violet-700 text-white w-12 h-12 rounded-full shadow-md transition-all active:scale-95 flex items-center justify-center select-none cursor-move z-50" title="Show Components List">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>

            <!-- Add Button (Violet) -->
            <button id="fab-add" onclick="handleFabClick('add')" class="pointer-events-auto absolute bottom-24 right-8 bg-violet-600 hover:bg-violet-700 text-white w-12 h-12 rounded-full shadow-md transition-all active:scale-95 flex items-center justify-center select-none cursor-move" title="Quick Add Component" data-i18n-title="fabAddTitle">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            </button>
            
            <!-- Zoom Controls (Draggable Group) - Google Maps Style -->
            <div id="zoom-controls" class="pointer-events-auto absolute top-1/2 right-8 -translate-y-1/2 flex flex-col bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden cursor-move select-none transition-transform active:scale-95" title="Zoom Controls">
                <button onclick="zoomStep(1.2)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-50 text-gray-600 active:bg-gray-100 focus:outline-none border-b border-gray-100" title="Zoom In">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                </button>
                <button onclick="zoomStep(0.8)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-50 text-gray-600 active:bg-gray-100 focus:outline-none" title="Zoom Out">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Global SVG Overlay for Drag Lines (Z-Index above everything) -->
    <svg id="drag-overlay" class="fixed inset-0 pointer-events-none z-[100]" style="width:100%; height:100%; display:none;">
        <path id="drag-line" d="" stroke="#6366F1" stroke-width="2" fill="none" stroke-dasharray="5,5"></path>
    </svg>

    <!-- Component List Window (Draggable) -->
    <div id="component-window" class="fixed right-4 top-16 w-[450px] bg-white rounded-2xl shadow-2xl z-[60] flex flex-col border border-gray-200 transition-opacity duration-200 hidden max-h-[50vh]">
        
        <!-- Header (Draggable Handle) -->
        <div id="comp-window-header" class="p-3 bg-gray-50 border-b border-gray-100 flex justify-between items-center rounded-t-2xl cursor-move select-none">
             <div class="flex items-center gap-2">
                 <h3 class="text-xs font-bold uppercase tracking-wider text-gray-500" data-i18n="componentList">Components</h3>
                 <span id="comp-count" class="text-[10px] font-bold bg-white text-indigo-600 border border-indigo-100 px-2 py-0.5 rounded-full shadow-sm">0</span>
             </div>
             <div class="flex items-center gap-1">
                <button onclick="toggleCompWindowExpand()" id="btn-comp-expand" class="text-gray-400 hover:text-indigo-600 focus:outline-none p-1 rounded hover:bg-gray-200 transition-colors" title="Toggle Full Height">
                    <!-- Vertical Outward Arrows -->
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l-4-4m4 4l4-4"></path></svg>
                </button>
                <button onclick="toggleComponentWindow()" class="text-gray-400 hover:text-gray-600 focus:outline-none p-1 rounded hover:bg-gray-200 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
             </div>
        </div>
        
        <!-- Search Bar -->
        <div class="p-2 border-b border-gray-100 bg-white">
            <div class="relative">
                <input type="text" id="comp-search" class="w-full text-xs border border-gray-200 rounded-lg pl-8 pr-2 py-1.5 focus:outline-none focus:border-indigo-500 transition placeholder-gray-400" placeholder="Search..." data-i18n-placeholder="searchComponents">
                <svg class="w-3.5 h-3.5 text-gray-400 absolute left-2.5 top-2 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
        </div>

         <!-- Content -->
        <div id="component-list-container" class="relative overflow-y-auto p-2 space-y-2 bg-white custom-scrollbar flex-grow min-h-0">
            <svg id="list-connections-svg" class="absolute top-0 left-0 w-full h-full pointer-events-none z-0"></svg>
             <!-- List items injected here -->
        </div>
        
        <!-- Tips Section (Fixed at bottom of window) -->
        <div id="sidebar-tips" class="p-3 bg-indigo-50 border-t border-indigo-100 rounded-b-2xl shrink-0">
             <div class="flex justify-between items-center select-none mb-2 cursor-pointer hover:text-indigo-800 transition-colors" onclick="toggleTips()">
                 <span id="tips-header-text" class="text-xs font-bold text-indigo-700">Hide Quick Tips</span>
                 <svg id="tips-chevron" class="w-4 h-4 text-indigo-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
             </div>
             
             <div id="tips-wrapper" class="transition-all overflow-hidden duration-300">
                <div id="tips-content" class="text-[10px] text-gray-600 space-y-1">
                     <p>‚Ä¢ <strong>Connect:</strong> Drag dot to dot.</p>
                     <p>‚Ä¢ <strong>Edit:</strong> Click to item.</p>
                </div>
             </div>
        </div>
    </div>

    <!-- CSV Import/Export Modal -->
    <div id="csv-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl border border-gray-200 w-full max-w-2xl shadow-2xl p-6 flex flex-col max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-indigo-600" data-i18n="csvDataManager">CSV Data Manager</h2>
                <button onclick="closeModal('csv')" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>

            <!-- Export Section -->
            <div class="mb-8 p-4 bg-gray-50 rounded-xl border border-gray-200">
                <h3 class="font-bold text-gray-800 mb-2" data-i18n="exportSingle">1. Export to Single File</h3>
                <p class="text-xs text-gray-500 mb-4" data-i18n="exportSingleDesc">Download your entire graph (components & connections) in one CSV file.</p>
                <div class="flex gap-4">
                    <button onclick="downloadSingleCSV()" class="w-full bg-white border border-gray-300 hover:bg-indigo-50 text-indigo-600 font-bold py-3 rounded-lg transition shadow-sm flex justify-center items-center gap-2">
                        <span data-i18n="downloadCsv">Download Combined Data.csv</span>
                    </button>
                </div>
            </div>

            <!-- Import Section -->
            <div class="p-4 bg-emerald-50 rounded-xl border border-emerald-200">
                <h3 class="font-bold text-emerald-800 mb-2" data-i18n="importSingle">2. Import Single File</h3>
                <p class="text-xs text-emerald-700 mb-4" data-i18n="importSingleDesc">Upload a combined CSV file to update the graph. <br><strong>Note:</strong> Uploading will replace the current graph data.</p>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1" data-i18n="uploadFile">Upload Data File</label>
                        <input type="file" id="upload-single-csv" accept=".csv" class="block w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-emerald-100 file:text-emerald-700 hover:file:bg-emerald-200">
                    </div>
                    
                    <button onclick="processSingleCSVImport()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg transition shadow dark:shadow-none" data-i18n="processFile">
                        Process File & Update Graph
                    </button>
                </div>
            </div>
            
            <div class="mt-6 text-right">
                <button onclick="closeModal('csv')" class="text-gray-500 hover:text-gray-700 text-sm font-medium" data-i18n="close">Close</button>
            </div>
        </div>
    </div>

    <!-- Instructions / Help Accordion Modal -->
    <div id="help-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl border border-gray-200 w-full max-w-3xl shadow-2xl h-[85vh] flex flex-col overflow-hidden">
             <div class="bg-gray-100 p-6 flex justify-between items-center border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800">Help & Instructions</h2>
                <button onclick="closeModal('help')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="flex-grow overflow-y-auto p-6 space-y-4">
                
                <!-- AI Chatbot Section -->
                <div class="bg-gradient-to-br from-indigo-50 to-violet-50 p-5 rounded-xl border border-indigo-100 mb-6 shadow-sm">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="p-2 bg-indigo-600 rounded-lg text-white shadow-md">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-indigo-900 text-lg" data-i18n="aiHelpTitle">AI Assistant</h3>
                            <p class="text-xs text-indigo-600" data-i18n="aiHelpSubtitle">Ask me anything about this tool! (No API key required)</p>
                        </div>
                    </div>
                    
                    <div id="chat-history" class="h-48 bg-white rounded-lg border border-indigo-100 p-4 overflow-y-auto mb-3 text-sm space-y-3 shadow-inner scroll-smooth">
                        <div class="flex items-start gap-2.5">
                           <div class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center text-xs">ü§ñ</div>
                           <div class="bg-indigo-50 text-indigo-800 p-2 rounded-lg rounded-tl-none max-w-[85%] text-xs shadow-sm" data-i18n="aiWelcome">
                               Hello! I'm your offline assistant. Ask me how to add nodes, connect items, or export your graph.
                           </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 relative">
                        <input type="text" id="chat-input" class="flex-grow pl-4 pr-10 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm transition-all" placeholder="Type your question here..." data-i18n-placeholder="aiPlaceholder" onkeypress="if(event.key === 'Enter') sendChatMessage()">
                        <button onclick="sendChatMessage()" class="absolute right-2 top-1.5 bg-indigo-600 hover:bg-indigo-700 text-white p-1.5 rounded-lg shadow transition-colors" title="Send Message">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                        </button>
                    </div>
                </div>

                <div class="border-t border-gray-200 my-4"></div>
                <h3 class="font-bold text-gray-700 mb-2 px-1" data-i18n="detailedDocs">Detailed Documentation</h3>

                <!-- Accordion Item 1 -->
                <details class="group bg-white border border-gray-200 rounded-lg open:shadow-md transition-shadow">
                    <summary class="flex justify-between items-center font-medium cursor-pointer list-none p-4 hover:bg-gray-50 text-indigo-700 gap-3">
                        <div class="flex items-center gap-2">
                             <svg class="w-5 h-5 text-indigo-500" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 9h-2V7h-1v5H7v1h2v5h1v-5h2v-1z"/></svg>
                             <span data-i18n="helpCreateTitle">How to Create a Graph</span>
                        </div>
                        <span class="transition group-open:rotate-180">
                            <svg fill="none" height="24" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="24"><path d="M6 9l6 6 6-6"></path></svg>
                        </span>
                    </summary>
                    <div class="text-gray-600 text-sm p-4 border-t border-gray-100 bg-gray-50" data-i18n="helpCreateContent">
                        <ol class="list-decimal list-inside space-y-2">
                            <li><strong>Create Components:</strong> Use the sidebar form to add boxes.</li>
                            <li><strong>Add Properties:</strong> Components can have "properties".</li>
                            <li><strong>Connect:</strong> Drag properties or use the sidebar.</li>
                        </ol>
                    </div>
                </details>

                <!-- Accordion Item 2 -->
                <details class="group bg-white border border-gray-200 rounded-lg open:shadow-md transition-shadow">
                    <summary class="flex justify-between items-center font-medium cursor-pointer list-none p-4 hover:bg-gray-50 text-indigo-700 gap-3">
                         <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-500" fill="currentColor" viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"/></svg>
                            <span data-i18n="helpExportTitle">How to Export/Edit in Excel</span>
                        </div>
                        <span class="transition group-open:rotate-180">
                            <svg fill="none" height="24" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="24"><path d="M6 9l6 6 6-6"></path></svg>
                        </span>
                    </summary>
                    <div class="text-gray-600 text-sm p-4 border-t border-gray-100 bg-gray-50" data-i18n="helpExportContent">
                        <p class="mb-2">Manage data in bulk with CSV.</p>
                    </div>
                </details>

                 <!-- Accordion Item 3 -->
                <details class="group bg-white border border-gray-200 rounded-lg open:shadow-md transition-shadow">
                    <summary class="flex justify-between items-center font-medium cursor-pointer list-none p-4 hover:bg-gray-50 text-indigo-700 gap-3">
                        <div class="flex items-center gap-2">
                             <svg class="w-5 h-5 text-indigo-500" fill="currentColor" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                             <span data-i18n="helpImportTitle">How to Import CSV Data</span>
                        </div>
                        <span class="transition group-open:rotate-180">
                            <svg fill="none" height="24" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="24"><path d="M6 9l6 6 6-6"></path></svg>
                        </span>
                    </summary>
                    <div class="text-gray-600 text-sm p-4 border-t border-gray-100 bg-gray-50" data-i18n="helpImportContent">
                        <ol class="list-decimal list-inside space-y-2">
                            <li>Click Import/Export CSV.</li>
                        </ol>
                    </div>
                </details>
                
                 <!-- Accordion Item 6 (JSON Import Help) -->
                <details class="group bg-white border border-gray-200 rounded-lg open:shadow-md transition-shadow">
                    <summary class="flex justify-between items-center font-medium cursor-pointer list-none p-4 hover:bg-gray-50 text-indigo-700 gap-3">
                        <div class="flex items-center gap-2">
                             <svg class="w-5 h-5 text-indigo-500" fill="currentColor" viewBox="0 0 24 24"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>
                             <span data-i18n="helpJsonImportTitle">How to Import Properties (JSON)</span>
                        </div>
                        <span class="transition group-open:rotate-180">
                            <svg fill="none" height="24" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="24"><path d="M6 9l6 6 6-6"></path></svg>
                        </span>
                    </summary>
                    <div class="text-gray-600 text-sm p-4 border-t border-gray-100 bg-gray-50" data-i18n="helpJsonImportContent" id="help-json-content">
                         <!-- Content injected via i18n -->
                         <p>Use JSON to quickly add properties.</p>
                    </div>
                </details>

                <!-- Accordion Item 4 -->
                <details class="group bg-white border border-gray-200 rounded-lg open:shadow-md transition-shadow">
                    <summary class="flex justify-between items-center font-medium cursor-pointer list-none p-4 hover:bg-gray-50 text-indigo-700 gap-3">
                        <div class="flex items-center gap-2">
                             <svg class="w-5 h-5 text-indigo-500" fill="currentColor" viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                             <span data-i18n="helpBackupTitle"> Backup & Restore (JSON)</span>
                        </div>
                        <span class="transition group-open:rotate-180">
                            <svg fill="none" height="24" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="24"><path d="M6 9l6 6 6-6"></path></svg>
                        </span>
                    </summary>
                    <div class="text-gray-600 text-sm p-4 border-t border-gray-100 bg-gray-50" data-i18n="helpBackupContent">
                        <p class="mb-2">JSON Backup is safest.</p>
                    </div>
                </details>

                <!-- Accordion Item 7 (AI Help) -->
                <details class="group bg-white border border-gray-200 rounded-lg open:shadow-md transition-shadow">
                    <summary class="flex justify-between items-center font-medium cursor-pointer list-none p-4 hover:bg-gray-50 text-indigo-700 gap-3">
                        <div class="flex items-center gap-2">
                             <svg class="w-5 h-5 text-indigo-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2a10 10 0 0110 10c0 5.52-4.48 10-10 10S2 17.52 2 12 6.48 2 12 2zm1 4h-2v2h2V6zm-1 3c-2.67 0-4 1.33-4 4h2c0-1.33.67-2 2-2s2 .67 2 2c0 2-2 1.33-2 4h2c0-1.33.67-2 2-2z"/></svg>
                             <span data-i18n="helpAiTitle">How to use AI Assistant</span>
                        </div>
                        <span class="transition group-open:rotate-180">
                            <svg fill="none" height="24" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="24"><path d="M6 9l6 6 6-6"></path></svg>
                        </span>
                    </summary>
                    <div class="text-gray-600 text-sm p-4 border-t border-gray-100 bg-gray-50" data-i18n="helpAiContent">
                         <!-- Content injected via i18n -->
                    </div>
                </details>

                <!-- Accordion Item: Firebase Collaboration -->
                <details class="group bg-white border border-gray-200 rounded-lg open:shadow-md transition-shadow">
                    <summary class="flex justify-between items-center font-medium cursor-pointer list-none p-4 hover:bg-gray-50 text-indigo-700 gap-3">
                        <div class="flex items-center gap-2">
                             <svg class="w-5 h-5 text-indigo-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                             <span data-i18n="helpCollabTitle">Real-time Collaboration Guide</span>
                        </div>
                        <span class="transition group-open:rotate-180">
                            <svg fill="none" height="24" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="24"><path d="M6 9l6 6 6-6"></path></svg>
                        </span>
                    </summary>
                    <div class="text-gray-600 text-sm p-4 border-t border-gray-100 bg-gray-50" data-i18n="helpCollabContent">
                        <!-- Injected -->
                    </div>
                </details>

                 <!-- Accordion Item 5 -->
                <details class="group bg-white border border-gray-200 rounded-lg open:shadow-md transition-shadow">
                    <summary class="flex justify-between items-center font-medium cursor-pointer list-none p-4 hover:bg-gray-50 text-indigo-700 gap-3">
                         <div class="flex items-center gap-2">
                             <svg class="w-5 h-5 text-indigo-500" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                             <span data-i18n="helpCsvStructTitle">CSV Structure Guide</span>
                        <span class="transition group-open:rotate-180">
                            <svg fill="none" height="24" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="24"><path d="M6 9l6 6 6-6"></path></svg>
                        </span>
                    </summary>
                    <div class="text-gray-600 text-sm p-4 border-t border-gray-100 bg-gray-50 font-mono text-xs overflow-x-auto">
                        <p class="mb-2" data-i18n="csvStructIntro">The combined CSV uses a <strong>Superset of Columns</strong>. The first column <code>rowType</code> determines how the row is read.</p>
                        
                        <div class="mb-4">
                            <p class="font-sans font-bold text-indigo-600" data-i18n="csvStructCompTitle">If rowType = "component"</p>
                            <p class="text-gray-500" data-i18n="csvStructCompFields">Fill: id, title, description, color, x, y, docLink, props</p>
                            <p class="text-gray-400 italic" data-i18n="csvStructCompNote">Leave connection columns empty.</p>
                        </div>

                        <div class="mb-4">
                            <p class="font-sans font-bold text-emerald-600" data-i18n="csvStructConnTitle">If rowType = "connection"</p>
                            <p class="text-gray-500" data-i18n="csvStructConnFields">Fill: id, source, target, label, sourceProp, targetProp</p>
                            <p class="text-gray-400 italic" data-i18n="csvStructConnNote">Leave component columns empty.</p>
                        </div>
                        
                        <p class="mt-2 text-gray-500" data-i18n="csvStructPropsNote">* 'props' should be a JSON array string. Example: <code>"[{""name"":""id"",""type"":""uuid""}]"</code>.</p>
                    </div>
                </details>

            </div>
            
            <div class="bg-gray-50 p-4 border-t border-gray-200 text-right">
                <!-- Close Button Removed -->
            </div>
        </div>
    </div>


    <!-- Node Detail Modal -->
    <div id="node-detail-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl border border-gray-200 w-full max-w-lg shadow-2xl overflow-hidden flex flex-col max-h-[90vh] relative">
            <div class="p-6 border-b border-gray-100 flex-shrink-0 bg-white relative z-10">
                 <button onclick="closeModal('node')" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 text-2xl z-20">&times;</button>
                 <h2 class="text-2xl font-bold text-indigo-600" data-i18n="editCompDetails">Edit Component Details</h2>
            </div>
            
            <div class="p-6 overflow-y-auto flex-grow bg-gray-50/50 custom-scrollbar">
                
                <!-- General Section -->
                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm mb-4">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3" data-i18n="generalSettings">General Settings</h3>
                    
                    <div class="mb-3">
                        <label class="block text-xs font-semibold text-gray-500 mb-1" data-i18n="compTitle">Component Title</label>
                        <input type="text" id="modal-title" class="w-full bg-gray-50 p-2.5 rounded-lg text-gray-800 font-bold border border-gray-200 focus:border-indigo-500 focus:bg-white transition outline-none text-sm">
                        <p class="text-[10px] text-gray-400 mt-1 font-mono">ID: <span id="modal-id-span" class="select-all text-gray-500"></span></p>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1" data-i18n="bgColor">Background Color</label>
                            <input type="color" id="modal-color" class="w-full h-9 bg-white border border-gray-200 rounded-lg p-1 cursor-pointer">
                        </div>
                        <!-- Future: Icon selection or Shape selection -->
                    </div>
                
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1" data-i18n="description">Description</label>
                        <textarea id="modal-description" class="w-full bg-gray-50 p-3 rounded-lg h-20 text-sm border border-gray-200 focus:border-indigo-500 focus:bg-white transition outline-none resize-none placeholder-gray-400" placeholder="Type a description..."></textarea>
                    </div>
                </div>
                
                <!-- Properties Section -->
                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider" data-i18n="dataProps">Data Properties</h3>
                        <span class="text-[10px] text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full" data-i18n="inOut">Inputs / Outputs</span>
                    </div>
                    
                    <div id="modal-prop-section" class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                         <!-- JSON Import Modal Section -->
                        <div class="mb-3">
                            <details class="text-[10px] text-gray-500">
                                <summary class="cursor-pointer hover:text-indigo-600 flex items-center gap-1 font-medium select-none" data-i18n="importPropsJson">
                                    <span>‚öôÔ∏è</span> Import Properties from JSON
                                </summary>
                                <div class="mt-2 p-2 bg-white border border-gray-200 rounded-lg shadow-sm">
                                    <textarea id="json-prop-input-modal" class="w-full h-16 text-[10px] font-mono p-2 bg-gray-50 border border-gray-200 rounded resize-none focus:border-indigo-500 outline-none" placeholder='e.g. { "field": "VARCHAR", "price": 100 }' data-i18n-placeholder="jsonPlaceholder"></textarea>
                                    <p class="text-[9px] text-gray-400 mt-1 mb-2" data-i18n="jsonLimitNote">Note: Max 20 properties will be imported.</p>
                                    <div class="flex gap-2 mt-2">
                                         <button onclick="parseJsonProps('json-prop-input-modal', 'modal-prop-list', 'detect')" class="flex-1 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 text-[10px] font-bold py-1.5 rounded transition border border-indigo-200" data-i18n="detectTypes" title="Values like 10 become 'number'" data-i18n-title="jsonDetectTitle">
                                            Detect Types
                                        </button>
                                        <button onclick="parseJsonProps('json-prop-input-modal', 'modal-prop-list', 'raw')" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-[10px] font-bold py-1.5 rounded transition border border-gray-300" data-i18n="useValues" title="Values like 'NVARCHAR' become type 'NVARCHAR'" data-i18n-title="jsonRawTitle">
                                            Use Values as Types
                                        </button>
                                    </div>
                                </div>
                            </details>
                        </div>
                        
                        <div id="modal-prop-list" class="space-y-2 mb-3"></div>
                        <div class="flex gap-2">
                             <button onclick="addModalPropInput()" class="flex-grow px-3 py-2 bg-white hover:bg-gray-50 text-indigo-600 border border-dash border-gray-300 hover:border-indigo-300 text-xs font-medium rounded-lg transition border-dashed flex items-center justify-center gap-1" data-i18n="addPropBtn">
                                 + Add Property
                             </button>
                             <button onclick="saveModalProperties()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-medium rounded-lg transition shadow-sm dark:shadow-none flex items-center gap-1" data-i18n="saveProps">
                                Save Props
                             </button>
                        </div>
                    </div>
                </div>
                
                <!-- Connections Section -->
                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3" data-i18n="connections">Connections</h3>

                    <div class="bg-gray-50 rounded-lg p-2 mb-4 max-h-40 overflow-y-auto border border-gray-100 dark-scrollbar">
                        <div id="modal-connections-list" class="space-y-2 text-xs"></div>
                    </div>
                    
                    <div class="p-3 rounded-lg border border-blue-100">
                        <h4 class="text-xs font-bold text-blue-800 mb-2 flex items-center gap-1">
                            <span class="text-lg leading-none">+</span> <span data-i18n="addNewConn">Add New Connection</span>
                        </h4>
                        <div class="flex flex-col gap-3">
                            <div class="grid grid-cols-3 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-400 block mb-1" data-i18n="sourceProp">Source Prop</label>
                                    <select id="modal-new-conn-source-prop" class="w-full bg-white text-xs p-2 rounded border border-gray-200 outline-none focus:border-blue-400 transition">
                                        <option value="">(No Prop)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-400 block mb-1" data-i18n="targetNode">Target Node</label>
                                    <select id="modal-new-conn-target" onchange="updateModalTargetProps(this.value)" class="w-full bg-white text-xs p-2 rounded border border-gray-200 outline-none focus:border-blue-400 transition"></select>
                                </div>
                                 <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-400 block mb-1" data-i18n="targetProp">Target Prop</label>
                                    <select id="modal-new-conn-target-prop" class="w-full bg-white text-xs p-2 rounded border border-gray-200 outline-none focus:border-blue-400 transition" disabled>
                                        <option value="">(Select Target)</option>
                                    </select>
                                </div>
                            </div>
                            <button onclick="addConnectionFromModal()" class="bg-blue-600 text-white hover:bg-blue-700 px-3 py-2.5 rounded-lg text-xs font-bold transition w-full shadow-sm flex justify-center items-center gap-2" data-i18n="connectCompBtn">
                                Connect Components
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-100">
                    <button onclick="duplicateComponent(selectedNodeIdForModal); closeModal('node');" class="w-full bg-indigo-50 text-indigo-700 border border-indigo-200 hover:bg-indigo-100 px-4 py-3 rounded-xl text-xs font-bold transition flex items-center justify-center gap-2" data-i18n="duplicateComp">
                      Duplicate Component
                    </button>
                </div>
            </div>

            <div class="p-6 border-t border-gray-100 bg-white flex justify-between flex-shrink-0">
                <button onclick="deleteComponentConfirmed()" class="bg-red-50 text-red-600 hover:bg-red-100 px-4 py-2 rounded-lg font-medium transition text-sm" data-i18n="delete">Delete</button>
                <div class="space-x-3">
                    <button onclick="updateComponentDetails()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-medium transition text-sm shadow-md shadow-emerald-200 dark:shadow-none" data-i18n="saveChanges">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Add Component Modal -->
    <div id="quick-add-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl border border-gray-200 w-full max-w-lg shadow-2xl overflow-hidden flex flex-col max-h-[90vh] relative">
            <div class="p-6 border-b border-gray-100 flex-shrink-0 bg-white relative z-10">
                 <button onclick="closeModal('quickadd')" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 text-2xl z-20">&times;</button>
                 <h2 class="text-2xl font-bold text-indigo-600" data-i18n="quickAddComp">Quick Add Component</h2>
            </div>
            
            <div class="p-6 overflow-y-auto flex-grow bg-gray-50/50">
                <input type="text" id="quickadd-title" class="w-full bg-white p-3 rounded-lg mb-3 text-indigo-500 font-bold border border-gray-200" placeholder="Component Title" value="New Component" data-i18n-placeholder="compTitle">
                
                <label class="block text-xs font-semibold text-gray-500 mb-1" data-i18n="description">Description</label>
                <textarea id="quickadd-description" class="w-full bg-white p-3 rounded-lg mb-4 h-24 text-sm border border-gray-200" placeholder="Enter description..." data-i18n-placeholder="descPlaceholder"></textarea>
                
                <label class="block text-xs font-semibold text-gray-500 mb-1" data-i18n="boxColor">Color</label>
                <input type="color" id="quickadd-color" class="w-full h-10 bg-white border border-gray-200 rounded-lg p-1 cursor-pointer mb-4" value="#6366F1">
                
                <label class="block text-xs font-semibold text-gray-500 mb-1" data-i18n="properties">Properties</label>
                <div id="quickadd-prop-section" class="border border-gray-200 p-3 rounded-lg bg-gray-50 mb-4">
                    <!-- JSON Import Section -->
                    <div class="mb-3">
                        <details class="text-[10px] text-gray-500">
                            <summary class="cursor-pointer hover:text-indigo-600 flex items-center gap-1 font-medium select-none" data-i18n="importPropsJson">
                                <span>‚öôÔ∏è</span> Import Properties from JSON
                            </summary>
                            <div class="mt-2 p-2 bg-white border border-gray-200 rounded-lg shadow-sm">
                                <textarea id="json-prop-input-quickadd" class="w-full h-16 text-[10px] font-mono p-2 bg-gray-50 border border-gray-200 rounded resize-none focus:border-indigo-500 outline-none" placeholder='e.g. { "field": "VARCHAR", "price": 100 }' data-i18n-placeholder="jsonPlaceholder"></textarea>
                                <p class="text-[9px] text-gray-400 mt-1 mb-2" data-i18n="jsonLimitNote">Note: Max 20 properties will be imported.</p>
                                <div class="flex gap-2 mt-2">
                                     <button onclick="parseJsonProps('json-prop-input-quickadd', 'quickadd-prop-list', 'detect')" class="flex-1 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 text-[10px] font-bold py-1.5 rounded transition border border-indigo-200" data-i18n="detectTypes" title="Values like 10 become 'number'" data-i18n-title="jsonDetectTitle">
                                        Detect Types
                                    </button>
                                    <button onclick="parseJsonProps('json-prop-input-quickadd', 'quickadd-prop-list', 'raw')" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-[10px] font-bold py-1.5 rounded transition border border-gray-300" data-i18n="useValues" title="Values like 'NVARCHAR' become type 'NVARCHAR'" data-i18n-title="jsonRawTitle">
                                        Use Values as Types
                                    </button>
                                </div>
                            </div>
                        </details>
                    </div>

                    <div id="quickadd-prop-list" class="space-y-2"></div>
                    <button onclick="addQuickAddPropInput()" class="w-full mt-3 px-3 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 text-xs font-medium rounded-lg transition" data-i18n="addPropBtn">+ Add Property</button>
                </div>
            </div>

            <div class="p-6 border-t border-gray-100 bg-white flex justify-between flex-shrink-0">
                <button onclick="closeModal('quickadd')" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2 rounded-lg font-medium transition text-sm" data-i18n="cancel">Cancel</button>
                <div class="space-x-3">
                    <button onclick="saveQuickAddComponent()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-medium transition text-sm shadow-md shadow-emerald-200 dark:shadow-none" data-i18n="createCompBtn">Create Component</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Detail Modal -->
    <div id="connection-detail-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl border border-gray-200 w-full max-w-lg shadow-2xl overflow-hidden flex flex-col relative">
            <div class="p-6 border-b border-gray-100 flex-shrink-0 bg-white relative z-10">
                 <button onclick="closeModal('conn')" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 text-2xl z-20">&times;</button>
                 <h2 class="text-2xl font-bold text-emerald-600" data-i18n="editDep">Edit Dependency</h2>
            </div>
            
            <div class="p-6 overflow-y-auto flex-grow bg-gray-50/50">
                <p class="text-sm font-medium mb-4">
                    <span id="modal-conn-source-name" class="font-bold text-indigo-500"></span> 
                    <span class="text-gray-400" data-i18n="to">to</span> 
                    <span id="modal-conn-target-name" class="font-bold text-indigo-500"></span>
                </p>
                <p id="modal-conn-id" class="text-xs text-gray-500 mb-4 font-mono select-all">ID: </p>
                
                <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="connLabel">Connection Label</label>
                <input type="text" id="modal-conn-label" class="w-full bg-white p-3 rounded-lg mb-4 text-sm border border-gray-200 shadow-sm">

                <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="lblArrowColor">Arrow Color</label>
                <input type="color" id="modal-conn-color" class="w-full h-10 bg-white border border-gray-200 rounded-lg p-1 cursor-pointer mb-4">
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="lblType">Type</label>
                        <select id="modal-conn-type" class="w-full bg-white p-2.5 rounded-lg text-sm border border-gray-200 shadow-sm">
                            <option value="solid" data-i18n="optSolid">Solid</option>
                            <option value="dashed" data-i18n="optDashed">Dashed</option>
                            <option value="dotted" data-i18n="optDotted">Dotted</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="lblWidth">Width</label>
                        <input type="number" id="modal-conn-width" class="w-full bg-white p-2.5 rounded-lg text-sm border border-gray-200 shadow-sm" min="1" max="10" value="2">
                    </div>
                </div>

                <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="sourceProp">Source Property</label>
                <select id="modal-conn-source-prop" class="w-full bg-white p-3 rounded-lg mb-4 text-sm border border-gray-200 shadow-sm"></select>

                <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="targetProp">Target Property</label>
                <select id="modal-conn-target-prop" class="w-full bg-white p-3 rounded-lg mb-2 text-sm border border-gray-200 shadow-sm"></select>
            </div>

            <div class="p-6 border-t border-gray-100 bg-white flex justify-between flex-shrink-0">
                <button onclick="deleteConnectionConfirmed()" class="bg-red-50 text-red-600 hover:bg-red-100 px-4 py-2 rounded-lg font-medium transition text-sm" data-i18n="delete">Delete</button>
                <div class="space-x-3">
                    <button onclick="updateConnectionDetails()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-medium transition text-sm shadow-md shadow-emerald-200 dark:shadow-none" data-i18n="saveChanges">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Reset Confirmation Modal -->
    <div id="reset-confirmation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl border border-gray-200 w-full max-w-lg shadow-2xl overflow-hidden flex flex-col relative">
            <div class="p-6 border-b border-gray-100 flex-shrink-0 bg-white relative z-10">
                <button onclick="closeModal('reset')" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 text-2xl z-20">&times;</button>
                <h2 class="text-2xl font-bold text-red-600" data-i18n="confirmReset">Confirm Dashboard Reset</h2>
            </div>
            
            <div class="p-8">
                <p class="text-gray-700 mb-6">
                    <span data-i18n="resetMsg">Are you absolutely sure you want to clear the entire dashboard?</span>
                    <br><br>
                    <strong class="font-bold text-red-700" data-i18n="warning">Warning:</strong> <span data-i18n="resetWarningBody">All local data will be lost unless you have exported a backup JSON file.</span>
                </p>
                
                <div class="flex justify-between">
                    <button onclick="closeModal('reset')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-medium transition" data-i18n="cancel">Cancel</button>
                    <button id="btn-reset-confirm" onclick="resetDashboardConfirmed()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition" data-i18n="yesReset">Yes, Clear Dashboard</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Clear App Data Confirmation Modal (Custom) -->
    <div id="clear-data-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl border border-gray-200 w-full max-w-lg shadow-2xl overflow-hidden flex flex-col relative">
            <div class="p-6 border-b border-gray-100 flex-shrink-0 bg-white relative z-10">
                <button onclick="closeModal('clearData')" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 text-2xl z-20">&times;</button>
                <h2 class="text-2xl font-bold text-red-600" data-i18n="resetAppTitle">Reset Application</h2>
            </div>
            
            <div class="p-8">
                <p class="text-gray-700 mb-6">
                    <span data-i18n="clearDataDesc">This will delete all local data, including settings, cached graphs, and user preferences.</span>
                    <br><br>
                    <strong class="font-bold text-red-700" data-i18n="warning">Warning:</strong> <span data-i18n="clearDataWarning">This action cannot be undone.</span>
                </p>
                
                <div class="flex justify-between">
                    <button onclick="closeModal('clearData')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-medium transition" data-i18n="cancel">Cancel</button>
                    <button onclick="confirmClearAppData()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition" data-i18n="yesClearData">Yes, Clear Everything</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Conversation Confirmation Modal (Custom) -->
    <div id="delete-comment-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl border border-gray-200 w-full max-w-lg shadow-2xl overflow-hidden flex flex-col relative">
            <div class="p-6 border-b border-gray-100 flex-shrink-0 bg-white relative z-10">
                <button onclick="closeModal('deleteComment')" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 text-2xl z-20">&times;</button>
                <h2 class="text-2xl font-bold text-red-600" data-i18n="deleteCommentTitle">Delete Conversation</h2>
            </div>
            
            <div class="p-8">
                <p class="text-gray-700 mb-6">
                    <span data-i18n="deleteCommentDesc">Are you sure you want to delete this entire conversation thread?</span>
                    <br><br>
                    <strong class="font-bold text-red-700" data-i18n="warning">Warning:</strong> <span data-i18n="clearDataWarning">This action cannot be undone.</span>
                </p>
                
                <div class="flex justify-between">
                    <button onclick="closeModal('deleteComment')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-medium transition" data-i18n="cancel">Cancel</button>
                    <button onclick="confirmDeleteComment()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition" data-i18n="yesDelete">Yes, Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Item Confirmation Modal -->
    <div id="delete-item-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl border border-gray-200 w-full max-w-lg shadow-2xl overflow-hidden flex flex-col relative">
            <div class="p-6 border-b border-gray-100 flex-shrink-0 bg-white relative z-10">
                <button onclick="closeModal('deleteItem')" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 text-2xl z-20">&times;</button>
                <h2 class="text-2xl font-bold text-gray-800" data-i18n="deleteCompConfirmTitle">Delete Component?</h2>
            </div>

            <div class="p-8">
                <p class="text-gray-700 mb-6">
                    <span data-i18n="deleteCompConfirmDesc">This will delete the component and all connections.</span>
                    <br>
                    <strong id="delete-item-name" class="block mt-2 text-indigo-600 font-mono text-sm break-all"></strong>
                </p>
                
                <div class="flex justify-between">
                    <button onclick="closeModal('deleteItem')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-medium transition" data-i18n="cancel">Cancel</button>
                    <button onclick="deleteFromListConfirmed()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition" data-i18n="delete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Drop Room Confirmation Modal -->
    <div id="drop-room-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl border border-gray-200 w-full max-w-lg shadow-2xl overflow-hidden flex flex-col relative">
            <div class="p-6 border-b border-gray-100 flex-shrink-0 bg-white relative z-10">
                <button onclick="closeModal('dropRoom')" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 text-2xl z-20">&times;</button>
                <h2 class="text-2xl font-bold text-red-600" data-i18n="dropRoomTitle">Drop Room Data?</h2>
            </div>
            
            <div class="p-8">
                <p class="text-gray-700 mb-6">
                    <span data-i18n="dropRoomConfirm">Are you sure? This will delete all data in the room for all users.</span>
                </p>
                
                <div class="flex justify-between">
                    <button onclick="closeModal('dropRoom')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-medium transition" data-i18n="cancel">Cancel</button>
                    <button onclick="confirmDropRoom()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        <span data-i18n="delete">Delete</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl border border-gray-200 w-full max-w-2xl shadow-2xl h-[80vh] flex flex-col overflow-hidden relative">
            <div class="p-6 border-b border-gray-100 flex-shrink-0 bg-white relative z-10">
                <button onclick="closeModal('history')" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 text-2xl z-20">&times;</button>
                <h2 class="text-2xl font-bold text-gray-800" data-i18n="history">Activity History</h2>
            </div>
            
            <div class="flex-grow overflow-y-auto p-6 bg-gray-50/50">
                <div id="history-list" class="space-y-2">
                    <!-- History Items Injected Here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contact Modal -->
    <div id="contact-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl border border-gray-200 w-full max-w-md shadow-2xl overflow-hidden flex flex-col relative">
            <div class="p-6 border-b border-gray-100 flex-shrink-0 bg-white relative z-10">
                <button onclick="closeModal('contact')" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 text-2xl z-20">&times;</button>
                <h2 class="text-2xl font-bold text-indigo-600" data-i18n="contactUs">Contact Us</h2>
            </div>
            
            <div class="p-6 space-y-4 bg-gray-50/50">
                 <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1" data-i18n="email">Email</label>
                    <input type="email" id="contact-email" class="w-full bg-white border border-gray-300 rounded-lg p-2 text-sm focus:border-indigo-500 transition" placeholder="your@email.com" data-i18n-placeholder="contactEmailPlaceholder">
                 </div>
                 <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1" data-i18n="message">Message</label>
                    <textarea id="contact-msg" class="w-full bg-white border border-gray-300 rounded-lg p-2 text-sm h-32 focus:border-indigo-500 transition" placeholder="How can we help?" data-i18n-placeholder="contactMsgPlaceholder"></textarea>
                 </div>
                 <button onclick="sendContactMessage()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg shadow-lg dark:shadow-none transition transform hover:scale-[1.01]" data-i18n="sendMessage">
                    Send Message
                 </button>
            </div>
        </div>
    </div>


    <!-- Custom Tooltip Container -->
    <div id="custom-tooltip"></div>
    
    <!-- Firebase SDK (Version 8 compat for simpler CDN usage) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- Internationalization (i18n) ---
        let currentLang = localStorage.getItem('app_lang') || 'en';

        const translations = {
            en: {
                graphManager: "Graph Manager",
                systemReady: "System Ready",
                graphNameLabel: "Graph Name",
                untitledGraph: "Untitled Graph",
                createComp: "Create New Component",
                titleReq: "Title (Required)",
                enterCompId: "Enter the component ID or Title",
                descPlaceholder: "Description",
                boxColor: "Box Color:",
                properties: "Properties",
                importPropsJson: "‚öôÔ∏è Import Properties from JSON",
                jsonLimitNote: "Note: Max 20 properties will be imported.",
                detectTypes: "Detect Types",
                useValues: "Use Values as Types",
                saveProps: "Save Props",
                addPropBtn: "+ Add Property",
                createCompBtn: "Create Component Box",
                createDep: "Connect Nodes",
                tipPrefix: "Tip:",
                sidebarTip: "You can also drag property dots on the graph to connect them visually!",
                selectSource: "-- Select Source --",
                selectSourceProp: "-- Select Source Prop --",
                selectTarget: "-- Select Target --",
                selectTargetProp: "-- Select Target Prop --",
                labelPlaceholder: "Label (e.g., imports)",
                connectCompBtn: "Connect Components",
                dataExport: "Data Management",
                importExportCsv: "Import / Export Excel (CSV)",
                backupJson: "Backup JSON",
                restoreJson: "Restore JSON",
                history: "Activity History",
                downloadImage: "Download Graph as Image",
                resetDashboard: "Reset Dashboard",
                dragHint: "Drag nodes to move ‚Ä¢ Drag properties to connect ‚Ä¢ Click lines to edit",
                fabHelpTitle: "AI Help & FAQ",
                fabAddTitle: "Quick Add Component",
                aiWelcome: "Hello! Ask me how to add nodes, connect items, or export your graph.",
                aiPlaceholder: "Type your question here (e.g., 'how to connect nodes?')...",
                contactUs: "Contact Us",
                email: "Email",
                message: "Message",
                sendMessage: "Send Message",
                copyright: "Copyright ¬© 2026 | Developer: magas.sergio@gmail.com",
                msgSent: "Message sent! We'll get back to you shortly.",
                sourceComp: "Source Component",
                sourcePropOpt: "Source Property (Optional)",
                targetComp: "Target Component",
                targetPropOpt: "Target Property (Optional)",
                connLabelOpt: "Connection Label (Optional)",
                generalSettings: "General Settings",
                compTitle: "Component Title",
                bgColor: "Background Color",
                description: "Description",
                dataProps: "Data Properties",
                inOut: "Inputs / Outputs",
                connections: "Connections",
                addNewConn: "Add New Connection",
                sourceProp: "Source Prop",
                targetNode: "Target Node",
                targetProp: "Target Prop",
                duplicateComp: "Duplicate Component",
                delete: "Delete",
                saveChanges: "Save Changes",
                cancel: "Cancel",
                resetAppTitle: "Reset Application",
                clearDataDesc: "This will delete all local data, including settings, cached graphs, and user preferences.",
                clearDataWarning: "This action cannot be undone.",
                yesClearData: "Yes, Clear Everything",
                localMode: "Local Mode",
                liveMode: "Live Sync",
                host: "Host",
                quickAddComp: "Quick Add Component",
                editDep: "Edit Dependency",
                to: "to",
                connLabel: "Connection Label",
                confirmReset: "Confirm Dashboard Reset",
                resetMsg: "Are you absolutely sure you want to clear the entire dashboard?",
                warning: "Warning:",
                resetWarningBody: "All local data will be lost unless you have exported a backup JSON file.",
                yesReset: "Yes, Clear Dashboard",
                helpInstructions: "Help & Instructions",
                learnHow: "Learn how to use",
                toggleTheme: "Toggle Theme",
                switchTheme: "Switch between light/dark mode",
                language: "Language",
                viewChanges: "View changes",
                loadBackup: "Load backup",
                saveAllData: "Save all data",
                bulkEdit: "Bulk edit in Excel",
                uploadFile: "Upload Data File",
                processFile: "Process File & Update Graph",
                close: "Close",
                exportSingle: "1. Export to Single File",
                exportSingleDesc: "Download your entire graph (components & connections) in one CSV file.",
                downloadCsv: "Download Combined Data.csv",
                importSingle: "2. Import Single File",
                importSingleDesc: "Upload a combined CSV file to update the graph. <br><strong>Note:</strong> Uploading will replace the current graph data.",
                csvDataManager: "CSV Data Manager",
                aiHelpTitle: "AI Assistant",
                aiHelpSubtitle: "Ask me anything about this tool! (No API key required)",
                detailedDocs: "Detailed Documentation",
                helpCreateTitle: "How to Create a Graph",
                helpExportTitle: "How to Export/Edit in Excel",
                helpImportTitle: "How to Import CSV Data",
                helpBackupTitle: " Backup & Restore (JSON)",
                helpCsvStructTitle: "CSV Structure Guide",
                helpCreateContent: `<ol class="list-decimal list-inside space-y-2"><li><strong>Create Components:</strong> Use the sidebar form to add boxes (components).</li><li><strong>Add Properties:</strong> Components can have "properties".</li><li><strong>Connect:</strong> Drag properties or use the sidebar.</li></ol>`,
                helpExportContent: `<p class="mb-2">Manage data in bulk with CSV.</p><ol class="list-decimal list-inside space-y-2"><li>Click Import/Export.</li><li>Download CSV.</li><li>Edit in Excel.</li><li>Upload.</li></ol>`,
                helpImportContent: `<ol class="list-decimal list-inside space-y-2"><li>Click Import / Export CSV.</li><li>Select file.</li><li>Process.</li></ol>`,
                helpBackupContent: `<p class="mb-2">Save your progress locally.</p><ol class="list-decimal list-inside space-y-2"><li><strong>Backup:</strong> Downloads a .json file with all nodes and connections.</li><li><strong>Restore:</strong> Uploads a .json file. <br><em class="text-red-500">(Warning: Overwrites current dashboard)</em>.</li></ol>`,
                helpAiTitle: "How to use AI Assistant",
                helpAiContent: `<p class="mb-2">The AI Assistant is an offline tool designed to help you navigate the application.</p><ul class="list-disc list-inside space-y-1"><li>Ask how to connect nodes.</li><li>Ask about CSV formats or JSON imports.</li><li>No internet required (runs locally).</li></ul>`,
                helpJsonImportTitle: "How to Import Properties (JSON)",
                helpJsonImportContent: `<p class="mb-2">You can quickly add properties using a JSON object.</p><ol class="list-decimal list-inside space-y-2"><li>Prepare a JSON object (e.g., <code>{"age": "number", "name": "string"}</code>).</li><li>Paste it into the JSON input field.</li><li>Click <strong>Detect Types</strong> or <strong>Use Values</strong>.</li></ol>`,
                // JS Messages
                msgDepDeleted: "Dependency deleted.",
                msgDepDeleteErr: "Failed to delete dependency.",
                msgInvalidJson: "Invalid format. Please paste a JSON object.",
                msgJsonLimit: "Notice: JSON contains properties. Maximum allowed is 20. Truncating...",
                msgJsonSuccess: "Generated properties from JSON",
                msgJsonErr: "JSON Parse Error: Check syntax.",
                msgNoConn: "No connections.",
                msgBtnEdit: "Edit",
                optConnectTo: "-- Connect to --",
                optNoProp: "(No Prop / Entire Component)",
                msgSelectTarget: "Please select a target component.",
                msgSelfConnect: "Cannot connect component to itself.",
                msgConnCreated: "Connection created successfully!",
                msgConnSaveErr: "Failed to save connection.",
                msgFillFields: "Please fill in all fields",
                msgValidEmail: "Please enter a valid email address",
                componentList: "Components",
                bulkImportLabel: "Bulk Import from JSON Files",
                bulkImportBtn: "Select JSON Files",
                bulkImportNote: "Filename = Component Name. Content = Properties.",
                tooltipNewComp: "New Component",
                tooltipConnect: "Connect",
                tooltipData: "Data & Export",
                tooltipSettings: "Settings",
                jsonPlaceholder: 'e.g. { "field": "VARCHAR", "price": 100 }',
                jsonDetectTitle: "Values like 10 become 'number'",
                jsonRawTitle: "Values like 'NVARCHAR' become type 'NVARCHAR'",
                csvStructIntro: "The combined CSV uses a <strong>Superset of Columns</strong>. The first column <code>rowType</code> determines how the row is read.",
                csvStructCompTitle: "If rowType = \"component\"",
                csvStructCompFields: "Fill: id, title, description, color, x, y, docLink, props",
                csvStructCompNote: "Leave connection columns empty.",
                csvStructConnTitle: "If rowType = \"connection\"",
                csvStructConnFields: "Fill: id, source, target, label, sourceProp, targetProp",
                csvStructConnNote: "Leave component columns empty.",
                csvStructPropsNote: "* 'props' should be a JSON array string. Example: <code>\"[{\"\"name\"\":\"\"id\"\",\"\"type\"\":\"\"uuid\"\"}]\"</code>.",
                idLabel: "ID: ",
                contactEmailPlaceholder: "your@email.com",
                contactMsgPlaceholder: "How can we help?",
                optSelectPropAny: "-- Select Property (Any) --",
                defaultColors: "Default Colors",
                defCompBg: "Component Background",
                defPropText: "Property Color",
                lblArrowColor: "Arrow Color",
                lblType: "Type",
                lblWidth: "Width",
                optSolid: "Solid",
                optDashed: "Dashed",
                optDotted: "Dotted",
                deleteCompConfirmTitle: "Delete Component?",
                deleteCompConfirmDesc: "This will remove the component and all connected arrows.",
                noComponentsFound: "No components found",
                hideTips: "Hide Quick Tips",
                showTips: "Show Quick Tips",
                backupRestore: "Backup / Restore Options",
                deleteCommentTitle: "Delete Conversation",
                deleteCommentDesc: "Are you sure you want to delete this entire conversation thread?",
                yesDelete: "Yes, Delete",
                dbConnectFail: "Database connection failed.",
                helpCollabTitle: "Real-time Collaboration Guide",
                helpCollabContent: `
                        <p class="mb-2 font-bold">How to connect with others:</p>
                        <div class="mb-3 p-2 bg-blue-50 border border-blue-200 rounded text-xs text-blue-800">
                             <strong>New: Chat & Comments</strong><br/>
                             <ul>
                                <li>‚Ä¢ <strong>Global Chat:</strong> Talk with everyone in the room using the chat icon in the bottom right.</li>
                                <li>‚Ä¢ <strong>Node Comments:</strong> Select a node and click the message icon to leave specific comments.</li>
                             </ul>
                        </div>
                        <ol class="list-decimal list-inside space-y-2 mb-3">
                            <li class="mb-1">
                                <strong>Setup Project:</strong><br/>
                                <span class="text-xs text-gray-500 ml-4 block">
                                    1. Go to <a href="https://console.firebase.google.com" target="_blank" class="text-blue-500 hover:underline">console.firebase.google.com</a>.<br/>
                                    2. Click "Add Project" & follow prompts.<br/>
                                    3. **IMPORTANT:** Go to **Build > Realtime Database > Create Database**. (Start in test mode).<br/>
                                    4. On Project Overview (top left "Home" icon), look for the text "Get started by adding Firebase to your app".<br/>
                                    5. Click the circular **&lt;/&gt;** icon (Web).<br/>
                                    6. Register app (name it anything).<br/>
                                    7. Select **Use a &lt;script&gt; tag**.
                                </span>
                            </li>
                            <li>
                                <strong>Get Config:</strong><br/>
                                <span class="text-xs text-gray-500 ml-4 block">
                                    Copy <strong>only</strong> the <code>firebaseConfig</code> object shown between script tags.<br/>
                                    <div class="bg-gray-100 p-2 rounded mt-1 mb-1 font-mono text-[10px] whitespace-pre overflow-x-auto border border-gray-200 text-gray-700">
{
  apiKey: "AIzaSy...",
  authDomain: "project.firebaseapp.com",
  databaseURL: "https://project.firebaseio.com",
  projectId: "project",
  storageBucket: "project.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:1234:web:abcd"
}</div>
                                    <em>If you miss it:</em> Project Settings &rarr; General &rarr; "Your apps" &rarr; "SDK setup" &rarr; Select "Config".
                                    <span class="text-[10px] text-red-400 block italic mt-1">* Note: Google updates this UI frequently.</span>
                                </span>
                            </li>
                            <li>Go to the <strong>Data Tab</strong> in the sidebar.</li>
                            <li>Paste the config code.</li>
                            <li>Click <strong>Set Config</strong>. Enter <strong>ANY Name</strong> (e.g. "my-project") to create or join a room.</li>
                        </ol>`,
                
                // New Keys
                dangerZone: "Danger Zone",
                clearAppData: "Clear All App Data & Reset",
                clearAppDataDesc: "Delete local storage, settings, and cache.",
                userProfile: "User Profile",
                yourName: "Your Name",
                save: "Save",
                yourColor: "Your Color",
                userColorDesc: "Used for your cursor & history",
                dropRoomTitle: "Drop / Clear All Room Data (Dangerous)",
                copyLinkTitle: "Copy Link",
                connectCreateBtn: "Connect / Create",
                defaultColors: "Default Colors",
                defCompBg: "Component Background"
            },
            de: {
                dangerZone: "Gefahrenzone",
                clearAppData: "Alle App-Daten l√∂schen & zur√ºcksetzen",
                clearAppDataDesc: "Lokalen Speicher, Einstellungen und Cache l√∂schen.",
                userProfile: "Benutzerprofil",
                yourName: "Ihr Name",
                save: "Speichern",
                yourColor: "Ihre Farbe",
                dropRoomTitle: "Raum l√∂schen (Host)",
                dropRoomConfirm: "Sind Sie sicher? Dies l√∂scht alle Daten im Raum f√ºr alle Benutzer.",
                connectCreateBtn: "Neuen Raum erstellen",
                connectJoinBtn: "Raum beitreten",
                connectHost: "Firebase Datenbank URL",
                resetAppTitle: "Anwendung zur√ºcksetzen",
                clearDataDesc: "Dadurch werden alle lokalen Daten gel√∂scht, einschlie√ülich Einstellungen, zwischengespeicherten Graphen und Benutzereinstellungen.",
                clearDataWarning: "Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.",
                yesClearData: "Ja, alles l√∂schen",
                localMode: "Lokaler Modus",
                liveMode: "Live-Sync",
                host: "Host",
                connectHostPlaceholder: "https://your-project.firebaseio.com",
                connectApiKey: "API Schl√ºssel",
                connectApiKeyPlaceholder: "API Schl√ºssel einf√ºgen",
                enterRoomId: "Raum ID eingeben...",
                graphManager: "Graph-Manager",
                systemReady: "System Bereit",
                graphNameLabel: "Diagramm Name",
                untitledGraph: "Unbenanntes Diagramm",
                createComp: "Neue Komponente",
                titleReq: "Titel (Erforderlich)",
                enterCompId: "Geben Sie die Komponenten-ID ein",
                descPlaceholder: "Beschreibung",
                boxColor: "Box Farbe:",
                properties: "Eigenschaften",
                importPropsJson: "‚öôÔ∏è Eigenschaften aus JSON importieren",
                jsonLimitNote: "Hinweis: Max. 20 Eigenschaften werden importiert.",
                detectTypes: "Typen erkennen",
                useValues: "Werte als Typen",
                saveProps: "Eigenschaften speichern",
                addPropBtn: "+ Eigenschaft Hinzuf√ºgen",
                createCompBtn: "Komponenten-Box Erstellen",
                createDep: "Abh√§ngigkeit Erstellen",
                tipPrefix: "Tipp:",
                sidebarTip: "Sie k√∂nnen auch Eigenschaftspunkte ziehen, um sie visuell zu verbinden!",
                selectSource: "-- Quelle W√§hlen --",
                selectSourceProp: "-- Quell-Eigenschaft --",
                selectTarget: "-- Ziel W√§hlen --",
                selectTargetProp: "-- Ziel-Eigenschaft --",
                labelPlaceholder: "Beschriftung (z.B. importiert)",
                connectCompBtn: "Komponenten Verbinden",
                dataExport: "Daten & Export",
                importExportCsv: "Import / Export Excel (CSV)",
                backupJson: "Backup JSON",
                restoreJson: "Wiederherstellen JSON",
                history: "Verlauf",
                downloadImage: "Bild Herunterladen",
                resetDashboard: "Dashboard Zur√ºcksetzen",
                dragHint: "Knoten ziehen zum Bewegen ‚Ä¢ Eigenschaften ziehen zum Verbinden",
                fabHelpTitle: "KI Hilfe & FAQ",
                fabAddTitle: "Schnell Hinzuf√ºgen",
                aiWelcome: "Hallo! Fragen Sie mich, wie man Knoten hinzuf√ºgt oder verbindet.",
                aiPlaceholder: "Geben Sie Ihre Frage ein (z.B. 'wie verbinde ich?')...",
                contactUs: "Kontaktiere uns",
                email: "Email",
                message: "Nachricht",
                sendMessage: "Nachricht Senden",
                copyright: "Urheberrecht ¬© 2026 ‚Ä¢ Entwickler: magas.sergio@gmail.com",
                msgSent: "Nachricht gesendet!",
                sourceComp: "Quellkomponente",
                sourcePropOpt: "Quelleigenschaft (Optional)",
                targetComp: "Zielkomponente",
                targetPropOpt: "Zieleigenschaft (Optional)",
                connLabelOpt: "Verbindungslabel (Optional)",
                generalSettings: "Allgemeine Einstellungen",
                compTitle: "Komponententitel",
                bgColor: "Hintergrundfarbe",
                description: "Beschreibung",
                lblArrowColor: "Pfeilfarbe",
                lblType: "Typ",
                lblWidth: "Dicke",
                optSolid: "Durchgezogen",
                optDashed: "Gestrichelt",
                optDotted: "Gepunktet",
                dataProps: "Dateneigenschaften",
                inOut: "Eingaben / Ausgaben",
                connections: "Verbindungen",
                addNewConn: "Neue Verbindung",
                sourceProp: "Quelleigenschaft",
                targetNode: "Zielknoten",
                targetProp: "Zieleigenschaft",
                duplicateComp: "Komponente Duplizieren",
                delete: "L√∂schen",
                saveChanges: "√Ñnderungen Speichern",
                cancel: "Abbrechen",
                quickAddComp: "Schnell Hinzuf√ºgen",
                editDep: "Abh√§ngigkeit Bearbeiten",
                to: "zu",
                connLabel: "Verbindungslabel",
                confirmReset: "Reset Best√§tigen",
                resetMsg: "Sind Sie sicher, dass Sie das gesamte Dashboard l√∂schen m√∂chten?",
                warning: "Warnung:",
                resetWarningBody: "Alle lokalen Daten gehen verloren, wenn Sie kein Backup haben.",
                yesReset: "Ja, Dashboard Leeren",
                helpInstructions: "Hilfe & Anleitung",
                learnHow: "Lernen Sie die Bedienung",
                toggleTheme: "Thema Umschalten",
                switchTheme: "Wechseln Sie zwischen Hell/Dunkel",
                language: "Sprache",
                viewChanges: "√Ñnderungen anzeigen",
                loadBackup: "Backup laden",
                saveAllData: "Alle Daten speichern",
                bulkEdit: "Massenbearbeitung in Excel",
                uploadFile: "Datendatei hochladen",
                processFile: "Datei verarbeiten & Graph aktualisieren",
                close: "Schlie√üen",
                exportSingle: "1. Export in Einzeldatei",
                exportSingleDesc: "Laden Sie Ihren gesamten Graphen als CSV herunter.",
                downloadCsv: "Kombinierte Daten.csv herunterladen",
                importSingle: "2. Import Einzeldatei",
                importSingleDesc: "Laden Sie eine kombinierte CSV hoch. <br><strong>Hinweis:</strong> Ersetzt aktuelle Daten.",
                csvDataManager: "CSV Datenmanager",
                aiHelpTitle: "KI-Assistent",
                aiHelpSubtitle: "Fragen Sie mich alles √ºber dieses Tool!",
                detailedDocs: "Detaillierte Dokumentation",
                helpCreateTitle: "Erstellung eines Graphen",
                helpExportTitle: "Export/Bearbeiten in Excel",
                helpImportContent: `<ol class="list-decimal list-inside space-y-2"><li>Click Import / Export CSV.</li><li>Select file.</li><li>Process.</li></ol>`,
                helpBackupContent: `<p class="mb-2">Sichern Sie Ihren Fortschritt lokal.</p><ol class="list-decimal list-inside space-y-2"><li><strong>Backup:</strong> L√§dt eine .json-Datei herunter (Alle Daten).</li><li><strong>Wiederherstellen:</strong> L√§dt eine .json-Datei hoch. <br><em class="text-red-500">(Warnung: √úberschreibt aktuelles Dashboard)</em>.</li></ol>`,
                helpAiTitle: "Nutzung des KI-Assistenten",
                helpAiContent: `<p class="mb-2">Der KI-Assistent hilft Ihnen offline bei der Navigation.</p><ul class="list-disc list-inside space-y-1"><li>Fragen Sie nach Verbindungen oder Knoten.</li><li>Fragen Sie nach CSV-Formaten.</li><li>Kein Internet erforderlich (l√§uft lokal).</li></ul>`,
                helpJsonImportTitle: "Eigenschaften aus JSON importieren",
                tooltipNewComp: "Neue Komponente",
                tooltipConnect: "Verbinden",
                tooltipData: "Daten & Export",
                tooltipSettings: "Einstellungen",
                jsonPlaceholder: 'z.B. { "field": "VARCHAR", "price": 100 }',
                jsonDetectTitle: "Werte wie 10 werden als 'number' erkannt",
                jsonRawTitle: "Werte wie 'NVARCHAR' werden Typ 'NVARCHAR'",
                csvStructIntro: "Das kombinierte CSV verwendet eine <strong>Superset von Spalten</strong>. Die erste Spalte <code>rowType</code> bestimmt, wie die Zeile gelesen wird.",
                componentList: "Komponenten",
                contactEmailPlaceholder: "ihre@email.com",
                contactMsgPlaceholder: "Wie k√∂nnen wir helfen?",
                backupRestore: "Sichern / Wiederherstellen",
                deleteCommentTitle: "Konversation l√∂schen",
                deleteCommentDesc: "Sind Sie sicher, dass Sie diesen gesamten Konversationsstrang l√∂schen m√∂chten?",
                yesDelete: "Ja, l√∂schen",
                dbConnectFail: "Datenbankverbindung fehlgeschlagen.",
                helpCollabTitle: "Echtzeit-Zusammenarbeit",
                csvStructCompTitle: "Wenn rowType = \"component\"",
                csvStructCompFields: "F√ºllen: id, title, description, color, x, y, docLink, props",
                csvStructCompNote: "Verbindungsspalten leer lassen.",
                csvStructConnTitle: "Wenn rowType = \"connection\"",
                csvStructConnFields: "F√ºllen: id, source, target, label, sourceProp, targetProp",
                csvStructConnNote: "Komponentenspalten leer lassen.",
                csvStructPropsNote: "* 'props' sollte ein JSON-Array-String sein. Beispiel: <code>\"[{\"\"name\"\":\"\"id\"\",\"\"type\"\":\"\"uuid\"\"}]\"</code>.",
                idLabel: "ID: ",
                contactEmailPlaceholder: "ihre@email.com",
                contactMsgPlaceholder: "Wie k√∂nnen wir helfen?",
                optSelectPropAny: "-- Eigenschaft w√§hlen (Alle) --",
                defaultColors: "Standardfarben",
                defCompBg: "Komponentenhintergrund",
                defPropText: "Eigenschaftsfarbe",
                deleteCompConfirmTitle: "Komponente L√∂schen?",
                deleteCompConfirmDesc: "Dies entfernt die Komponente und alle verbundenen Pfeile.",
                noComponentsFound: "Keine Komponenten gefunden",
                hideTips: "Tipps Verbergen",
                showTips: "Tipps Anzeigen",
                dbConnectFail: "Datenbankverbindung fehlgeschlagen.",
                helpCollabTitle: "Echtzeit-Kollaborationsanleitung",
                helpCollabContent: `
                        <p class="mb-2 font-bold">Verbindung herstellen:</p>
                        <ol class="list-decimal list-inside space-y-2 mb-3">
                            <li class="mb-1">
                                <strong>Projekt einrichten:</strong><br/>
                                <span class="text-xs text-gray-500 ml-4 block">
                                    1. Gehe zu <a href="https://console.firebase.google.com" target="_blank" class="text-blue-500 hover:underline">console.firebase.google.com</a>.<br/>
                                    2. "Projekt hinzuf√ºgen".<br/>
                                    3. **WICHTIG:** Gehe zu **Build > Realtime Database > Datenbank erstellen**.<br/>
                                    4. Klicke auf der Projekt√ºbersicht (oben links) auf das runde <strong>&lt;/&gt; (Web)</strong> Icon.<br/>
                                    5. App registrieren.<br/>
                                    6. W√§hle **Use a &lt;script&gt; tag**.
                                </span>
                            </li>
                            <li>
                                <strong>Config abrufen:</strong><br/>
                                <span class="text-xs text-gray-500 ml-4 block">
                                    Kopiere <strong>nur</strong> das <code>firebaseConfig</code> Objekt.<br/>
                                    <div class="bg-gray-100 p-2 rounded mt-1 mb-1 font-mono text-[10px] whitespace-pre overflow-x-auto border border-gray-200 text-gray-700">
{
  apiKey: "AIzaSy...",
  // ...
  appId: "..."
}</div>
                                </span>
                            </li>
                            <li>Gehe zum <strong>Daten-Tab</strong> in der Seitenleiste.</li>
                            <li>F√ºge den Config-Code ein.</li>
                            <li>Klicke <strong>Set Config</strong>. Gib <strong>BELIEBIGEN Namen</strong> ein (z.B. "mein-projekt"), um einen Raum zu erstellen oder beizutreten.</li>
                        </ol>`
            },
            cs: {
                dangerZone: "Nebezpeƒçn√° z√≥na",
                clearAppData: "Vymazat v≈°echna data aplikace a resetovat",
                clearAppDataDesc: "Smazat m√≠stn√≠ √∫lo≈æi≈°tƒõ, nastaven√≠ a mezipamƒõ≈•.",
                userProfile: "U≈æivatelsk√Ω profil",
                yourName: "Va≈°e jm√©no",
                save: "Ulo≈æit",
                yourColor: "Va≈°e barva",
                dropRoomTitle: "Zru≈°it m√≠stnost (Host)",
                dropRoomConfirm: "Jste si jisti? T√≠m se sma≈æou v≈°echna data v m√≠stnosti pro v≈°echny u≈æivatele.",
                connectCreateBtn: "Vytvo≈ôit novou m√≠stnost",
                connectJoinBtn: "P≈ôipojit se k m√≠stnosti",
                connectHost: "URL Firebase datab√°ze",
                connectHostPlaceholder: "https://vas-projekt.firebaseio.com",
                connectApiKey: "API Kl√≠ƒç",
                connectApiKeyPlaceholder: "Vlo≈æit API kl√≠ƒç",
                enterRoomId: "Zadejte ID m√≠stnosti...",
                graphManager: "Spr√°vce Grafu",
                systemReady: "Syst√©m P≈ôipraven",
                graphNameLabel: "N√°zev Grafu",
                untitledGraph: "Nepojmenovan√Ω Graf",
                createComp: "Nov√° Komponenta",
                titleReq: "N√°zev (Povinn√©)",
                enterCompId: "Zadejte ID nebo n√°zev",
                descPlaceholder: "Popis",
                boxColor: "Barva Boxu:",
                properties: "Vlastnosti",
                importPropsJson: "‚öôÔ∏è Importovat vlastnosti z JSON",
                jsonLimitNote: "Pozn√°mka: Importov√°no bude max 20 vlastnost√≠.",
                detectTypes: "Detekovat typy",
                useValues: "Pou≈æ√≠t hodnoty jako typy",
                saveProps: "Ulo≈æit vlastnosti",
                addPropBtn: "+ P≈ôidat Vlastnost",
                createCompBtn: "Vytvo≈ôit Box Komponenty",
                createDep: "Vytvo≈ôit Z√°vislost",
                tipPrefix: "Tip:",
                sidebarTip: "M≈Ø≈æete tak√© p≈ôet√°hnout body vlastnost√≠ pro vizu√°ln√≠ spojen√≠!",
                selectSource: "-- Vybrat Zdroj --",
                selectSourceProp: "-- Vybrat Vlastnost Zdroje --",
                selectTarget: "-- Vybrat C√≠l --",
                selectTargetProp: "-- Vybrat Vlastnost C√≠le --",
                labelPlaceholder: "≈†t√≠tek (nap≈ô. importuje)",
                connectCompBtn: "Propojit Komponenty",
                dataExport: "Data a Export",
                importExportCsv: "Import / Export Excel (CSV)",
                backupJson: "Z√°lohovat JSON",
                restoreJson: "Obnovit JSON",
                history: "Historie",
                downloadImage: "St√°hnout Obr√°zek",
                resetDashboard: "Resetovat Panel",
                dragHint: "P≈ôet√°hnƒõte uzly pro pohyb ‚Ä¢ P≈ôet√°hnƒõte vlastnosti pro spojen√≠",
                fabHelpTitle: "AI N√°povƒõda & FAQ",
                fabAddTitle: "Rychl√© P≈ôid√°n√≠",
                aiWelcome: "Ahoj! Zeptej se mƒõ, jak p≈ôidat uzly nebo exportovat graf.",
                aiPlaceholder: "Zadejte svou ot√°zku zde (nap≈ô. 'jak spojit uzly?')...",
                contactUs: "Kontaktujte n√°s",
                email: "Email",
                message: "Zpr√°va",
                sendMessage: "Odeslat Zpr√°vu",
                copyright: "Copyright ¬© 2026 | V√Ωvoj√°≈ô: magas.sergio@gmail.com",
                msgSent: "Zpr√°va odesl√°na!",
                sourceComp: "Zdrojov√° Komponenta",
                sourcePropOpt: "Zdrojov√° Vlastnost (Voliteln√©)",
                targetComp: "C√≠lov√° Komponenta",
                targetPropOpt: "C√≠lov√° Vlastnost (Voliteln√©)",
                connLabelOpt: "≈†t√≠tek Spojen√≠ (Voliteln√©)",
                generalSettings: "Obecn√° Nastaven√≠",
                compTitle: "N√°zev Komponenty",
                bgColor: "Barva Pozad√≠",
                description: "Popis",
                dataProps: "Datov√© Vlastnosti",
                inOut: "Vstupy / V√Ωstupy",
                connections: "Spojen√≠",
                addNewConn: "P≈ôidat Nov√© Spojen√≠",
                sourceProp: "Zdrojov√° Vlast.",
                targetNode: "C√≠lov√Ω Uzel",
                targetProp: "C√≠lov√° Vlast.",
                duplicateComp: "Duplikovat Komponentu",
                delete: "Smazat",
                saveChanges: "Ulo≈æit Zmƒõny",
                cancel: "Zru≈°it",
                quickAddComp: "Rychl√© P≈ôid√°n√≠ Komponenty",
                editDep: "Upravit Z√°vislost",
                to: "do",
                connLabel: "≈†t√≠tek Spojen√≠",
                confirmReset: "Potvrdit Reset",
                resetMsg: "Opravdu chcete vymazat cel√Ω panel?",
                warning: "Varov√°n√≠:",
                resetWarningBody: "V≈°echna m√≠stn√≠ data budou ztracena, pokud nem√°te z√°lohu.",
                yesReset: "Ano, Vymazat Panel",
                helpInstructions: "N√°povƒõda a Instrukce",
                learnHow: "Nauƒçte se pou≈æ√≠vat",
                toggleTheme: "P≈ôepnout T√©ma",
                switchTheme: "P≈ôep√≠n√°n√≠ svƒõtl√Ω/tmav√Ω re≈æim",
                language: "Jazyk",
                viewChanges: "Zobrazit zmƒõny",
                loadBackup: "Naƒç√≠st z√°lohu",
                saveAllData: "Ulo≈æit v≈°echna data",
                bulkEdit: "Hromadn√° √∫prava v Excelu",
                uploadFile: "Nahr√°t datov√Ω soubor",
                processFile: "Zpracovat soubor a aktualizovat",
                close: "Zav≈ô√≠t",
                exportSingle: "1. Export do jednoho souboru",
                exportSingleDesc: "St√°hnƒõte si cel√Ω graf jako CSV.",
                downloadCsv: "St√°hnout Combined Data.csv",
                importSingle: "2. Import jednoho souboru",
                importSingleDesc: "Nahrajte kombinovan√© CSV. <br><strong>Pozn√°mka:</strong> P≈ôep√≠≈°e aktu√°ln√≠ data.",
                tooltipNewComp: "Nov√° Komponenta",
                tooltipConnect: "Spojit",
                tooltipData: "Data a Export",
                tooltipSettings: "Nastaven√≠",
                jsonPlaceholder: 'nap≈ô. { "field": "VARCHAR", "price": 100 }',
                jsonDetectTitle: "Hodnoty jako 10 budou 'ƒç√≠slo'",
                jsonRawTitle: "Hodnoty jako 'NVARCHAR' budou typ 'NVARCHAR'",
                csvStructIntro: "Kombinovan√© CSV pou≈æ√≠v√° <strong>Superset Sloupc≈Ø</strong>. Prvn√≠ sloupec <code>rowType</code> urƒçuje, jak je ≈ô√°dek ƒçten.",
                csvStructCompTitle: "Pokud rowType = \"component\"",
                csvStructCompFields: "Vyplnit: id, title, description, color, x, y, docLink, props",
                csvStructCompNote: "Sloupce spojen√≠ nechte pr√°zdn√©.",
                csvStructConnTitle: "Pokud rowType = \"connection\"",
                csvStructConnFields: "Vyplnit: id, source, target, label, sourceProp, targetProp",
                csvStructConnNote: "Sloupce komponent nechte pr√°zdn√©.",
                csvStructPropsNote: "* 'props' mus√≠ b√Ωt JSON pole string. P≈ô√≠klad: <code>\"[{\"\"name\"\":\"\"id\"\",\"\"type\"\":\"\"uuid\"\"}]\"</code>.",
                idLabel: "ID: ",
                contactEmailPlaceholder: "vas@email.com",
                contactMsgPlaceholder: "Jak m≈Ø≈æeme pomoci?",
                optSelectPropAny: "-- Vybrat Vlastnost (V≈°e) --",
                helpBackupContent: `<p class="mb-2">Ulo≈æte sv≈Øj postup lok√°lnƒõ.</p><ol class="list-decimal list-inside space-y-2"><li><strong>Z√°loha:</strong> St√°hne soubor .json (kompletn√≠ data).</li><li><strong>Obnovit:</strong> Nahraje soubor .json. <br><em class="text-red-500">(Varov√°n√≠: P≈ôep√≠≈°e aktu√°ln√≠ panel)</em>.</li></ol>`,
                helpAiTitle: "Jak pou≈æ√≠vat AI Asistenta",
                helpAiContent: `<p class="mb-2">AI Asistent je offline n√°stroj pro pomoc s aplikac√≠.</p><ul class="list-disc list-inside space-y-1"><li>Zeptejte se na spojov√°n√≠ uzl≈Ø.</li><li>Zeptejte se na form√°ty CSV nebo JSON.</li><li>Nen√≠ pot≈ôeba internet (funguje lok√°lnƒõ).</li></ul>`,
                defaultColors: "V√Ωchoz√≠ barvy",
                defCompBg: "Pozad√≠ komponenty",
                defPropText: "Barva vlastnosti",
                deleteCompConfirmTitle: "Smazat Komponentu?",
                deleteCompConfirmDesc: "Toto odstran√≠ komponentu a v≈°echna spojen√≠.",
                noComponentsFound: "Nebyly nalezeny ≈æ√°dn√© komponenty",
                hideTips: "Skr√Ωt Tipy",
                showTips: "Zobrazit Tipy",
                dbConnectFail: "P≈ôipojen√≠ k datab√°zi selhalo.",
                helpCollabTitle: "Pr≈Øvodce spoluprac√≠ v re√°ln√©m ƒçase",
                helpCollabContent: `
                        <p class="mb-2 font-bold">Jak se p≈ôipojit:</p>
                        <ol class="list-decimal list-inside space-y-2 mb-3">
                            <li class="mb-1">
                                <strong>Nastaven√≠ projektu:</strong><br/>
                                <span class="text-xs text-gray-500 ml-4 block">
                                    1. Jdƒõte na <a href="https://console.firebase.google.com" target="_blank" class="text-blue-500 hover:underline">console.firebase.google.com</a>.<br/>
                                    2. Kliknƒõte "P≈ôidat projekt".<br/>
                                    3. **D≈ÆLE≈ΩIT√â:** Jdƒõte na **Build > Realtime Database > Vytvo≈ôit datab√°zi**.<br/>
                                    4. V p≈ôehledu projektu (ikona dom≈Ø) kliknƒõte na kulatou ikonu <strong>&lt;/&gt; (Web)</strong>.<br/>
                                    5. Zaregistrujte aplikaci.<br/>
                                    6. Vyberte **Use a &lt;script&gt; tag**.
                                </span>
                            </li>
                            <li>
                                <strong>Z√≠skat Config:</strong><br/>
                                <span class="text-xs text-gray-500 ml-4 block">
                                    Zkop√≠rujte <strong>pouze</strong> objekt <code>firebaseConfig</code>.<br/>
                                    <div class="bg-gray-100 p-2 rounded mt-1 mb-1 font-mono text-[10px] whitespace-pre overflow-x-auto border border-gray-200 text-gray-700">
{
  apiKey: "AIzaSy...",
  // ...
  appId: "..."
}</div>
                                </span>
                            </li>
                            <li>Jdƒõte na <strong>Kartu Data</strong>.</li>
                            <li>Vlo≈æte k√≥d konfigurace.</li>
                            <li>Kliknƒõte <strong>Nastavit Config</strong>. Zadejte <strong>JAK√ùKOLIV N√°zev</strong> (nap≈ô. "muj-projekt") pro vytvo≈ôen√≠ nebo p≈ôipojen√≠.</li>
                        </ol>`
            },
            fr: {
                dangerZone: "Zone de Danger",
                clearAppData: "Effacer toutes les donn√©es et r√©initialiser",
                clearAppDataDesc: "Supprimer le stockage local, les param√®tres et le cache.",
                userProfile: "Profil Utilisateur",
                yourName: "Votre Nom",
                save: "Enregistrer",
                yourColor: "Votre Couleur",
                dropRoomTitle: "Supprimer la salle (H√¥te)",
                dropRoomConfirm: "√ätes-vous s√ªr ? Cela effacera toutes les donn√©es de la salle pour tous les utilisateurs.",
                connectCreateBtn: "Cr√©er une nouvelle salle",
                connectJoinBtn: "Rejoindre une salle",
                connectHost: "URL Base de donn√©es Firebase",
                connectHostPlaceholder: "https://votre-projet.firebaseio.com",
                connectApiKey: "Cl√© API",
                connectApiKeyPlaceholder: "Coller la cl√© API",
                enterRoomId: "Entrer l'ID de la salle...",
                graphManager: "Gestionnaire",
                systemReady: "Syst√®me Pr√™t",
                graphNameLabel: "Nom du Graphique",
                untitledGraph: "Graphique Sans Titre",
                createComp: "Cr√©er un Composant",
                titleReq: "Titre (Requis)",
                enterCompId: "Entrez l'ID du composant",
                descPlaceholder: "Description",
                boxColor: "Couleur:",
                properties: "Propri√©t√©s",
                importPropsJson: "‚öôÔ∏è Importer JSON",
                jsonLimitNote: "Note: Max 20 propri√©t√©s.",
                detectTypes: "D√©tecter Types",
                useValues: "Valeurs comme Types",
                saveProps: "Enregistrer Props",
                addPropBtn: "+ Propri√©t√©",
                createCompBtn: "Cr√©er la Bo√Æte",
                createDep: "D√©pendance",
                tipPrefix: "Astuce:",
                sidebarTip: "Vous pouvez aussi glisser les points pour connecter!",
                selectSource: "-- S√©lect. Source --",
                selectSourceProp: "-- Prop. Source --",
                selectTarget: "-- S√©lect. Cible --",
                selectTargetProp: "-- Prop. Cible --",
                labelPlaceholder: "√âtiquette (ex. imports)",
                connectCompBtn: "Connecter",
                dataExport: "Donn√©es & Export",
                importExportCsv: "Import / Export CSV",
                backupJson: "Sauvegarder JSON",
                restoreJson: "Restaurer JSON",
                history: "Historique",
                downloadImage: "Image",
                resetDashboard: "R√©initialiser",
                dragHint: "Glisser pour d√©placer ‚Ä¢ Connecter les points",
                fabHelpTitle: "Aide IA",
                fabAddTitle: "Ajout Rapide",
                aiWelcome: "Bonjour! Demandez-moi comment ajouter des n≈ìuds.",
                aiPlaceholder: "Tapez votre question ici...",
                contactUs: "Contactez-nous",
                email: "Email",
                message: "Message",
                sendMessage: "Envoyer",
                copyright: "Copyright ¬© 2026 | D√©velop: magas.sergio@gmail.com",
                msgSent: "Message envoy√©!",
                sourceComp: "Composant Source",
                sourcePropOpt: "Propri√©t√© Source (Opt)",
                targetComp: "Composant Cible",
                targetPropOpt: "Propri√©t√© Cible (Opt)",
                connLabelOpt: "√âtiquette (Opt)",
                generalSettings: "Param√®tres G√©n√©raux",
                compTitle: "Titre du Composant",
                bgColor: "Couleur de Fond",
                description: "Description",
                dataProps: "Propri√©t√©s de Donn√©es",
                inOut: "Entr√©es / Sorties",
                connections: "Connexions",
                addNewConn: "Ajouter Connexion",
                sourceProp: "Prop Source",
                targetNode: "N≈ìud Cible",
                targetProp: "Prop Cible",
                duplicateComp: "Dupliquer",
                delete: "Supprimer",
                saveChanges: "Enregistrer",
                cancel: "Annuler",
                quickAddComp: "Ajout Rapide",
                editDep: "Modifier D√©pendance",
                to: "vers",
                connLabel: "√âtiquette",
                confirmReset: "Confirmer R√©initialisation",
                resetMsg: "Voulez-vous vraiment tout effacer?",
                warning: "Attention:",
                resetWarningBody: "Toutes les donn√©es locales seront perdues sans sauvegarde.",
                yesReset: "Oui, Effacer",
                helpInstructions: "Aide & Instructions",
                learnHow: "Apprendre √† utiliser",
                toggleTheme: "Changer Th√®me",
                switchTheme: "Mode Clair/Sombre",
                language: "Langue",
                viewChanges: "Voir changements",
                loadBackup: "Charger sauvegarde",
                saveAllData: "Sauvegarder tout",
                bulkEdit: "√âdition en masse Excel",
                uploadFile: "Charger fichier",
                processFile: "Traiter et Mettre √† jour",
                close: "Fermer",
                exportSingle: "1. Exporter en un fichier",
                exportSingleDesc: "T√©l√©chargez tout le graphe en CSV.",
                downloadCsv: "T√©l√©charger Data.csv",
                importSingle: "2. Importer un fichier",
                importSingleDesc: "Chargez un CSV combin√©. <br><strong>Note:</strong> Remplace les donn√©es actuelles.",
                tooltipNewComp: "Nouveau Composant",
                tooltipConnect: "Connecter",
                tooltipData: "Donn√©es & Export",
                tooltipSettings: "Param√®tres",
                jsonPlaceholder: 'ex: { "field": "VARCHAR", "price": 100 }',
                jsonDetectTitle: "Les valeurs comme 10 deviennent 'nombre'",
                jsonRawTitle: "Les valeurs comme 'NVARCHAR' deviennent le type 'NVARCHAR'",
                csvStructIntro: "Le CSV combin√© utilise un <strong>Superset de Colonnes</strong>. La premi√®re colonne <code>rowType</code> d√©termine la lecture.",
                csvStructCompTitle: "Si rowType = \"component\"",
                csvStructCompFields: "Remplir: id, title, description, color, x, y, docLink, props",
                csvStructCompNote: "Laisser les colonnes de connexion vides.",
                csvStructConnTitle: "Si rowType = \"connection\"",
                csvStructConnFields: "Remplir: id, source, target, label, sourceProp, targetProp",
                csvStructConnNote: "Laisser les colonnes de composant vides.",
                csvStructPropsNote: "* 'props' doit √™tre une cha√Æne JSON array. Exemple: <code>\"[{\"\"name\"\":\"\"id\"\",\"\"type\"\":\"\"uuid\"\"}]\"</code>.",
                idLabel: "ID: ",
                contactEmailPlaceholder: "votre@email.com",
                contactMsgPlaceholder: "Comment pouvons-nous aider ?",
                optSelectPropAny: "-- Choisir Propri√©t√© (Tout) --",
                helpBackupContent: `<p class="mb-2">Sauvegardez votre progression.</p><ol class="list-decimal list-inside space-y-2"><li><strong>Sauvegarde:</strong> T√©l√©charge un fichier .json (donn√©es compl√®tes).</li><li><strong>Restaurer:</strong> Charge un fichier .json. <br><em class="text-red-500">(Attention: √âcrase le tableau de bord actuel)</em>.</li></ol>`,
                helpAiTitle: "Comment utiliser l'assistant IA",
                helpAiContent: `<p class="mb-2">L'assistant IA est un outil hors ligne.</p><ul class="list-disc list-inside space-y-1"><li>Demandez comment connecter des n≈ìuds.</li><li>Demandez des informations sur CSV ou JSON.</li><li>Aucun internet requis (fonctionne localement).</li></ul>`,
                defaultColors: "Couleurs par d√©faut",
                defCompBg: "Fond du composant",
                defPropText: "Couleur de propri√©t√©",
                deleteCompConfirmTitle: "Supprimer Composant ?",
                deleteCompConfirmDesc: "Ceci supprimera le composant et toutes les connexions.",
                noComponentsFound: "Aucun composant trouv√©",
                hideTips: "Masquer Astuces",
                showTips: "Afficher Astuces",
                dbConnectFail: "√âchec connexion base de donn√©es.",
                helpCollabTitle: "Collaboration en temps r√©el",
                helpCollabContent: `
                        <p class="mb-2 font-bold">Comment se connecter:</p>
                        <ol class="list-decimal list-inside space-y-2 mb-3">
                            <li class="mb-1">
                                <strong>Configuration:</strong><br/>
                                <span class="text-xs text-gray-500 ml-4 block">
                                    1. Allez sur <a href="https://console.firebase.google.com" target="_blank" class="text-blue-500 hover:underline">console.firebase.google.com</a>.<br/>
                                    2. "Ajouter un projet".<br/>
                                    3. **IMPORTANT:** Allez dans **Build > Realtime Database > Cr√©er une base de donn√©es**.<br/>
                                    4. Sur la vue d'ensemble du projet (ic√¥ne Accueil), cliquez sur l'ic√¥ne ronde <strong>&lt;/&gt; (Web)</strong>.<br/>
                                    5. Enregistrez l'application.<br/>
                                    6. S√©lectionnez **Use a &lt;script&gt; tag**.
                                </span>
                            </li>
                            <li>
                                <strong>Obtenir Config:</strong><br/>
                                <span class="text-xs text-gray-500 ml-4 block">
                                    Copiez <strong>uniquement</strong> l'objet <code>firebaseConfig</code>.<br/>
                                    <div class="bg-gray-100 p-2 rounded mt-1 mb-1 font-mono text-[10px] whitespace-pre overflow-x-auto border border-gray-200 text-gray-700">
{
  apiKey: "AIzaSy...",
  // ...
  appId: "..."
}</div>
                                </span>
                            </li>
                            <li>Allez dans l'onglet <strong>Donn√©es</strong>.</li>
                            <li>Collez le code de configuration.</li>
                            <li>Cliquez <strong>Set Config</strong>. Entrez <strong>TOUT NOM</strong> (ex: "mon-projet") pour cr√©er ou rejoindre.</li>
                        </ol>`
            },
            uk: {
                dangerZone: "–ù–µ–±–µ–∑–ø–µ—á–Ω–∞ –∑–æ–Ω–∞",
                clearAppData: "–û—á–∏—Å—Ç–∏—Ç–∏ –¥–∞–Ω—ñ —Ç–∞ —Å–∫–∏–Ω—É—Ç–∏",
                clearAppDataDesc: "–í–∏–¥–∞–ª–∏—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–µ —Å—Ö–æ–≤–∏—â–µ, –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –∫–µ—à.",
                userProfile: "–ü—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞",
                yourName: "–í–∞—à–µ —ñ–º'—è",
                save: "–ó–±–µ—Ä–µ–≥—Ç–∏",
                yourColor: "–í–∞—à –∫–æ–ª—ñ—Ä",
                dropRoomTitle: "–í–∏–¥–∞–ª–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É (Host)",
                dropRoomConfirm: "–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ? –¶–µ –ø—Ä–∏–∑–≤–µ–¥–µ –¥–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –≤—Å—ñ—Ö –¥–∞–Ω–∏—Ö —É –∫—ñ–º–Ω–∞—Ç—ñ –¥–ª—è –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.",
                connectCreateBtn: "–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É –∫—ñ–º–Ω–∞—Ç—É",
                connectJoinBtn: "–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ –∫—ñ–º–Ω–∞—Ç–∏",
                connectHost: "URL –±–∞–∑–∏ –¥–∞–Ω–∏—Ö Firebase",
                connectHostPlaceholder: "https://your-project.firebaseio.com",
                connectApiKey: "API –ö–ª—é—á",
                connectApiKeyPlaceholder: "–í—Å—Ç–∞–≤–∏—Ç–∏ API –∫–ª—é—á",
                enterRoomId: "–í–≤–µ–¥—ñ—Ç—å ID –∫—ñ–º–Ω–∞—Ç–∏...",
                graphManager: "–ú–µ–Ω–µ–¥–∂–µ—Ä",
                systemReady: "–°–∏—Å—Ç–µ–º–∞ –ì–æ—Ç–æ–≤–∞",
                graphNameLabel: "–ù–∞–∑–≤–∞",
                untitledGraph: "–ë–µ–∑ –ù–∞–∑–≤–∏",
                createComp: "–°—Ç–≤–æ—Ä–∏—Ç–∏ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç",
                titleReq: "–ù–∞–∑–≤–∞",
                enterCompId: "–í–≤–µ–¥—ñ—Ç—å ID",
                descPlaceholder: "–û–ø–∏—Å",
                boxColor: "–ö–æ–ª—ñ—Ä:",
                properties: "–í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ",
                importPropsJson: "‚öôÔ∏è –Ü–º–ø–æ—Ä—Ç –∑ JSON",
                jsonLimitNote: "–ü—Ä–∏–º—ñ—Ç–∫–∞: –ú–∞–∫—Å. 20 –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π.",
                detectTypes: "–í–∏–∑–Ω–∞—á–∏—Ç–∏ –¢–∏–ø–∏",
                useValues: "–ó–Ω–∞—á–µ–Ω–Ω—è —è–∫ –¢–∏–ø–∏",
                saveProps: "–ó–±–µ—Ä–µ–≥—Ç–∏ –í–ª–∞—Å—Ç.",
                addPropBtn: "+ –í–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å",
                createCompBtn: "–°—Ç–≤–æ—Ä–∏—Ç–∏",
                createDep: "–°—Ç–≤–æ—Ä–∏—Ç–∏ –ó–≤'—è–∑–æ–∫",
                tipPrefix: "–ü–æ—Ä–∞–¥–∞:",
                sidebarTip: "–¢—è–≥–Ω—ñ—Ç—å —Ç–æ—á–∫–∏ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π, —â–æ–± –∑'—î–¥–Ω–∞—Ç–∏ —ó—Ö!",
                selectSource: "-- –î–∂–µ—Ä–µ–ª–æ --",
                selectSourceProp: "-- –í–ª–∞—Å—Ç. –î–∂–µ—Ä–µ–ª–æ --",
                selectTarget: "-- –¶—ñ–ª—å --",
                selectTargetProp: "-- –í–ª–∞—Å—Ç. –¶—ñ–ª—å --",
                labelPlaceholder: "–ú—ñ—Ç–∫–∞",
                connectCompBtn: "–ó'—î–¥–Ω–∞—Ç–∏",
                dataExport: "–ï–∫—Å–ø–æ—Ä—Ç",
                importExportCsv: "XLS/CSV",
                backupJson: " JSON –ö–æ–ø—ñ—è",
                restoreJson: "–í—ñ–¥–Ω–æ–≤–∏—Ç–∏",
                history: "–Ü—Å—Ç–æ—Ä—ñ—è",
                downloadImage: "–§–æ—Ç–æ",
                resetDashboard: "–°–∫–∏–Ω—É—Ç–∏",
                dragHint: "–¢—è–≥–Ω—ñ—Ç—å –¥–ª—è –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è ‚Ä¢ –ó'—î–¥–Ω–∞–π—Ç–µ",
                fabHelpTitle: "AI –î–æ–ø–æ–º–æ–≥–∞",
                fabAddTitle: "–®–≤–∏–¥–∫–µ –î–æ–¥–∞–≤–∞–Ω–Ω—è",
                aiWelcome: "–ü—Ä–∏–≤—ñ—Ç! –ó–∞–ø–∏—Ç–∞–π—Ç–µ –º–µ–Ω–µ –ø—Ä–æ —Å–∏—Å—Ç–µ–º—É.",
                aiPlaceholder: "–í–∞—à–µ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è...",
                contactUs: "–ó–≤'—è–∑–∞—Ç–∏—Å—è",
                email: "Email",
                message: "–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è",
                sendMessage: "–ù–∞–¥—ñ—Å–ª–∞—Ç–∏",
                copyright: "Copyright ¬© 2026 | –†–æ–∑—Ä–æ–±–Ω–∏–∫: magas.sergio@gmail.com",
                msgSent: "–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ!",
                sourceComp: "–ö–æ–º–ø. –î–∂–µ—Ä–µ–ª–æ",
                sourcePropOpt: "–í–ª–∞—Å—Ç. –î–∂–µ—Ä–µ–ª–æ (–û–ø—Ü)",
                targetComp: "–ö–æ–º–ø. –¶—ñ–ª—å",
                targetPropOpt: "–í–ª–∞—Å—Ç. –¶—ñ–ª—å (–û–ø—Ü)",
                connLabelOpt: "–ú—ñ—Ç–∫–∞ (–û–ø—Ü)",
                generalSettings: "–ó–∞–≥–∞–ª—å–Ω—ñ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è",
                compTitle: "–ù–∞–∑–≤–∞ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∞",
                bgColor: "–ö–æ–ª—ñ—Ä –§–æ–Ω—É",
                description: "–û–ø–∏—Å",
                dataProps: "–í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ –î–∞–Ω–∏—Ö",
                inOut: "–í—Ö–æ–¥–∏ / –í–∏—Ö–æ–¥–∏",
                connections: "–ó–≤'—è–∑–∫–∏",
                addNewConn: "–î–æ–¥–∞—Ç–∏ –ó–≤'—è–∑–æ–∫",
                sourceProp: "–í–ª–∞—Å—Ç. –î–∂–µ—Ä–µ–ª–æ",
                targetNode: "–í—É–∑–æ–ª –¶—ñ–ª—å",
                targetProp: "–í–ª–∞—Å—Ç. –¶—ñ–ª—å",
                duplicateComp: "–î—É–±–ª—é–≤–∞—Ç–∏",
                delete: "–í–∏–¥–∞–ª–∏—Ç–∏",
                saveChanges: "–ó–±–µ—Ä–µ–≥—Ç–∏",
                cancel: "–°–∫–∞—Å—É–≤–∞—Ç–∏",
                quickAddComp: "–®–≤–∏–¥–∫–æ –î–æ–¥–∞—Ç–∏",
                editDep: "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ó–≤'—è–∑–æ–∫",
                to: "–¥–æ",
                connLabel: "–ú—ñ—Ç–∫–∞",
                confirmReset: "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –°–∫–∏–¥–∞–Ω–Ω—è",
                resetMsg: "–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –æ—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ?",
                warning: "–£–≤–∞–≥–∞:",
                resetWarningBody: "–í—Å—ñ –ª–æ–∫–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ –±—É–¥—É—Ç—å –≤—Ç—Ä–∞—á–µ–Ω—ñ –±–µ–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó.",
                yesReset: "–¢–∞–∫, –û—á–∏—Å—Ç–∏—Ç–∏",
                helpInstructions: "–î–æ–ø–æ–º–æ–≥–∞",
                learnHow: "–Ø–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—è",
                toggleTheme: "–ó–º—ñ–Ω–∏—Ç–∏ –¢–µ–º—É",
                switchTheme: "–°–≤—ñ—Ç–ª–∞/–¢–µ–º–Ω–∞ —Ç–µ–º–∞",
                language: "–ú–æ–≤–∞",
                viewChanges: "–ü–æ–∫–∞–∑–∞—Ç–∏ –∑–º—ñ–Ω–∏",
                loadBackup: "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–æ–ø—ñ—é",
                saveAllData: "–ó–±–µ—Ä–µ–≥—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ",
                bulkEdit: "–ú–∞—Å–æ–≤–µ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –≤ Excel",
                uploadFile: "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª",
                processFile: "–û–±—Ä–æ–±–∏—Ç–∏ —Ç–∞ –û–Ω–æ–≤–∏—Ç–∏",
                close: "–ó–∞–∫—Ä–∏—Ç–∏",
                exportSingle: "1. –ï–∫—Å–ø–æ—Ä—Ç —É —Ñ–∞–π–ª",
                exportSingleDesc: "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫ —è–∫ CSV.",
                downloadCsv: "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ CSV",
                importSingle: "2. –Ü–º–ø–æ—Ä—Ç —Ñ–∞–π–ª—É",
                importSingleDesc: "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ CSV. <br><strong>–ü—Ä–∏–º—ñ—Ç–∫–∞:</strong> –ó–∞–º—ñ–Ω–∏—Ç—å –ø–æ—Ç–æ—á–Ω—ñ –¥–∞–Ω—ñ.",
                csvDataManager: "–ú–µ–Ω–µ–¥–∂–µ—Ä CSV –î–∞–Ω–∏—Ö",
                aiHelpTitle: "AI –ê—Å–∏—Å—Ç–µ–Ω—Ç",
                aiHelpSubtitle: "–ó–∞–ø–∏—Ç–∞–π—Ç–µ –º–µ–Ω–µ –ø—Ä–æ –±—É–¥—å-—â–æ!",
                detailedDocs: "–î–µ—Ç–∞–ª—å–Ω–∞ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è",
                helpCreateTitle: "–Ø–∫ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫",
                helpExportTitle: "–ï–∫—Å–ø–æ—Ä—Ç/–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –≤ Excel",
                helpImportContent: `<ol class="list-decimal list-inside space-y-2"><li>Click Import / Export CSV.</li><li>Select file.</li><li>Process.</li></ol>`,
                helpBackupContent: `<p class="mb-2">–ó–±–µ—Ä–µ–∂—ñ—Ç—å —Å–≤—ñ–π –ø—Ä–æ–≥—Ä–µ—Å –ª–æ–∫–∞–ª—å–Ω–æ.</p><ol class="list-decimal list-inside space-y-2"><li><strong>–†–µ–∑–µ—Ä–≤–Ω–∞ –∫–æ–ø—ñ—è:</strong> –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î —Ñ–∞–π–ª .json (–ø–æ–≤–Ω—ñ –¥–∞–Ω—ñ).</li><li><strong>–í—ñ–¥–Ω–æ–≤–∏—Ç–∏:</strong> –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î —Ñ–∞–π–ª .json. <br><em class="text-red-500">(–£–≤–∞–≥–∞: –ü–µ—Ä–µ–∑–∞–ø–∏—Å—É—î –ø–æ—Ç–æ—á–Ω—É –ø–∞–Ω–µ–ª—å)</em>.</li></ol>`,
                helpAiTitle: "–Ø–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—è AI –ê—Å–∏—Å—Ç–µ–Ω—Ç–æ–º",
                helpAiContent: `<p class="mb-2">AI –ê—Å–∏—Å—Ç–µ–Ω—Ç - —Ü–µ –æ—Ñ–ª–∞–π–Ω —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç.</p><ul class="list-disc list-inside space-y-1"><li>–ó–∞–ø–∏—Ç–∞–π—Ç–µ, —è–∫ –∑'—î–¥–Ω—É–≤–∞—Ç–∏ –≤—É–∑–ª–∏.</li><li>–ó–∞–ø–∏—Ç–∞–π—Ç–µ –ø—Ä–æ —Ñ–æ—Ä–º–∞—Ç–∏ CSV –∞–±–æ JSON.</li><li>–Ü–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω (–ø—Ä–∞—Ü—é—î –ª–æ–∫–∞–ª—å–Ω–æ).</li></ul>`,
                helpJsonImportTitle: "–Ü–º–ø–æ—Ä—Ç –∑ JSON",
                tooltipNewComp: "–ù–æ–≤–∏–π –ö–æ–º–ø–æ–Ω–µ–Ω—Ç",
                tooltipConnect: "–ó'—î–¥–Ω–∞—Ç–∏",
                tooltipData: "–î–∞–Ω—ñ —Ç–∞ –ï–∫—Å–ø–æ—Ä—Ç",
                tooltipSettings: "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è",
                jsonPlaceholder: '–Ω–∞–ø—Ä. { "field": "VARCHAR", "price": 100 }',
                jsonDetectTitle: "–ó–Ω–∞—á–µ–Ω–Ω—è —è–∫ 10 —Å—Ç–∞—é—Ç—å '—á–∏—Å–ª–æ–º'",
                jsonRawTitle: "–ó–Ω–∞—á–µ–Ω–Ω—è —è–∫ 'NVARCHAR' —Å—Ç–∞—é—Ç—å —Ç–∏–ø–æ–º 'NVARCHAR'",
                csvStructIntro: "–ö–æ–º–±—ñ–Ω–æ–≤–∞–Ω–∏–π CSV –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î <strong>–ù–∞–±—ñ—Ä —Å—Ç–æ–≤–ø—Ü—ñ–≤</strong>. –ü–µ—Ä—à–∏–π —Å—Ç–æ–≤–ø–µ—Ü—å <code>rowType</code> –≤–∏–∑–Ω–∞—á–∞—î —Ç–∏–ø —Ä—è–¥–∫–∞.",
                csvStructCompTitle: "–Ø–∫—â–æ rowType = \"component\"",
                csvStructCompFields: "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å: id, title, description, color, x, y, docLink, props",
                csvStructCompNote: "–ó–∞–ª–∏—à—Ç–µ —Å—Ç–æ–≤–ø—Ü—ñ –∑–≤'—è–∑–∫—ñ–≤ –ø–æ—Ä–æ–∂–Ω—ñ–º–∏.",
                csvStructConnTitle: "–Ø–∫—â–æ rowType = \"connection\"",
                csvStructConnFields: "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å: id, source, target, label, sourceProp, targetProp",
                csvStructConnNote: "–ó–∞–ª–∏—à—Ç–µ —Å—Ç–æ–≤–ø—Ü—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤ –ø–æ—Ä–æ–∂–Ω—ñ–º–∏.",
                csvStructPropsNote: "* 'props' –º–∞—î –±—É—Ç–∏ —Ä—è–¥–∫–æ–º –º–∞—Å–∏–≤—É JSON. –ü—Ä–∏–∫–ª–∞–¥: <code>\"[{\"\"name\"\":\"\"id\"\",\"\"type\"\":\"\"uuid\"\"}]\"</code>.",
                idLabel: "ID: ",
                contactEmailPlaceholder: "vash@email.com",
                contactMsgPlaceholder: "–Ø–∫ –º–∏ –º–æ–∂–µ–º–æ –¥–æ–ø–æ–º–æ–≥—Ç–∏?",
                optSelectPropAny: "-- –í–∏–±—Ä–∞—Ç–∏ –í–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å (–í—Å—ñ) --",
                defaultColors: "–ö–æ–ª—å–æ—Ä–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º",
                defCompBg: "–§–æ–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞",
                defPropText: "–ö–æ–ª—ñ—Ä –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ",
                deleteCompConfirmTitle: "–í–∏–¥–∞–ª–∏—Ç–∏ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç?",
                deleteCompConfirmDesc: "–¶–µ –≤–∏–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ç–∞ –≤—Å—ñ –∑–≤'—è–∑–∫–∏.",
                noComponentsFound: "–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ",
                hideTips: "–°—Ö–æ–≤–∞—Ç–∏ –ü–æ—Ä–∞–¥–∏",
                showTips: "–ü–æ–∫–∞–∑–∞—Ç–∏ –ü–æ—Ä–∞–¥–∏",
                dbConnectFail: "–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –ë–î.",
                helpCollabTitle: "–°–ø—ñ–≤–ø—Ä–∞—Ü—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ",
                helpCollabContent: `
                        <p class="mb-2 font-bold">–Ø–∫ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è:</p>
                        <ol class="list-decimal list-inside space-y-2 mb-3">
                            <li class="mb-1">
                                <strong>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ü—Ä–æ—î–∫—Ç—É:</strong><br/>
                                <span class="text-xs text-gray-500 ml-4 block">
                                    1. –ü–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ <a href="https://console.firebase.google.com" target="_blank" class="text-blue-500 hover:underline">console.firebase.google.com</a>.<br/>
                                    2. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "Add Project".<br/>
                                    3. **–í–ê–ñ–õ–ò–í–û:** –ü–µ—Ä–µ–π–¥—ñ—Ç—å —É **Build > Realtime Database > Create Database**.<br/>
                                    4. –£ –∑–∞–≥–∞–ª—å–Ω–æ–º—É –æ–≥–ª—è–¥—ñ (—ñ–∫–æ–Ω–∫–∞ –±—É–¥–∏–Ω–∫—É –∑–ª—ñ–≤–∞), –∑–Ω–∞–π–¥—ñ—Ç—å —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫—Ä—É–≥–ª—É —ñ–∫–æ–Ω–∫—É <strong>&lt;/&gt; (Web)</strong>.<br/>
                                    5. –ó–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ –¥–æ–¥–∞—Ç–æ–∫.<br/>
                                    6. –í–∏–±–µ—Ä—ñ—Ç—å **Use a &lt;script&gt; tag**.
                                </span>
                            </li>
                            <li>
                                <strong>–û—Ç—Ä–∏–º–∞—Ç–∏ Config:</strong><br/>
                                <span class="text-xs text-gray-500 ml-4 block">
                                    –°–∫–æ–ø—ñ—é–π—Ç–µ <strong>—Ç—ñ–ª—å–∫–∏</strong> –æ–±'—î–∫—Ç <code>firebaseConfig</code>.<br/>
                                    <div class="bg-gray-100 p-2 rounded mt-1 mb-1 font-mono text-[10px] whitespace-pre overflow-x-auto border border-gray-200 text-gray-700">
{
  apiKey: "AIzaSy...",
  // ...
  appId: "..."
}</div>
                                </span>
                            </li>
                            <li>–ü–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ <strong>–í–∫–ª–∞–¥–∫—É –î–∞–Ω–∏—Ö</strong>.</li>
                            <li>–í—Å—Ç–∞–≤—Ç–µ –∫–æ–¥ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó.</li>
                            <li>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å <strong>Set Config</strong>. –í–≤–µ–¥—ñ—Ç—å <strong>–ë–£–î–¨-–Ø–ö–ï –Ü–º'—è</strong> (–Ω–∞–ø—Ä. "miy-proekt"), —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∞–±–æ –ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è.</li>
                        </ol>`
            },
            zh: {
                dangerZone: "Âç±Èô©Âå∫Âüü",
                clearAppData: "Ê∏ÖÈô§ÊâÄÊúâÂ∫îÁî®Êï∞ÊçÆÂπ∂ÈáçÁΩÆ",
                clearAppDataDesc: "Âà†Èô§Êú¨Âú∞Â≠òÂÇ®„ÄÅËÆæÁΩÆÂíåÁºìÂ≠ò„ÄÇ",
                userProfile: "Áî®Êà∑ËµÑÊñô",
                yourName: "ÊÇ®ÁöÑÂêçÂ≠ó",
                save: "‰øùÂ≠ò",
                yourColor: "ÊÇ®ÁöÑÈ¢úËâ≤",
                dropRoomTitle: "Âà†Èô§ÊàøÈó¥ (Êàø‰∏ª)",
                dropRoomConfirm: "ÊÇ®Á°ÆÂÆöÂêóÔºüËøôÂ∞ÜÂà†Èô§ÊâÄÊúâÁî®Êà∑ÁöÑÊàøÈó¥Êï∞ÊçÆ„ÄÇ",
                connectCreateBtn: "ÂàõÂª∫Êñ∞ÊàøÈó¥",
                connectJoinBtn: "Âä†ÂÖ•ÊàøÈó¥",
                connectHost: "Firebase Êï∞ÊçÆÂ∫ì URL",
                connectHostPlaceholder: "https://your-project.firebaseio.com",
                connectApiKey: "API ÂØÜÈí•",
                connectApiKeyPlaceholder: "Á≤òË¥¥ API ÂØÜÈí•",
                enterRoomId: "ËæìÂÖ•ÊàøÈó¥ ID...",
                graphManager: "ÂõæË°®ÁÆ°ÁêÜÂô®",
                systemReady: "Á≥ªÁªüÂ∞±Áª™",
                graphNameLabel: "ÂõæË°®ÂêçÁß∞",
                untitledGraph: "Êó†Ê†áÈ¢ò",
                createComp: "Êñ∞ÁªÑ‰ª∂",
                titleReq: "Ê†áÈ¢ò",
                enterCompId: "ËæìÂÖ•ID",
                descPlaceholder: "ÊèèËø∞",
                boxColor: "È¢úËâ≤:",
                properties: "Â±ûÊÄß",
                importPropsJson: "‚öôÔ∏è ‰ªé JSON ÂØºÂÖ•",
                jsonLimitNote: "Ê≥®ÊÑèÔºöÊúÄÂ§öÂØºÂÖ•20‰∏™Â±ûÊÄß„ÄÇ",
                detectTypes: "Ê£ÄÊµãÁ±ªÂûã",
                useValues: "‰ΩøÁî®ÂÄº‰Ωú‰∏∫Á±ªÂûã",
                defaultColors: "ÈªòËÆ§È¢úËâ≤",
                defCompBg: "ÁªÑ‰ª∂ËÉåÊôØ",
                defPropText: "Â±ûÊÄßÈ¢úËâ≤",
                saveProps: "‰øùÂ≠òÂ±ûÊÄß",
                addPropBtn: "+ Â±ûÊÄß",
                createCompBtn: "ÂàõÂª∫ÁªÑ‰ª∂",
                createDep: "ÂàõÂª∫‰æùËµñ",
                tipPrefix: "ÊèêÁ§∫:",
                sidebarTip: "ÊÇ®‰πüÂèØ‰ª•ÊãñÂä®Â±ûÊÄßÁÇπËøõË°åËøûÊé•ÔºÅ",
                selectSource: "-- Ê∫ê --",
                selectSourceProp: "-- Ê∫êÂ±ûÊÄß --",
                selectTarget: "-- ÁõÆÊ†á --",
                selectTargetProp: "-- ÁõÆÊ†áÂ±ûÊÄß --",
                labelPlaceholder: "Ê†áÁ≠æ",
                connectCompBtn: "ËøûÊé•",
                dataExport: "ÂØºÂá∫",
                importExportCsv: "CSVË°®Ê†º",
                backupJson: "Â§á‰ªΩ",
                restoreJson: "ÊÅ¢Â§ç",
                history: "ÂéÜÂè≤",
                downloadImage: "‰∏ãËΩΩ",
                resetDashboard: "ÈáçÁΩÆ",
                dragHint: "ÊãñÂä®ÁßªÂä® ‚Ä¢ ÊãñÂä®ËøûÊé•",
                fabHelpTitle: "Â∏ÆÂä©",
                fabAddTitle: "Âø´ÈÄüÊ∑ªÂä†",
                aiWelcome: "‰Ω†Â•ΩÔºÅËØ∑ÈóÆÊúâ‰ªÄ‰πàÂ∏ÆÂä©Ôºü",
                aiPlaceholder: "ËæìÂÖ•ÈóÆÈ¢ò...",
                contactUs: "ËÅîÁ≥ªÊàë‰ª¨",
                email: "ÈÇÆÁÆ±",
                message: "Ê∂àÊÅØ",
                sendMessage: "ÂèëÈÄÅ",
                copyright: "Copyright ¬© 2026 | ÂºÄÂèëËÄÖ: magas.sergio@gmail.com",
                msgSent: "Ê∂àÊÅØÂ∑≤ÂèëÈÄÅÔºÅ",
                sourceComp: "Ê∫êÁªÑ‰ª∂",
                sourcePropOpt: "Ê∫êÂ±ûÊÄß (ÂèØÈÄâ)",
                targetComp: "ÁõÆÊ†áÁªÑ‰ª∂",
                targetPropOpt: "ÁõÆÊ†áÂ±ûÊÄß (ÂèØÈÄâ)",
                connLabelOpt: "ËøûÊé•Ê†áÁ≠æ (ÂèØÈÄâ)",
                generalSettings: "Â∏∏ËßÑËÆæÁΩÆ",
                compTitle: "ÁªÑ‰ª∂Ê†áÈ¢ò",
                bgColor: "ËÉåÊôØÈ¢úËâ≤",
                description: "ÊèèËø∞",
                dataProps: "Êï∞ÊçÆÂ±ûÊÄß",
                inOut: "ËæìÂÖ• / ËæìÂá∫",
                connections: "ËøûÊé•",
                addNewConn: "Ê∑ªÂä†Êñ∞ËøûÊé•",
                sourceProp: "Ê∫êÂ±ûÊÄß",
                targetNode: "ÁõÆÊ†áËäÇÁÇπ",
                targetProp: "ÁõÆÊ†áÂ±ûÊÄß",
                duplicateComp: "Â§çÂà∂ÁªÑ‰ª∂",
                delete: "Âà†Èô§",
                saveChanges: "‰øùÂ≠òÊõ¥Êîπ",
                cancel: "ÂèñÊ∂à",
                quickAddComp: "Âø´ÈÄüÊ∑ªÂä†ÁªÑ‰ª∂",
                editDep: "ÁºñËæë‰æùËµñ",
                to: "Ëá≥",
                connLabel: "ËøûÊé•Ê†áÁ≠æ",
                confirmReset: "Á°ÆËÆ§ÈáçÁΩÆ",
                resetMsg: "ÊÇ®Á°ÆÂÆöË¶ÅÊ∏ÖÈô§Êï¥‰∏™‰ª™Ë°®ÊùøÂêóÔºü",
                warning: "Ë≠¶Âëä:",
                resetWarningBody: "Â¶ÇÊûúÊ≤°ÊúâÂ§á‰ªΩÔºåÊâÄÊúâÊú¨Âú∞Êï∞ÊçÆÂ∞Ü‰∏¢Â§±„ÄÇ",
                yesReset: "ÊòØÔºåÊ∏ÖÈô§‰ª™Ë°®Êùø",
                helpInstructions: "Â∏ÆÂä©‰∏éËØ¥Êòé",
                learnHow: "‰∫ÜËß£Â¶Ç‰Ωï‰ΩøÁî®",
                toggleTheme: "ÂàáÊç¢‰∏ªÈ¢ò",
                switchTheme: "ÂàáÊç¢‰∫Æ/ÊöóÊ®°Âºè",
                language: "ËØ≠Ë®Ä",
                viewChanges: "Êü•ÁúãÊõ¥Êîπ",
                loadBackup: "Âä†ËΩΩÂ§á‰ªΩ",
                saveAllData: "‰øùÂ≠òÊâÄÊúâÊï∞ÊçÆ",
                bulkEdit: "Excel ÊâπÈáèÁºñËæë",
                uploadFile: "‰∏ä‰º†Êï∞ÊçÆÊñá‰ª∂",
                processFile: "Â§ÑÁêÜÊñá‰ª∂Âπ∂Êõ¥Êñ∞",
                close: "ÂÖ≥Èó≠",
                exportSingle: "1. ÂØºÂá∫Âà∞Âçï‰∏™Êñá‰ª∂",
                exportSingleDesc: "‰∏ãËΩΩÊï¥‰∏™ÂõæË°®‰∏∫ CSV„ÄÇ",
                downloadCsv: "‰∏ãËΩΩ Combined Data.csv",
                importSingle: "2. ÂØºÂÖ•Âçï‰∏™Êñá‰ª∂",
                importSingleDesc: "‰∏ä‰º† CSV„ÄÇ <br><strong>Ê≥®ÊÑèÔºö</strong> Â∞ÜÊõøÊç¢ÂΩìÂâçÊï∞ÊçÆ„ÄÇ",
                helpBackupContent: `<p class="mb-2">Êú¨Âú∞‰øùÂ≠òËøõÂ∫¶„ÄÇ</p><ol class="list-decimal list-inside space-y-2"><li><strong>Â§á‰ªΩ:</strong> ‰∏ãËΩΩ .json Êñá‰ª∂ÔºàÂÆåÊï¥Êï∞ÊçÆÔºâ„ÄÇ</li><li><strong>ÊÅ¢Â§ç:</strong> ‰∏ä‰º† .json Êñá‰ª∂„ÄÇ <br><em class="text-red-500">(Ë≠¶Âëä: Ë¶ÜÁõñÂΩìÂâç‰ª™Ë°®Êùø)</em>.</li></ol>`,
                helpAiTitle: "Â¶Ç‰Ωï‰ΩøÁî® AI Âä©Êâã",
                helpAiContent: `<p class="mb-2">AI Âä©ÊâãÊòØ‰∏Ä‰∏™Á¶ªÁ∫øÂ∑•ÂÖ∑„ÄÇ</p><ul class="list-disc list-inside space-y-1"><li>ËØ¢ÈóÆÂ¶Ç‰ΩïËøûÊé•ËäÇÁÇπ„ÄÇ</li><li>ËØ¢ÈóÆ CSV Êàñ JSON Ê†ºÂºè„ÄÇ</li><li>Êó†ÈúÄ‰∫íËÅîÁΩëÔºàÊú¨Âú∞ËøêË°åÔºâ„ÄÇ</li></ul>`,
                tooltipNewComp: "Êñ∞ÁªÑ‰ª∂",
                tooltipConnect: "ËøûÊé•",
                tooltipData: "Êï∞ÊçÆ‰∏éÂØºÂá∫",
                tooltipSettings: "ËÆæÁΩÆ",
                jsonPlaceholder: '‰æãÂ¶Ç { "field": "VARCHAR", "price": 100 }',
                jsonDetectTitle: "ÂÉè10ËøôÊ†∑ÁöÑÂÄºÂèò‰∏∫'Êï∞Â≠ó'",
                jsonRawTitle: "ÂÉè'NVARCHAR'ËøôÊ†∑ÁöÑÂÄºÂèò‰∏∫Á±ªÂûã'NVARCHAR'",
                csvStructIntro: "ÁªÑÂêà CSV ‰ΩøÁî® <strong>ÂàóË∂ÖÈõÜ</strong>„ÄÇÁ¨¨‰∏ÄÂàó <code>rowType</code> ÂÜ≥ÂÆöÂ¶Ç‰ΩïËØªÂèñË°å„ÄÇ",
                csvStructCompTitle: "Â¶ÇÊûú rowType = \"component\"",
                csvStructCompFields: "Â°´ÂÜô: id, title, description, color, x, y, docLink, props",
                csvStructCompNote: "ÁïôÁ©∫ËøûÊé•Âàó„ÄÇ",
                csvStructConnTitle: "Â¶ÇÊûú rowType = \"connection\"",
                csvStructConnFields: "Â°´ÂÜô: id, source, target, label, sourceProp, targetProp",
                csvStructConnNote: "ÁïôÁ©∫ÁªÑ‰ª∂Âàó„ÄÇ",
                csvStructPropsNote: "* 'props' Â∫î‰∏∫ JSON Êï∞ÁªÑÂ≠óÁ¨¶‰∏≤„ÄÇÁ§∫‰æã: <code>\"[{\"\"name\"\":\"\"id\"\",\"\"type\"\":\"\"uuid\"\"}]\"</code>.",
                idLabel: "ID: ",
                contactEmailPlaceholder: "email@example.com",
                contactMsgPlaceholder: "Êàë‰ª¨ÈúÄË¶Å‰ªÄ‰πàÂ∏ÆÂä©Ôºü",
                optSelectPropAny: "-- ÈÄâÊã©Â±ûÊÄß (‰ªªÊÑè) --",
                deleteCompConfirmTitle: "Âà†Èô§ÁªÑ‰ª∂Ôºü",
                deleteCompConfirmDesc: "ËøôÂ∞ÜÂà†Èô§ÁªÑ‰ª∂ÂèäÊâÄÊúâËøûÊé•„ÄÇ",
                noComponentsFound: "Êú™ÊâæÂà∞ÁªÑ‰ª∂",
                hideTips: "ÈöêËóèÊèêÁ§∫",
                showTips: "ÊòæÁ§∫ÊèêÁ§∫",
                dbConnectFail: "Êï∞ÊçÆÂ∫ìËøûÊé•Â§±Ë¥•„ÄÇ",
                helpCollabTitle: "ÂÆûÊó∂Âçè‰ΩúÊåáÂçó",
                helpCollabContent: `
                        <p class="mb-2 font-bold">Â¶Ç‰ΩïËøûÊé•:</p>
                        <ol class="list-decimal list-inside space-y-2 mb-3">
                            <li class="mb-1">
                                <strong>ËÆæÁΩÆÈ°πÁõÆ:</strong><br/>
                                <span class="text-xs text-gray-500 ml-4 block">
                                    1. ËÆøÈóÆ <a href="https://console.firebase.google.com" target="_blank" class="text-blue-500 hover:underline">console.firebase.google.com</a>.<br/>
                                    2. ÁÇπÂáª "Ê∑ªÂä†È°πÁõÆ"„ÄÇ<br/>
                                    3. **ÈáçË¶Å:** ÂâçÂæÄ **Build > Realtime Database > ÂàõÂª∫Êï∞ÊçÆÂ∫ì**„ÄÇ<br/>
                                    4. Âú®È°πÁõÆÊ¶ÇËßà (Â∑¶‰∏äËßí‰∏ªÈ°µÂõæÊ†á), ÁÇπÂáªÂúÜÂΩ¢ÁöÑ <strong>&lt;/&gt; (Web)</strong> ÂõæÊ†á„ÄÇ<br/>
                                    5. Ê≥®ÂÜåÂ∫îÁî®„ÄÇ<br/>
                                    6. ÈÄâÊã© **Use a &lt;script&gt; tag**„ÄÇ
                                </span>
                            </li>
                            <li>
                                <strong>Ëé∑ÂèñÈÖçÁΩÆ:</strong><br/>
                                <span class="text-xs text-gray-500 ml-4 block">
                                    <strong>‰ªÖ</strong> Â§çÂà∂ <code>firebaseConfig</code> ÂØπË±°„ÄÇ<br/>
                                    <div class="bg-gray-100 p-2 rounded mt-1 mb-1 font-mono text-[10px] whitespace-pre overflow-x-auto border border-gray-200 text-gray-700">
{
  apiKey: "AIzaSy...",
  // ...
  appId: "..."
}</div>
                                </span>
                            </li>
                            <li>ÂâçÂæÄ‰æßËæπÊ†èÁöÑ <strong>Êï∞ÊçÆÊ†áÁ≠æ</strong>„ÄÇ</li>
                            <li>Á≤òË¥¥ÈÖçÁΩÆ‰ª£Á†Å„ÄÇ</li>
                            <li>ÁÇπÂáª <strong>ËÆæÁΩÆÈÖçÁΩÆ</strong>„ÄÇ ËæìÂÖ• <strong>‰ªªÊÑèÂêçÁß∞</strong> (‰æãÂ¶Ç "my-project") ‰ª•ÂàõÂª∫ÊàñÂä†ÂÖ•ÊàøÈó¥„ÄÇ</li>
                        </ol>`
            }
        };

        function changeLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('app_lang', lang);
            
            // Helper for fallback
            const t = (key) => {
                if(translations[lang] && translations[lang][key]) return translations[lang][key];
                if(translations['en'] && translations['en'][key]) return translations['en'][key];
                return key;
            };

            // Update Text Content with HTML support
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const val = t(key);
                if (val) el.innerHTML = val;
            });

            // Update Placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                const val = t(key);
                if (val) el.placeholder = val;
            });

            // Update Titles
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                const val = t(key);
                if (val) el.title = val;
            });

            // Update specific inputs that rely on language
            const graphNameInput = document.getElementById('graph-name');
            if (graphNameInput && graphNameInput.value === 'Untitled Graph' && lang !== 'en') {
                 // Optional: don't auto-translate user input, but maybe the default value
            }
            
            // Update Chatbot Intro if empty
             const chatHistory = document.getElementById('chat-history');
             if(chatHistory && chatHistory.children.length === 1) { // Only intro exists
                  const welcomeMsg = t('aiWelcome');
                  chatHistory.innerHTML = `
                    <div class="flex items-start gap-2.5">
                           <div class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center text-xs">ü§ñ</div>
                           <div class="bg-indigo-50 text-indigo-800 p-2 rounded-lg rounded-tl-none max-w-[85%] text-xs shadow-sm">
                               ${welcomeMsg}
                           </div>
                        </div>
                  `;
             }
             const chatInput = document.getElementById('chat-input');
             if(chatInput) chatInput.placeholder = t('aiPlaceholder');
             
             // Update Both Language Selects (Sync)
             const langSelect = document.getElementById('lang-select');
             const langSelectSidebar = document.getElementById('lang-select-sidebar');
             if(langSelect) langSelect.value = lang;
             if(langSelectSidebar) langSelectSidebar.value = lang;
        }

        function resetFirebaseConfig() {
            // Alias used by button - logic replaced by disconnectAndReset
            disconnectAndReset();
        }
        
        function disconnectAndReset() {
             // 1. Clean UI & Variables
             document.getElementById('fb-room-section').classList.add('hidden');
             document.getElementById('fb-config-section').classList.remove('hidden');
             document.getElementById('fb-status').className = "w-2 h-2 rounded-full bg-gray-300";
             updateConnectionBadge(false);
             document.getElementById('active-users-list').innerHTML = '';
             
             // Clear Sensitive Inputs
             const configInput = document.getElementById('fb-config-json');
             if(configInput) configInput.value = '';
             
             const roomInput = document.getElementById('fb-room-id');
             if(roomInput) roomInput.value = '';

             // 2. Detach listeners
             if(currentRoomId && fbDb) {
                  fbDb.ref(`graphs/${currentRoomId}`).off();
                  // Remove presence
                  fbDb.ref(`graphs/${currentRoomId}/users/${myUserId}`).remove().catch(()=>{});
                  fbDb.ref(`graphs/${currentRoomId}/cursors/${myUserId}`).remove().catch(()=>{});
                  
                  // Go offline to kill connection completely
                  try { if(fbDb.goOffline) fbDb.goOffline(); } catch(e){}
             }
             
             currentRoomId = null;
             
             // 3. Clear URL Params (Redirect to Root)
             const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
             window.history.pushState({path:newUrl}, '', newUrl);

             showToast("Disconnected", "info");
        }

        function forceFullDisconnect() {
             if(confirm("Disconnect from room and change API Key configuration?")) {
                  disconnectAndReset();
                  // Also clear the config field to allow pasting new one
                  // But keep it in localStorage in case it was a mistake? Use remove Item if needed.
                  // For now, just show the input field again.
             }
        }
        
        function clearAllAppData() {
            const modal = document.getElementById('clear-data-modal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        function confirmClearAppData() {
             try {
                localStorage.clear();
                sessionStorage.clear();
                
                // Delete IndexedDB
                const req = indexedDB.deleteDatabase(DB_NAME);
                req.onsuccess = () => {
                    window.location.reload();
                };
                req.onerror = () => {
                    console.error("Failed to delete DB");
                    window.location.reload(); // Reload anyway
                };
                req.onblocked = () => {
                    window.location.reload(); // Reload anyway
                };
                
            } catch(e) {
                console.error("Clear Data Failed", e);
                localStorage.clear(); // Fallback
                window.location.reload();
            }
        }

        // --- Firebase Integration ---
        let fbApp, fbDb;
        let activeFirebaseConfigStr = null; // Store active config for sharing
        let currentRoomId = null;
        let myUserId = localStorage.getItem('my_user_id') || ('user_' + Math.random().toString(36).substr(2, 9));
        localStorage.setItem('my_user_id', myUserId);
        
        let myUserColor = localStorage.getItem('my_user_color');
        const userColors = ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#6366F1', '#8B5CF6', '#EC4899'];
        
        // Activity Log for History
        let activityLog = []; // { action, user, color, time, desc }

        function sanitizeForFirebase(obj, type) {
            if (!obj) return null;
            const clean = {};

            if (type === 'node') {
                const allowed = ['id', 'title', 'description', 'color', 'x', 'y', 'props', 'docLink', 'locked', 'fx', 'fy'];
                allowed.forEach(k => { if (obj[k] !== undefined) clean[k] = obj[k]; });

                // Ensure Coords are numbers
                if (clean.x === undefined || isNaN(Number(clean.x))) clean.x = 0;
                else clean.x = Number(clean.x);
                
                if (clean.y === undefined || isNaN(Number(clean.y))) clean.y = 0;
                else clean.y = Number(clean.y);

                // Handle Fixed Positions
                if (clean.fx !== undefined && clean.fx !== null && !isNaN(Number(clean.fx))) clean.fx = Number(clean.fx);
                else delete clean.fx;
                
                if (clean.fy !== undefined && clean.fy !== null && !isNaN(Number(clean.fy))) clean.fy = Number(clean.fy);
                else delete clean.fy;

            } else if (type === 'edge') {
                const allowed = ['id', 'source', 'target', 'label', 'sourceProp', 'targetProp', 'color', 'curveRatio', 'curveDist'];
                allowed.forEach(k => { if (obj[k] !== undefined) clean[k] = obj[k]; });

                // Flatten Source/Target if they are objects
                if (typeof clean.source === 'object' && clean.source?.id) clean.source = clean.source.id;
                if (typeof clean.target === 'object' && clean.target?.id) clean.target = clean.target.id;
                
                // Ensure strings
                if(clean.label == null) clean.label = "";
            }

            // Remove undefined keys to be clean
            Object.keys(clean).forEach(key => clean[key] === undefined && delete clean[key]);
            
            return clean;
        }

        function initFirebase() {
             const input = document.getElementById('fb-config-json');
             if(!input) return;
             
             let configStr = input.value.trim();
             // Simple "demo" hack if empty (won't work for real users but placeholder)
             if(!configStr) {
                 showToast("Please provide Firebase JSON!", "error");
                 return;
             }
             
             try {
                let config;
                try {
                    config = JSON.parse(configStr);
                } catch (e) {
                    try {
                         config = new Function("return " + configStr)();
                    } catch (e2) {
                        throw e; 
                    }
                }

                if (!firebase.apps.length) {
                    fbApp = firebase.initializeApp(config);
                } else {
                    fbApp = firebase.app(); 
                }
                fbDb = firebase.database();
                
                // Track active config for sharing, regardless of persistence
                activeFirebaseConfigStr = configStr;

                // Manage Persistence based on check box
                const remember = document.getElementById('fb-remember').checked;
                if(remember) {
                    localStorage.setItem('fb_config_str', configStr);
                } else {
                    localStorage.removeItem('fb_config_str');
                }
                
                document.getElementById('fb-config-section').classList.add('hidden');
                document.getElementById('fb-room-section').classList.remove('hidden');
                document.getElementById('fb-status').className = "w-2 h-2 rounded-full bg-yellow-400"; // Ready
                
                showToast("Firebase Initialized. Enter Room ID.", "success");
                
                // Check URL for room
                const urlParams = new URLSearchParams(window.location.search);
                const roomParam = urlParams.get('room');
                if(roomParam) {
                    document.getElementById('fb-room-id').value = roomParam;
                    connectToRoom();
                }
                
                // Save config to local? Maybe risky. Let's save just "initialized" state if possible or assume session.
                
             } catch(e) {
                 console.error(e);
                 showToast("Invalid Firebase Config", "error");
             }
        }

        async function connectToRoom() {
            const roomId = document.getElementById('fb-room-id').value.trim();
            if(!roomId) return;
            currentRoomId = roomId;
            
            // Register Self
            const userRef = fbDb.ref(`graphs/${roomId}/users/${myUserId}`);
            
            // Check Creator & Pick Color
            fbDb.ref(`graphs/${roomId}/meta/createdBy`).transaction((currentData) => {
                 if (currentData === null) {
                     return myUserId; // Claim Host
                 }
                 return; // Already has creator
            });

            // Pick Color Transaction
            const roomUsersRef = fbDb.ref(`graphs/${roomId}/users`);
            roomUsersRef.once('value', snapshot => {
                const users = snapshot.val() || {};
                const takenColors = Object.values(users).map(u => u.color);
                
                if (!myUserColor || takenColors.includes(myUserColor)) {
                    // Find first available
                    myUserColor = userColors.find(c => !takenColors.includes(c)) || '#' + Math.floor(Math.random()*16777215).toString(16);
                    localStorage.setItem('my_user_color', myUserColor);
                }
                
                // Set presence
                // Note: The actual name for cursors is updated dynamically, 
                // but for static user list we set a valid initial value.
                // The cursor logic will adjust 'User N' if needed and we can update this record later or let it be.
                // For now, let's use the local storage name.
                const storedName = localStorage.getItem('my_user_name') || ('User ' + myUserId.slice(-4));
                
                userRef.set({
                    name: storedName,
                    color: myUserColor,
                    lastActive: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Disconnect cleanup
                userRef.onDisconnect().remove();

                document.getElementById('fb-status').className = "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_5px_#10B981]";
                updateConnectionBadge(true);
                showToast(`Connected to Room: ${roomId}`, 'success');
                
                checkAndSyncInitialState(roomId);
                startSyncListeners(roomId);
                startCursorTracking(roomId);
            });
        }

        function dropRoom() {
            const roomId = document.getElementById('fb-room-id').value.trim();
            if(!roomId || !fbDb) {
                 showToast("Not connected to a room with admin rights.", "error");
                 return;
            }
            // Open Custom Modal
            const modal = document.getElementById('drop-room-modal');
            if(modal) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                     const content = modal.querySelector('.transform') || modal.firstElementChild; // adjust selector if needed, but our new modal code is standard
                }, 10);
            }
        }
        
        function confirmDropRoom() {
             const roomId = document.getElementById('fb-room-id').value.trim();
             if(!roomId || !fbDb) return;
             
             fbDb.ref(`graphs/${roomId}`).remove()
                .then(() => {
                    showToast("Room Dropped/Cleared", "success");
                    // close modal logic
                    const modal = document.getElementById('drop-room-modal');
                    if(modal) modal.classList.add('hidden');
                })
                .catch(e => {
                    showToast("Error: " + e.message, "error");
                });
        }

        // --- Real-time Cursor Tracking ---
        function startCursorTracking(roomId) {
            const svgEl = document.getElementById('graph-svg');
            const gEl = document.getElementById('zoom-group');
            if(!svgEl || !gEl) return;

            // 1. Throttle Helper
            const throttle = (func, limit) => {
                let lastFunc;
                let lastRan;
                return function() {
                    const context = this;
                    const args = arguments;
                    if (!lastRan) {
                        func.apply(context, args);
                        lastRan = Date.now();
                    } else {
                        clearTimeout(lastFunc);
                        lastFunc = setTimeout(function() {
                            if ((Date.now() - lastRan) >= limit) {
                                func.apply(context, args);
                                lastRan = Date.now();
                            }
                        }, limit - (Date.now() - lastRan));
                    }
                }
            };

            // 2. Mouse Move Listener
            svgEl.addEventListener('mousemove', throttle(function(e) {
                if(!currentRoomId) return;

                // Get SVG Coordinates relative to the zoom group
                // We use D3's pointer to get coordinates relative to the transformed group <g id="zoom-group">
                const [x, y] = d3.pointer(e, gEl);

                // Update Firebase
                const displayName = localStorage.getItem('my_user_name') || ('User ' + myUserId.slice(-4));

                fbDb.ref(`graphs/${currentRoomId}/cursors/${myUserId}`).set({
                    x: Math.round(x),
                    y: Math.round(y),
                    color: myUserColor,
                    name: displayName,
                    ts: firebase.database.ServerValue.TIMESTAMP
                }).catch(() => {}); // Ignore errors (spammy)

            }, 100)); // 100ms throttle = 10fps

            // 3. Render Remote Cursors
            const cursorsRef = fbDb.ref(`graphs/${currentRoomId}/cursors`);
            
            // Remove own cursor on disconnect
            cursorsRef.child(myUserId).onDisconnect().remove();

            // ONE-TIME: Determine my Name Index if I am a "Default User"
            // We do this by looking at existing cursors once on connect.
            cursorsRef.once('value').then(snap => {
                 const existing = snap.val() || {};
                 // If I have a custom name (not starting with "User "), keep it.
                 // If my name is "User 1" (default from skip), we might need to increment.
                 let myName = localStorage.getItem('my_user_name') || "User 1";
                 
                 // Check if it looks like a default name "User N"
                 const isDefaultName = /^User \d+$/.test(myName);
                 
                 if (isDefaultName) {
                     // Get all existing names
                     const textNames = Object.values(existing).map(c => c.name);
                     
                     // If "User 1" is taken (by someone else), find next slot
                     // We only care if *someone else* has my name.
                     // Since I haven't written my cursor yet, I am not in `existing` usually.
                     
                     if (textNames.includes(myName)) {
                         // Find lowest available N
                         let n = 1;
                         while(textNames.includes(`User ${n}`)) {
                             n++;
                         }
                         const newName = `User ${n}`;
                         localStorage.setItem('my_user_name', newName);
                         updateSettingsInputs(); // Sync UI
                         showToast(`Joined as ${newName}`, "info");
                     }
                 }
            });

            cursorsRef.on('value', snap => {
                const cursors = snap.val() || {};
                const now = Date.now();
                
                // Clear old cursors (> 5 min inactive) locally? 
                // Mostly Firebase onDisconnect handles it, but just in case.
                
                // Select Cursors Group (Create if missing)
                let cursorGroup = d3.select(gEl).select(".cursors-layer");
                if (cursorGroup.empty()) {
                    cursorGroup = d3.select(gEl).append("g").attr("class", "cursors-layer").style("pointer-events", "none"); // Ensure clicks pass through
                }
                
                // Ensure Cursors are on top of nodes
                cursorGroup.raise();

                // Prepare Data (exclude self)
                const cursorData = Object.entries(cursors)
                    .filter(([id, data]) => id !== myUserId)
                    .map(([id, data]) => ({ id, ...data }));

                const cursorSelection = cursorGroup.selectAll(".user-cursor").data(cursorData, d => d.id);

                // Exit
                cursorSelection.exit().remove();

                // Enter
                const enter = cursorSelection.enter().append("g")
                    .attr("class", "user-cursor");
                
                // Cursor SVG (Arrow)
                enter.append("path")
                    .attr("d", "M0,0 L8.5,24 L12,14 L22,14 L0,0 Z") // Simple pointer
                    .attr("fill", d => d.color || 'black')
                    .attr("stroke", "white")
                    .attr("stroke-width", 1)
                    .attr("transform", "rotate(-10)");

                // Name Tag
                enter.append("text")
                    .attr("x", 12).attr("y", 24)
                    .attr("font-size", "10px")
                    .attr("font-weight", "bold")
                    .attr("fill", "white")
                    .attr("stroke", "none")
                    .attr("paint-order", "stroke")
                    .attr("stroke-width", 2)
                    .attr("stroke", d => d.color) // Outline text with color
                    .text(d => d.name);

                // Update (Move)
                const merged = enter.merge(cursorSelection);
                
                // Animate transition for smooth movement
                merged.transition().duration(100).ease(d3.easeLinear)
                    .attr("transform", d => `translate(${d.x}, ${d.y})`);
                
                // Update color/text if changed
                merged.select("path").attr("fill", d => d.color);
                merged.select("text").attr("stroke", d => d.color).text(d => d.name);
            });
        }
        
        async function checkAndSyncInitialState(roomId) {
             try {
                const nodesRef = fbDb.ref(`graphs/${roomId}/nodes`);
                const edgesRef = fbDb.ref(`graphs/${roomId}/edges`);
                
                // Fetch both nodes and edges once
                const [nodesSnap, edgesSnap] = await Promise.all([
                    nodesRef.once('value'),
                    edgesRef.once('value')
                ]);

                if (!nodesSnap.exists()) {
                    // REMOTE IS EMPTY -> Upload LOCAL to REMOTE
                    console.log("Remote room is empty. Uploading local graph...");
                    const localNodes = await dbOp('nodes', 'readonly', 'getAll');
                    const localEdges = await dbOp('edges', 'readonly', 'getAll');
                    
                    if (localNodes.length > 0) {
                        const updates = {};
                        localNodes.forEach(n => {
                             const clean = sanitizeForFirebase(n, 'node');
                             if(clean && clean.id) updates[`graphs/${roomId}/nodes/${n.id}`] = clean;
                        });
                        localEdges.forEach(e => {
                             const cleanE = sanitizeForFirebase(e, 'edge');
                             if(cleanE && cleanE.id) updates[`graphs/${roomId}/edges/${e.id}`] = cleanE;
                        });
                        
                        await fbDb.ref().update(updates).catch(e => {
                            console.error("Firebase Update Error during Initial Sync:", e);
                            showToast("Error uploading initial graph: " + e.message, "error");
                        });
                        showToast("Local graph uploaded to room.", "success");
                    }
                } else {
                     // REMOTE HAS DATA -> Download REMOTE to LOCAL (Replace or Merge?)
                     // For better UX on shared link, we should probably REPLACE local with remote
                     // to ensure they see exactly what is shared.
                     console.log("Remote room has data. Downloading to local...");
                     
                     const remoteNodes = nodesSnap.val() || {};
                     const remoteEdges = edgesSnap.val() || {};
                     
                     // 1. Clear Local DB (Safe start)
                     // Or maybe we should prompt? For now, let's assume if joining a room, room is truth.
                     // But let's delete only if we are sure we want to sync.
                     // Let's iterate and PUT all remote nodes into local.
                     
                     const promises = [];
                     
                     // Upsert Nodes
                     Object.values(remoteNodes).forEach(n => {
                         promises.push(dbOp('nodes', 'readwrite', 'put', n, true));
                     });
                     
                     // Upsert Edges
                     Object.values(remoteEdges).forEach(e => {
                         promises.push(dbOp('edges', 'readwrite', 'put', e, true));
                     });
                     
                     await Promise.all(promises);
                     refreshData(true);
                     showToast("Synced with Room Data.", "success");
                }
             } catch(e) {
                 console.error("Initial Sync Check Failed", e);
                 showToast("Initial Sync Failed: " + e.message, "error");
             }
        }
        
        function simpleCipher(text) {
             const key = "GraphViz_Magic_Key_2025";
             let result = "";
             for(let i = 0; i < text.length; i++) {
                 result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
             }
             return result;
        }

        function shareRoomLink() {
            if(!currentRoomId) return;
            const url = new URL(window.location.href);
            url.searchParams.set('room', currentRoomId);
            
            // Get Config from Firebase Instance (Most reliable) or Input
            let configObj = null;
            
            // 1. Try fetching from active Firebase App instance
            try {
                if(fbApp) {
                     configObj = fbApp.options; 
                } else if(firebase.apps.length) {
                     configObj = firebase.app().options;
                }
            } catch(e) {}

            // 2. Fallback to raw string parsing if instance not found (rare)
            if(!configObj) {
                const configStr = activeFirebaseConfigStr || localStorage.getItem('fb_config_str') || document.getElementById('fb-config-json').value;
                if(configStr) {
                    try {
                         // Handle both JSON and JS Object syntax
                         try {
                             configObj = JSON.parse(configStr);
                         } catch(e) {
                             configObj = new Function("return " + configStr)();
                         }
                    } catch(e) {}
                }
            }
            
            if(configObj) {
                try {
                    // Minify JSON
                    const minified = JSON.stringify(configObj);
                    // Encrypt then Encode
                    const encrypted = simpleCipher(minified);
                    const encoded = btoa(encrypted);
                    url.searchParams.set('config', encoded);
                } catch(e) { console.error("Config encoding failed", e); }
            }
            
            navigator.clipboard.writeText(url.toString());
            showToast("Magic Link Copied! (Encrypted Config)", "success");
        }

        function startSyncListeners(roomId) {
            const nodesRef = fbDb.ref(`graphs/${roomId}/nodes`);
            const edgesRef = fbDb.ref(`graphs/${roomId}/edges`);
            const actRef = fbDb.ref(`graphs/${roomId}/activity`);
            const usersRef = fbDb.ref(`graphs/${roomId}/users`);
            const metaRef = fbDb.ref(`graphs/${roomId}/meta`);

            let creatorId = null;
            let lastUsersSnap = null;

            const renderUsers = () => {
                if(!lastUsersSnap) return;

                const list = document.getElementById('active-users-list');
                list.innerHTML = '';
                const users = lastUsersSnap.val() || {};
                
                Object.entries(users).forEach(([uid, u]) => {
                    const isMe = (uid === myUserId);
                    const isHost = (creatorId && uid === creatorId);
                    
                    const d = document.createElement('div');
                    d.className = "px-2 py-0.5 rounded text-[10px] text-white font-bold flex items-center gap-1 shadow-sm border border-black/10 relative transition-transform hover:scale-105 cursor-default";
                    d.style.backgroundColor = u.color;
                    
                    // Base Name
                    let content = u.name;
                    
                    // Host Icon
                    if(isHost) {
                        // Material Crown
                        const crownSvg = `<svg class="w-3.5 h-3.5 text-yellow-500 inline-block mr-1 drop-shadow-sm" fill="currentColor" viewBox="0 0 24 24"><path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11h-14zm14 3c0 .6-.4 1-1 1H6c-.6 0-1-.4-1-1v-1h14v1z"/></svg>`;
                        content = `${crownSvg}<span class="drop-shadow-sm">${u.name}</span>`;
                        d.title = "Host / Room Creator";
                        d.classList.add("ring-1", "ring-yellow-300", "shadow-md");
                    }
                    
                    d.innerHTML = content;

                    // Me Dot
                    if(isMe) {
                         const dot = document.createElement('div');
                         dot.className = "w-2 h-2 rounded-full bg-green-400 border border-white absolute -top-1 -right-1 shadow-sm animate-pulse";
                         d.appendChild(dot);
                         
                         // Host Permissions: Show/Hide Drop Button
                         const dropBtn = document.getElementById('btn-drop-room');
                         if(dropBtn) {
                             if(isHost) {
                                  dropBtn.classList.remove('hidden');
                                  dropBtn.style.display = 'flex'; 
                             } else {
                                  dropBtn.classList.add('hidden');
                                  dropBtn.style.display = 'none';
                             }
                         }

                         // Also update header badge
                         updateUserHeaderBadge(u.name, u.color);
                    }

                    list.appendChild(d);
                });
            };

            metaRef.child('createdBy').on('value', snap => { 
                creatorId = snap.val(); 
                renderUsers();
            });

            // Users Listener
            usersRef.on('value', snap => {
                lastUsersSnap = snap;
                renderUsers();
            });

            // Activity Listener
            actRef.limitToLast(20).on('child_added', snap => {
                const item = snap.val();
                if(item) activityLog.unshift(item); // Add to local log front
            });

            // Nodes Sync
            nodesRef.on('child_added', handleRemoteNode);
            nodesRef.on('child_changed', handleRemoteNode);
            nodesRef.on('child_removed', snap => {
                const id = snap.key;
                dbOp('nodes', 'readwrite', 'delete', id).then(() => refreshData(true));
            });
            
            // Edges Sync
            edgesRef.on('child_added', handleRemoteEdge);
            edgesRef.on('child_changed', handleRemoteEdge);
            edgesRef.on('child_removed', snap => {
                const id = snap.key;
                dbOp('edges', 'readwrite', 'delete', id).then(() => refreshData(true));
            });
            
            // Comments Sync
            const commentsRef = fbDb.ref(`graphs/${roomId}/comments`);
            commentsRef.on('value', snap => {
                const val = snap.val() || {};
                // Convert to array
                commentsCache = Object.values(val);
                renderCommentsOnCanvas();
                if(isCommentsWindowOpen) {
                    renderCommentsList();
                }
                updateUnreadBadge();
            });
        }
        
        async function handleRemoteNode(snap) {
            const val = snap.val();
            if(!val) return;
            // Prevent echo loop?
            // Simple check: compare with local? dbOp handles put.
             await dbOp('nodes', 'readwrite', 'put', val, true);
             refreshData(true); // IsCoolUpdate = true to prevent physics explosion
        }
        
        async function handleRemoteEdge(snap) {
            const val = snap.val();
            if(!val) return;
            await dbOp('edges', 'readwrite', 'put', val, true);
            refreshData(true);
        }

        // --- Comments Logic ---
        let commentsCache = [];
        let isCommentsWindowOpen = false;
        let isCommentsFullHeight = false;
        let commentToDeleteId = null;
        
        // Initialize Click Listener for Adding Comments
        // REMOVED old D3 click listener in favor of Overlay DIV approach
        
        let pendingCommentPos = null;

        function handleCommentOverlayClick(event) {
             if (!isCommentsWindowOpen) return;
             
             // Check if we hit an existing marker using elementsFromPoint
             // This pierces through the overlay layer
             const elements = document.elementsFromPoint(event.clientX, event.clientY);
             // Look for the group or parent group
             const markerEl = elements.find(el => el.classList && (el.classList.contains('comment-marker') || (el.closest && el.closest('.comment-marker'))));
             
             if(markerEl) {
                 const realMarker = markerEl.classList.contains('comment-marker') ? markerEl : markerEl.closest('.comment-marker');
                 const d = d3.select(realMarker).datum();
                 if(d) {
                     openCommentThread(d.id);
                     return;
                 }
             }
             
             // Else Add New
             const gEl = document.getElementById('zoom-group');
             const [x, y] = d3.pointer(event, gEl);
             
             showCommentPopover(x, y, event.clientX, event.clientY);
        }
        
        function showCommentPopover(graphX, graphY, screenX, screenY) {
            const popover = document.getElementById('comment-input-popover');
            const input = document.getElementById('new-comment-text');
            
            pendingCommentPos = { x: graphX, y: graphY };
            
            popover.classList.remove('hidden');
            popover.style.left = Math.min(screenX + 10, window.innerWidth - 270) + 'px';
            popover.style.top = Math.min(screenY + 10, window.innerHeight - 150) + 'px';
            
            input.value = '';
            setTimeout(() => input.focus(), 50);
        }
        
        function hideCommentPopover() {
            document.getElementById('comment-input-popover').classList.add('hidden');
            pendingCommentPos = null;
        }
        
        function submitNewComment() {
             const text = document.getElementById('new-comment-text').value.trim();
             if(!text || !pendingCommentPos) return;
             
             const id = 'cmt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
             const myName = localStorage.getItem('my_user_name') || 'User';
             const myColor = localStorage.getItem('my_user_color') || '#6366F1';
             
             const comment = {
                 id: id,
                 x: Math.round(pendingCommentPos.x),
                 y: Math.round(pendingCommentPos.y),
                 author: myName, // Thread Starter
                 authorColor: myColor,
                 timestamp: Date.now(),
                 resolved: false,
                 messages: [
                     {
                         id: 'msg_' + Date.now(),
                         text: text,
                         author: myName,
                         authorColor: myColor,
                         timestamp: Date.now()
                     }
                 ]
             };
             
             // Save to FB
             if(currentRoomId && fbDb) {
                 fbDb.ref(`graphs/${currentRoomId}/comments/${id}`).set(comment);
                 showToast("Comment Thread Started", "success");
             } else {
                 commentsCache.push(comment);
                 renderCommentsOnCanvas();
                 renderCommentsList();
                 showToast("Local Comment Added", "warning");
             }
             
             hideCommentPopover();
             openCommentThread(id); // Auto open
        }
        
        function promptAddComment(x, y) {
             // Alias for old calls if any
             // But we now use the popover workflow handled in handleCommentOverlayClick
        }

        function toggleCommentsWindow(forceState = null) {
             const win = document.getElementById('comments-window');
             const btn = document.getElementById('comments-toggle-btn');
             const overlay = document.getElementById('comment-overlay');
             
             if(forceState !== null) isCommentsWindowOpen = forceState;
             else isCommentsWindowOpen = !isCommentsWindowOpen;
             
             if(isCommentsWindowOpen) {
                 win.classList.remove('hidden');
                 // Active: Violet BG with WHITE text
                 btn.classList.add('bg-violet-600', 'text-white', 'hover:bg-violet-700', 'hover:text-white');
                 // Remove gray styles if they conflict (though add overrides usually)
                 btn.classList.remove('text-gray-500', 'dark:text-gray-400', 'hover:bg-gray-50');
                 
                 if(overlay) overlay.classList.remove('hidden'); // Show Overlay
                 
                 renderCommentsList();
                 renderCommentsOnCanvas();
             } else {
                 win.classList.add('hidden');
                 // Inactive: Reset to default dirty gray/dark mode styles
                 btn.classList.remove('bg-violet-600', 'text-white', 'hover:bg-violet-700', 'hover:text-white');
                 btn.classList.add('text-gray-500', 'dark:text-gray-400', 'hover:bg-gray-50');
                 
                 if(overlay) overlay.classList.add('hidden'); // Hide Overlay
             }
        }
        
        function toggleCommentsHeight() {
             const win = document.getElementById('comments-window');
             isCommentsFullHeight = !isCommentsFullHeight;
             if(isCommentsFullHeight) {
                 win.style.height = '80vh';
             } else {
                 win.style.height = '350px';
             }
        }
        
        function promptAddComment(x, y) {
             const text = prompt("Enter your comment:");
             if(!text) return;
             
             const id = 'cmt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
             const comment = {
                 id: id,
                 x: Math.round(x),
                 y: Math.round(y),
                 text: text,
                 author: localStorage.getItem('my_user_name') || 'User',
                 authorColor: localStorage.getItem('my_user_color') || '#6366F1',
                 timestamp: Date.now(),
                 resolved: false
             };
             
             // Save to FB
             if(currentRoomId && fbDb) {
                 fbDb.ref(`graphs/${currentRoomId}/comments/${id}`).set(comment);
                 showToast("Comment Added", "success");
             } else {
                 // Offline fallback?
                 commentsCache.push(comment);
                 renderCommentsOnCanvas();
                 renderCommentsList();
                 showToast("Comment added locally (not synced)", "warning");
             }
        }
        
        function resolveComment(id, status) {
            if(currentRoomId && fbDb) {
                 fbDb.ref(`graphs/${currentRoomId}/comments/${id}/resolved`).set(status);
            }
        }
        
        function renderCommentsOnCanvas() {
            const showResolved = document.getElementById('show-resolved-check').checked;
            const visible = commentsCache.filter(c => !c.resolved || showResolved);
            
            const g = d3.select("#zoom-group");
            let layer = g.select(".comments-layer");
            if(layer.empty()) {
                layer = g.append("g").attr("class", "comments-layer");
            }
            // Ensure Comments are on top (even above cursors usually, or below cursors but above nodes)
            layer.raise();
            
            // Join
            const markers = layer.selectAll(".comment-marker").data(visible, d => d.id);
            
            // Exit
            markers.exit().remove();
            
            // Enter
            const enter = markers.enter().append("g")
                .attr("class", "comment-marker cursor-pointer hover:opacity-80 transition")
                .attr("transform", d => `translate(${d.x}, ${d.y})`)
                .on("click", (event, d) => {
                    event.stopPropagation();
                    openCommentThread(d.id);
                });
                
            enter.append("path")
                .attr("d", "M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z")
                .attr("fill", "#ffffff")
                .attr("stroke", d => d.authorColor || '#6366F1')
                .attr("stroke-width", 2)
                .attr("transform", "scale(0.8) translate(-12, -24)"); 
                
            enter.append("circle")
                .attr("r", 10)
                .attr("cx", 0)
                .attr("cy", -12)
                .attr("fill", d => d.authorColor || '#6366F1');

            // User Initials or Icon
            enter.append("text")
                .attr("x", 0)
                .attr("y", -8)
                .attr("text-anchor", "middle")
                .attr("fill", "white")
                .style("font-size", "10px")
                .style("font-weight", "bold")
                .style("pointer-events", "none")
                .text("üí¨");

            // Update Existing position if dragged (future)
            markers.attr("transform", d => `translate(${d.x}, ${d.y})`);
        }





        // --- Comment Logic: Threads, Replies, Editing ---

        function getMyIdentity() {
            return {
                name: localStorage.getItem('my_user_name') || 'User',
                color: localStorage.getItem('my_user_color') || '#6366F1'
            };
        }

        function deleteCommentThread(id) {
             const m = document.getElementById('delete-comment-modal');
             commentToDeleteId = id;
             if(m) {
                 m.classList.remove('hidden');
                 m.classList.add('flex');
             } else {
                 // Fallback if modal missing
                 confirmDeleteComment();
             }
        }

        function confirmDeleteComment() {
             const m = document.getElementById('delete-comment-modal');
             if(m) {
                  m.classList.add('hidden');
                  m.classList.remove('flex');
             }

             if(!commentToDeleteId) return;
             const id = commentToDeleteId;
             commentToDeleteId = null;

             const isRealTime = (currentRoomId && fbDb);
             
             if(isRealTime) {
                fbDb.ref(`graphs/${currentRoomId}/comments/${id}`).remove();
             } else {
                 commentsCache = commentsCache.filter(c => c.id !== id);
                 renderCommentsList();
                 renderCommentsOnCanvas();
                 showToast("Local conversation deleted", "info");
             }
        }
        
        // Backward compatibility alias if needed
        function deleteComment(id) { deleteCommentThread(id); }

        function openCommentThread(id) {
            if(!isCommentsWindowOpen) toggleCommentsWindow(true);
            
            // Wait for render
            setTimeout(() => {
                const el = document.getElementById(`comment-item-${id}`);
                if(el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    el.classList.add('ring-2', 'ring-indigo-500', 'bg-indigo-50');
                    setTimeout(() => el.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-50'), 2000);
                }
            }, 100);
        }

        function submitReply(threadId) {
            const input = document.getElementById(`reply-input-${threadId}`);
            if(!input || !input.value.trim()) return;
            
            const text = input.value.trim();
            const me = getMyIdentity();
            const newMsg = {
                id: 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                text: text,
                author: me.name,
                authorColor: me.color,
                timestamp: Date.now()
            };

            if(currentRoomId && fbDb) {
                 fbDb.ref(`graphs/${currentRoomId}/comments/${threadId}`).once('value').then(snap => {
                     const thread = snap.val();
                     if(thread) {
                         if(!thread.messages) thread.messages = [];
                         // Migration for legacy single-text comments
                         if(!Array.isArray(thread.messages)) thread.messages = [];
                         
                         thread.messages.push(newMsg);
                         fbDb.ref(`graphs/${currentRoomId}/comments/${threadId}/messages`).set(thread.messages);
                     }
                 });
            } else {
                const thread = commentsCache.find(c => c.id === threadId);
                if(thread) {
                    if(!thread.messages) thread.messages = [];
                    thread.messages.push(newMsg);
                    renderCommentsList();
                }
            }
            input.value = '';
        }

        function editMessage(threadId, msgId) {
            const displayEl = document.getElementById(`msg-text-${msgId}`);
            const editEl = document.getElementById(`msg-edit-${msgId}`);
            if(displayEl && editEl) {
                displayEl.classList.add('hidden');
                editEl.classList.remove('hidden');
                const input = editEl.querySelector('textarea');
                if(input) {
                    input.value = displayEl.innerText.trim();
                    input.focus();
                }
            }
        }

        function cancelEdit(msgId) {
            const displayEl = document.getElementById(`msg-text-${msgId}`);
            const editEl = document.getElementById(`msg-edit-${msgId}`);
            if(displayEl && editEl) {
                displayEl.classList.remove('hidden');
                editEl.classList.add('hidden');
            }
        }

        function saveMessageEdit(threadId, msgId) {
             const editEl = document.getElementById(`msg-edit-${msgId}`);
             const input = editEl.querySelector('textarea');
             const newText = input.value.trim();
             if(!newText) return;

             if(currentRoomId && fbDb) {
                 fbDb.ref(`graphs/${currentRoomId}/comments/${threadId}`).once('value').then(snap => {
                     const thread = snap.val();
                     if(thread && thread.messages) {
                         const msgIdx = thread.messages.findIndex(m => m.id === msgId);
                         if(msgIdx !== -1) {
                             fbDb.ref(`graphs/${currentRoomId}/comments/${threadId}/messages/${msgIdx}/text`).set(newText);
                         }
                     }
                 });
             } else {
                 const thread = commentsCache.find(c => c.id === threadId);
                 if(thread && thread.messages) {
                     const msg = thread.messages.find(m => m.id === msgId);
                     if(msg) {
                         msg.text = newText;
                         renderCommentsList();
                     }
                 }
             }
        }

        function renderCommentsList() {
            const list = document.getElementById('comments-list');
            if(!list) return;
            
            const showResolved = document.getElementById('show-resolved-check').checked;
            // Sort by time desc
            const sorted = [...commentsCache].sort((a,b) => b.timestamp - a.timestamp);
            const visible = sorted.filter(c => !c.resolved || showResolved);
            
            if(visible.length === 0) {
                list.innerHTML = `<div class="text-center p-8 text-gray-400 text-xs">No comments found.</div>`;
                return;
            }
            
            const myName = localStorage.getItem('my_user_name') || 'User';

            list.innerHTML = visible.map(c => {
                // Ensure messages array exists (migrate legacy)
                let msgs = c.messages || [];
                if(msgs.length === 0 && c.text) {
                     msgs = [{
                         id: 'legacy_' + c.id,
                         text: c.text,
                         author: c.author,
                         authorColor: c.authorColor,
                         timestamp: c.timestamp
                     }];
                }

                const threadHtml = msgs.map(m => {
                    const isMe = m.author === myName;
                    return `
                        <div class="group flex gap-2 mb-2 ${isMe ? 'flex-row-reverse' : ''}">
                            <!-- Avatar -->
                            <div class="w-5 h-5 rounded-full flex-shrink-0 flex items-center justify-center text-[9px] text-white font-bold shadow-sm" style="background-color: ${m.authorColor}">
                                 ${(m.author||'?').substring(0,1).toUpperCase()}
                            </div>
                            
                            <!-- Bubble -->
                            <div class="max-w-[85%] flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                                <div class="text-[9px] text-gray-400 mb-0.5 px-1">
                                    ${m.author} &bull; ${new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                </div>
                                
                                <!-- Display Mode -->
                                <div id="msg-text-${m.id}" class="p-2 text-xs shadow-sm break-words relative group-hover:shadow-md transition text-left
                                    ${isMe ? 'bg-indigo-600 text-white rounded-l-lg rounded-br-lg' : 'bg-white text-gray-700 border border-gray-200 rounded-r-lg rounded-bl-lg'}">
                                     ${m.text}
                                </div>
                                
                                <!-- Edit Mode (Hidden by default) -->
                                <div id="msg-edit-${m.id}" class="hidden w-full min-w-[150px]">
                                    <textarea class="w-full text-xs p-1 border rounded mb-1 text-black bg-white" rows="2">${m.text}</textarea>
                                    <div class="flex gap-1 justify-end">
                                        <button onclick="cancelEdit('${m.id}')" class="text-[9px] text-gray-500 hover:text-gray-700 bg-gray-100 px-2 py-1 rounded">Cancel</button>
                                        <button onclick="saveMessageEdit('${c.id}', '${m.id}')" class="text-[9px] text-white bg-green-500 hover:bg-green-600 px-2 py-1 rounded">Save</button>
                                    </div>
                                </div>
                                
                                <!-- Actions -->
                                ${isMe ? `
                                    <div class="flex items-center gap-2 mt-0.5 px-1 opacity-0 group-hover:opacity-100 transition">
                                        <button onclick="editMessage('${c.id}', '${m.id}')" class="text-[9px] text-indigo-400 hover:text-indigo-600 underline">Edit</button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                <div id="comment-item-${c.id}" class="p-3 border-b border-gray-100 hover:bg-gray-50/80 transition bg-white ${c.resolved ? 'opacity-50 grayscale' : ''}">
                    <!-- Thread Header -->
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-50">
                        <span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest flex items-center gap-1">
                           <span class="w-2 h-2 rounded-full" style="background-color: ${c.authorColor}"></span> Thread
                        </span>
                        <div class="flex items-center gap-2">
                             ${c.author === myName ? `
                                <button onclick="deleteCommentThread('${c.id}')" title="Delete Thread" class="text-gray-300 hover:text-red-500 transition">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                             ` : ''}
                             <label class="flex items-center gap-1 cursor-pointer">
                                <input type="checkbox" onchange="resolveComment('${c.id}', this.checked)" ${c.resolved ? 'checked' : ''} class="w-3 h-3 text-green-500 rounded border-gray-300 focus:ring-0">
                                <span class="text-[9px] text-gray-400">Resolve</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Conversations -->
                    <div class="mb-3 pl-1 border-l-2 border-gray-100">
                        ${threadHtml}
                    </div>
                    
                    <!-- Reply Area -->
                    ${!c.resolved ? `
                    <div class="relative">
                        <input type="text" id="reply-input-${c.id}" 
                               class="w-full text-xs pl-3 pr-8 py-2 bg-gray-50 border border-gray-200 rounded-full focus:ring-1 focus:ring-indigo-500 focus:bg-white outline-none transition" 
                               placeholder="Reply to thread..." 
                               onkeydown="if(event.key==='Enter') submitReply('${c.id}')">
                        <button onclick="submitReply('${c.id}')" class="absolute right-1 top-1 bottom-1 w-7 flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white rounded-full transition shadow-sm">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                        </button>
                    </div>
                    ` : '<div class="text-[10px] text-gray-400 text-center italic mt-2">Thread resolved</div>'}
                </div>
            `;
            }).join('');
        }
        
        function updateUnreadBadge() {
             const badge = document.getElementById('unread-comments-badge');
             const myName = localStorage.getItem('my_user_name') || 'User';
             const myUserId = localStorage.getItem('my_user_id');
             
             // Count only unresolved threads where I am NOT the author
             // OR (better) threads that have new messages I haven't seen?
             // Simplest interpretation of "user creates new message it should not render red circle":
             // If I created the thread, it's not "unread" for me immediately. 
             // But if someone replies, it becomes unread? 
             // For now: Show badge if there are unresolved threads created by others.
             
             // Check if we have an authorId on comments to be precise, or use name fallback
             const unreadCount = commentsCache.filter(c => {
                 if(c.resolved) return false;
                 // If I created it, don't count it as unread for me (unless someone replied? - future)
                 // NOTE: We used `c.author` (name) locally. Ideally we should use ID.
                 // Let's assume for now if name matches my name, I made it.
                 // Better: check if we stored authorId. We didn't explicitly in promptAddComment...
                 // Let's check promptAddComment logic. It saves author (name) and authorColor.
                 // We should probably rely on name matching for now.
                 return c.author !== myName; 
             }).length;

             if(unreadCount > 0) {
                 badge.classList.remove('hidden');
             } else {
                 badge.classList.add('hidden');
             }
        }

        // --- Custom Tooltip Logic ---
        let tooltipTimeout;
        const tooltipEl = document.getElementById('custom-tooltip');
        
        function showTooltip(text, event) {
            if (!tooltipEl) return;
            clearTimeout(tooltipTimeout);
            tooltipTimeout = setTimeout(() => {
                tooltipEl.textContent = text;
                tooltipEl.style.left = (event.pageX + 10) + 'px';
                tooltipEl.style.top = (event.pageY + 10) + 'px';
                tooltipEl.style.opacity = 1;
            }, 1000); // 1 second delay requested
        }
        
        function hideTooltip() {
            if (!tooltipEl) return;
            clearTimeout(tooltipTimeout);
            tooltipEl.style.opacity = 0;
            setTimeout(() => { if(tooltipEl.style.opacity == 0) { tooltipEl.style.left = '-9999px'; }}, 200);
        }

        // --- Configuration & Constants ---
        const DB_NAME = 'ComponentGraphDB';
        const BOX_HEIGHT = 150; 
        const MIN_BOX_WIDTH = 220; 
        const MAX_PROPS = 20;
        const PROP_LINE_HEIGHT = 15; 
        const ARROW_PULLBACK = 8; 
        const START_GAP = 2; 
        let db;
        let nodes = [];
        let edges = [];
        let selectedNodeIdForModal = null;
        let selectedEdgeIdForModal = null; 

        // Global drag state 
        let dragState = {
            isDragging: false,
            sourceNodeId: null,
            sourcePropName: null
        };
        let tempLink = null; 

        // --- Toast ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const color = type === 'success' ? 'bg-emerald-500' : (type === 'warning' ? 'bg-yellow-500' : 'bg-red-500');
            const icon = type === 'success' 
                ? '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
                : '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';

            const toast = document.createElement('div');
            toast.className = `${color} text-white px-4 py-3 rounded-lg shadow-lg flex items-center transition-opacity duration-300`;
            toast.innerHTML = `${icon}<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        // --- IndexedDB Wrapper ---
        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 2); // Version 2 for Comments
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('nodes')) db.createObjectStore('nodes', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('edges')) db.createObjectStore('edges', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('config')) db.createObjectStore('config', { keyPath: 'key' });
                    // Store comments locally too (for offline/cache)
                    if (!db.objectStoreNames.contains('comments')) db.createObjectStore('comments', { keyPath: 'id' });
                };
                request.onsuccess = (e) => { 
                    db = e.target.result; 
                    loadGraphName(); // Load name on startup
                    showToast("System Ready.", 'success');
                    resolve(); 
                };
                request.onerror = (e) => {
                    showToast("Database connection failed.", 'error');
                    console.error("IndexedDB Error:", e.target.error);
                    reject(e);
                };
            });
        };

        function pushActivity(type, action, name) {
            if(!currentRoomId || !fbDb) return;
            // Debounce "update" to avoid drag spam? For now, raw log.
            const ref = fbDb.ref(`graphs/${currentRoomId}/activity`);
            ref.push({
                user: 'User ' + myUserId.substr(0,4),
                color: myUserColor,
                time: firebase.database.ServerValue.TIMESTAMP,
                action: action, 
                desc: `${action === 'delete' ? 'Deleted' : 'Updated'} ${type} "${name || 'Item'}"`
            });
        }

        const dbOp = (storeName, mode, op, data, fromSync = false) => {
            return new Promise((resolve, reject) => {
                if (!db) { reject("Database not initialized."); return; }
                
                 // --- Firebase Sync --
                 if (currentRoomId && !fromSync && mode === 'readwrite') {
                     let refPath = null;
                     if(storeName === 'nodes') refPath = `graphs/${currentRoomId}/nodes`;
                     if(storeName === 'edges') refPath = `graphs/${currentRoomId}/edges`;
                     
                     if(refPath) {
                         if(op === 'put') {
                             if(data.id) {
                                 // Clean D3 and other internal props using Helper
                                 const cleanData = sanitizeForFirebase(data, storeName === 'nodes' ? 'node' : 'edge');
                                 
                                 if(cleanData) {
                                     fbDb.ref(`${refPath}/${data.id}`).set(cleanData).catch(e => {
                                         console.error("Firebase Write Error:", e);
                                         showToast(`Sync Error: ${e.message}`, "error");
                                     });
                                     
                                     const name = data.title || data.label || 'Item';
                                     pushActivity(storeName, 'update', name);
                                 } else {
                                     console.warn("Skipping sync for invalid data:", data);
                                 }
                             }
                         } else if (op === 'delete') {
                             fbDb.ref(`${refPath}/${data}`).remove().catch(e => {
                                 console.error("Firebase Delete Error:", e);
                                 showToast(`Sync Error: ${e.message}`, "error");
                             });
                             pushActivity(storeName, 'delete', data); 
                         }
                     }
                 }
                
                const tx = db.transaction(storeName, mode);
                const store = tx.objectStore(storeName);
                const request = store[op](data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        };


        // --- Component Window Logic ---
        let isCompWindowOpen = false;
        
        // Expanded State Logic
        window.isCompWindowExpanded = false; // Global for draggable check
        let lastCompWindowRect = null;

        function toggleCompWindowExpand() {
            const win = document.getElementById('component-window');
            const btn = document.getElementById('btn-comp-expand');
            const header = document.getElementById('comp-window-header');
            
            window.isCompWindowExpanded = !window.isCompWindowExpanded;
            
            if (window.isCompWindowExpanded) {
                // Expanding to full height
                
                // Save current top specifically (left is preserved)
                lastCompWindowRect = {
                    top: win.style.top
                };
                
                // Remove max-height constraint
                win.classList.remove('max-h-[50vh]');
                
                // Pin to top and bottom with margins
                win.style.top = '16px';
                win.style.bottom = '16px';
                win.style.height = 'auto'; 
                
                // Disable drag cursor
                header.classList.remove('cursor-move');
                header.classList.add('cursor-default');
                
                // Update Icon to "Collapse" (Inward arrows)
                if(btn) {
                    // Vertical Inward Arrows
                    btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v12m0 0l-4-4m4 4l4-4m6 12V8m0 0l-4 4m4-4l4 4"></path></svg>`;
                    btn.title = "Restore Size";
                    btn.classList.add('text-indigo-600', 'bg-indigo-50'); 
                }

            } else {
                // Restoring
                win.style.bottom = 'auto'; 
                win.style.height = ''; 
                win.classList.add('max-h-[50vh]');
                
                // Restore original top position
                if (lastCompWindowRect && lastCompWindowRect.top) {
                    win.style.top = lastCompWindowRect.top;
                }
                
                // Enable drag cursor
                header.classList.add('cursor-move');
                header.classList.remove('cursor-default');
                
                // Update Icon to "Expand"
                if(btn) {
                    // Vertical Outward Arrows
                    btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l-4-4m4 4l4-4"></path></svg>`;
                    btn.title = "Toggle Full Height";
                    btn.classList.remove('text-indigo-600', 'bg-indigo-50');
                }
            }
        }

        // Map to store user's custom curve offsets for list connections
        const listConnectionOffsets = new Map();

        function toggleComponentWindow(forceState = null) {
            // Prevent toggling if this was a drag operation
            if (typeof globalFabMoved !== 'undefined' && globalFabMoved) return;

            const win = document.getElementById('component-window');
            const fab = document.getElementById('fab-components');
            
            if (forceState !== null) {
                isCompWindowOpen = forceState;
            } else {
                isCompWindowOpen = !isCompWindowOpen;
            }

            // Save state
            localStorage.setItem('compWindowOpen', isCompWindowOpen);
            
            if (isCompWindowOpen) {
                win.classList.remove('hidden');
                // Trigger list update to draw arrows now that window is visible
                setTimeout(updateComponentList, 50);
                
                fab.classList.add('hidden');
                fab.style.display = 'none';
                
                // Ensure initial position is safe if uninitialized
                if (!win.style.left && !win.style.top) {
                     win.style.left = (window.innerWidth - 340) + 'px';
                     win.style.top = '100px';
                     win.style.bottom = 'auto';
                     win.style.right = 'auto';
                }
            } else {
                win.classList.add('hidden');
                fab.classList.remove('hidden');
                fab.style.display = 'flex';
            }
        }
        
        // Extended Draggable Logic for Window (Handle support)
        function makeDraggable(elementId, handleId = null) {
            const el = document.getElementById(elementId);
            if(!el) return;
            const handle = handleId ? document.getElementById(handleId) : el;

            // Load saved position
            const savedPos = localStorage.getItem(`pos_${elementId}`);
            if (savedPos) {
                try {
                    const pos = JSON.parse(savedPos);
                    // Validate position to ensure it's on screen
                    const l = parseInt(pos.left);
                    const t = parseInt(pos.top);
                    
                    if (!isNaN(l) && !isNaN(t) && 
                        l >= -50 && l < window.innerWidth && 
                        t >= -50 && t < window.innerHeight) {
                        
                        el.style.left = pos.left;
                        el.style.top = pos.top;
                        el.style.right = 'auto'; // clearing default right
                        el.style.bottom = 'auto';
                        el.style.transform = 'none';
                    } else {
                        // Invalid/Offscreen - Reset
                        localStorage.removeItem(`pos_${elementId}`);
                    }
                } catch(e) { console.error("Error loading pos", e); }
            }

            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            handle.addEventListener('mousedown', (e) => {
                // Prevent drag if clicking buttons inside handle (e.g. Close X), unless the handle itself IS the button (FAB)
                const clickable = e.target.closest('button');
                if (clickable && clickable !== handle) return;

                // Disable dragging for Component Window if expanded
                if (elementId === 'component-window' && window.isCompWindowExpanded) return;
                
                startX = e.clientX;
                startY = e.clientY;
                
                const rect = el.getBoundingClientRect();
                initialLeft = rect.left;
                initialTop = rect.top;

                // Lock position and clear transform to prevent jumps
                el.style.left = initialLeft + 'px';
                el.style.top = initialTop + 'px';
                el.style.right = 'auto';
                el.style.bottom = 'auto';
                el.style.transform = 'none';

                el.style.transition = 'none';

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                
                isDragging = true;
                globalFabMoved = false; // Reset generic flag
            });

            function onMouseMove(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                el.style.left = `${initialLeft + dx}px`;
                el.style.top = `${initialTop + dy}px`;
                el.style.right = 'auto'; // important override
                el.style.bottom = 'auto';
                
                if (Math.abs(dx) > 3 || Math.abs(dy) > 3) globalFabMoved = true;
            }

            function onMouseUp() {
                isDragging = false;
                el.style.transition = '';
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);

                // Save Position
                localStorage.setItem(`pos_${elementId}`, JSON.stringify({
                    left: el.style.left,
                    top: el.style.top
                }));
            }
        }

        // Tips Logic (Updated)
        function toggleTips() {
            const wrapper = document.getElementById('tips-wrapper');
            const icon = document.getElementById('tips-chevron');
            const text = document.getElementById('tips-header-text');
            
            const isHidden = wrapper.classList.contains('hidden');
            
            if (isHidden) {
                 wrapper.classList.remove('hidden');
                 if(icon) icon.style.transform = 'rotate(0deg)';
                 if(text) text.innerText = "Hide Quick Tips";
            } else {
                 wrapper.classList.add('hidden');
                 if(icon) icon.style.transform = 'rotate(180deg)';
                 if(text) text.innerText = "Show Quick Tips";
            }
        }
        
        function initTips() {
             // Ensure it aligns with default HTML state (Visible)
        }
        
        function setTipsPref(hide) {}
        function refreshTipsState() {}
        
        // --- Drag & Drop (List to Graph/List) with Live Line ---
        let listDragState = {
            active: false,
            sourceId: null,
            startX: 0,
            startY: 0
        };

        function onListDotMouseDown(e, id) {
            e.stopPropagation();
            e.preventDefault(); // Prevent standard text selection/drag behavior
            
            const dot = e.target;
            const rect = dot.getBoundingClientRect();
            const container = document.getElementById('component-list-container');
            const containerRect = container.getBoundingClientRect();
            
            listDragState = {
                active: true,
                sourceId: id,
                startX: rect.left + rect.width/2,
                startY: rect.top + rect.height/2,
                containerRect: containerRect
            };
            
            // Show Overlay
            const overlay = document.getElementById('drag-overlay');
            const path = document.getElementById('drag-line');
            overlay.style.display = 'block';
            path.setAttribute('d', `M ${listDragState.startX} ${listDragState.startY} L ${listDragState.startX} ${listDragState.startY}`);
            
            document.addEventListener('mousemove', onListDotMouseMove);
            document.addEventListener('mouseup', onListDotMouseUp);
        }

        function onListDotMouseMove(e) {
            if (!listDragState.active) return;
            
            // Auto Scroll Logic
            const SCROLL_ZONE = 30; // 30px from top/bottom
            const SCROLL_SPEED = 10;
            const container = document.getElementById('component-list-container');
            const rect = listDragState.containerRect;

            if (e.clientY < rect.top + SCROLL_ZONE) {
               container.scrollBy(0, -SCROLL_SPEED);
            } else if (e.clientY > rect.bottom - SCROLL_ZONE) {
               container.scrollBy(0, SCROLL_SPEED);
            }

            const path = document.getElementById('drag-line');
            
            // Curve calculation for smooth feel
            const sx = listDragState.startX;
            const sy = listDragState.startY;
            const tx = e.clientX;
            const ty = e.clientY;
            
            // Simple Quadratic bezier
            const dx = tx - sx;
            const dy = ty - sy;
            
            // Add some curve
            path.setAttribute('d', `M ${sx} ${sy} Q ${sx + dx/4} ${sy + dy/4 + 50} ${tx} ${ty}`);
        }

        async function onListDotMouseUp(e) {
            if (!listDragState.active) return;
            
            // Hide Overlay
            const overlay = document.getElementById('drag-overlay');
            overlay.style.display = 'none';
            
            document.removeEventListener('mousemove', onListDotMouseMove);
            document.removeEventListener('mouseup', onListDotMouseUp);
            
            listDragState.active = false;

            // Hit Detection
            // We moved the mouse up, check what is under cursor
            // We need to temporarily hide the dot/overlay to peek under? No, overlay is pointer-events-none
            
            const targetEl = document.elementFromPoint(e.clientX, e.clientY);
            
            // Check if we hit a list item dot or list item row
            const listRow = targetEl.closest('.comp-list-item');
            const targetId = listRow ? listRow.getAttribute('data-id') : null;
            
            if (targetId && targetId !== listDragState.sourceId) {
                // Create Connection
                const newEdge = {
                    id: generateId(),
                    source: listDragState.sourceId,
                    target: targetId,
                    label: '',
                    sourceProp: null,
                    targetProp: null,
                    createdAt: new Date().toISOString(),
                    qX: null, qY: null
                };

                try {
                    await dbOp('edges', 'readwrite', 'put', newEdge);
                    showToast("Connected!", "success");
                    refreshData();
                    
                    // Open Modal for this new edge to edit details immediately?
                    // User Request: "after connection connected it should be visible and clickable and when user clicked to this arrow it should open 'Edit dependency' modal"
                    // Standard graph edge is clickable.
                    // If we want to open it IMMEDIATELY:
                    // showConnectionDetails(newEdge); 
                } catch(e) {
                    showToast("Connection failed", "error");
                }
            }
        }

        function updateComponentList() {
            const container = document.getElementById('component-list-container');
            const countEl = document.getElementById('comp-count');
            const svgContainer = document.getElementById('list-connections-svg');
            const searchInput = document.getElementById('comp-search');
            
            // Sync FAB visibility early to ensure neither logic hides it inappropriately
            const fab = document.getElementById('fab-components');
            if (fab) {
                 if(isCompWindowOpen) {
                     fab.classList.add('hidden');
                     fab.style.display = 'none';
                 } else {
                     fab.classList.remove('hidden');
                     fab.style.display = 'flex';
                 }
            }

            if(!container) return;
            
            // Filter nodes if search input exists
            let displayNodes = nodes;
            if (searchInput && searchInput.value) {
                const term = searchInput.value.toLowerCase();
                displayNodes = nodes.filter(n => n.title.toLowerCase().includes(term));
            }

            container.querySelectorAll('.comp-list-item, .list-empty-msg').forEach(e => e.remove());
            if(countEl) countEl.innerText = displayNodes.length;

            if (displayNodes.length === 0) {
                 const msg = document.createElement('div');
                 msg.className = "list-empty-msg text-center text-xs text-gray-400 mt-4 italic";
                 msg.innerHTML = "No components found";
                 container.appendChild(msg);
                 if(svgContainer) svgContainer.innerHTML = '';
                 return;
            }

            // Create Rows
            displayNodes.forEach(node => {
                const el = document.createElement('div');
                // Added ml-16 to create LARGER space for arrows on the left ("gutter")
                el.className = "comp-list-item group flex items-center justify-between p-2 ml-16 rounded-lg bg-gray-50 border border-transparent hover:border-indigo-200 hover:bg-white hover:shadow-sm transition-all relative z-10";
                el.setAttribute('data-id', node.id);
                // Important: Keep ID clean for querySelector later
                el.id = `list-item-${node.id}`; 
                
                // Truncate title
                const title = node.title.length > 20 ? node.title.substring(0, 20) + '...' : node.title;

                el.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden w-full">
                        <div class="w-3 h-3 rounded-full shrink-0 cursor-crosshair hover:scale-125 transition-transform border border-gray-300 relative z-20" 
                             style="background-color: ${node.color}" 
                             onmousedown="onListDotMouseDown(event, '${node.id}')"
                             title="Drag to connect"></div>
                        <span class="text-xs font-medium text-gray-700 group-hover:text-indigo-600 transition truncate cursor-pointer select-none flex-grow" onclick="showNodeDetails(nodes.find(n => n.id === '${node.id}'))" title="${node.title}">${title}</span>
                    </div>
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="event.stopPropagation(); confirmDeleteFromList('${node.id}')" class="p-1 text-gray-400 hover:text-red-500 rounded hover:bg-red-50 transition" title="Delete">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                container.appendChild(el);
            });
            
            // Draw List Connections (The "Arrow Gutter")
            if (svgContainer) {
                svgContainer.innerHTML = '';
                // Wait for layout
                setTimeout(() => {
                    // Update SVG Height to match scrollHeight so arrows are drawn in scrolled areas
                    svgContainer.style.height = container.scrollHeight + 'px';

                    // Get all visible item IDs
                    const visibleIds = displayNodes.map(n => n.id);
                    const containerRect = container.getBoundingClientRect();
                    
                    // --- Advanced Consolidated Styling Logic ---
                    // 1. Consolidate parallel edges (same source-target pair)
                    const uniquePairs = new Map();
                    edges.forEach(edge => {
                         const s = typeof edge.source === 'object' ? edge.source.id : edge.source;
                         const t = typeof edge.target === 'object' ? edge.target.id : edge.target;
                         const key = `${s}->${t}`;
                         if (!uniquePairs.has(key)) {
                             // Store the first one we find as the "leader" for clicking
                             uniquePairs.set(key, edge);
                         }
                    });

                    const processedEdges = Array.from(uniquePairs.values());
                    
                    // 2. Prepare Style Combinations
                    // COLORS: Emerald, Blue, Red, Orange, Purple, Pink, Cyan, Amber, Lime, Teal, Indigo, Rose
                    const COLORS = ['#10B981', '#3B82F6', '#EF4444', '#F59E0B', '#8B5CF6', '#EC4899', '#06B6D4', '#F59E0B', '#84CC16', '#14B8A6', '#6366F1', '#F43F5E'];
                    const STYLES = ['solid', '3,3', '5,5', '10,2']; // Stroke dasharrays
                    const WIDTHS = [2, 2.5, 3]; // Max weight 3
                    
                    // Total unique combos = 12 * 4 * 3 = 144
                    
                    processedEdges.forEach((edge, index) => {
                        const sId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                        const tId = typeof edge.target === 'object' ? edge.target.id : edge.target;
                        
                        // Proceed only if both in list
                        if (visibleIds.includes(sId) && visibleIds.includes(tId)) {
                            const sEl = document.getElementById(`list-item-${sId}`);
                            const tEl = document.getElementById(`list-item-${tId}`);
                            
                            if (sEl && tEl) {
                                
                                const sRect = sEl.getBoundingClientRect();
                                const tRect = tEl.getBoundingClientRect();
                                
                                // but the SVG is absolute top-0 left-0 inside relative container. 
                                // So we need (rect.top - containerRect.top) + container.scrollTop
                                
                                const topOffset = container.scrollTop;
                                const sY = (sRect.top - containerRect.top) + topOffset + sRect.height/2;
                                const tY = (tRect.top - containerRect.top) + topOffset + tRect.height/2;
                                
                                // Generate Style based on stable Index
                                // Cycle through Colors first, then widths, then styles
                                const colorIdx = index % COLORS.length;
                                const widthIdx = Math.floor(index / COLORS.length) % WIDTHS.length;
                                const styleIdx = Math.floor(index / (COLORS.length * WIDTHS.length)) % STYLES.length;
                                
                                const finalColor = COLORS[colorIdx];
                                const finalWidth = WIDTHS[widthIdx];
                                const finalDash = STYLES[styleIdx] === 'solid' ? 'none' : STYLES[styleIdx];

                                // Layout Logic
                                const xDot = 74; 
                                const xCurveBase = 15;
                                
                                // User defined offset (Draggable) + Algorithmic variance
                                const userOffset = listConnectionOffsets.get(edge.id) || 0;
                                const depthVariance = (index % 10) * 2; 
                                const currentCurve = xCurveBase + depthVariance + userOffset;

                                const dPath = `M ${xDot} ${sY} C ${currentCurve} ${sY}, ${currentCurve} ${tY}, ${xDot} ${tY}`;
                                               
                                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                                path.setAttribute("d", dPath);
                                path.setAttribute("class", "cursor-ew-resize hover:stroke-gray-900 transition-colors pointer-events-auto");

                                // DRAG LOGIC FOR ARROWS
                                path.onmousedown = (e) => {
                                     e.stopPropagation();
                                     e.preventDefault();
                                     
                                     const startX = e.clientX;
                                     const initialOffset = listConnectionOffsets.get(edge.id) || 0;
                                     let hasMoved = false;

                                     const onMove = (mv) => {
                                         const dx = mv.clientX - startX;
                                         if (Math.abs(dx) > 3) hasMoved = true;
                                         
                                         // Update Map
                                         const newOffset = initialOffset + dx;
                                         // Limit range to prevent breaking UI (-50 to +150)
                                         const constrainedOffset = Math.max(-20, Math.min(newOffset, 150)); 
                                         listConnectionOffsets.set(edge.id, constrainedOffset);
                                         
                                         // Live Update Path D
                                         const newCurve = xCurveBase + depthVariance + constrainedOffset;
                                         const newD = `M ${xDot} ${sY} C ${newCurve} ${sY}, ${newCurve} ${tY}, ${xDot} ${tY}`;
                                         path.setAttribute("d", newD);
                                     };
                                     
                                     const onUp = () => {
                                         document.removeEventListener('mousemove', onMove);
                                         document.removeEventListener('mouseup', onUp);
                                         
                                         if (!hasMoved) {
                                              showConnectionDetails(edge);
                                         }
                                     };
                                     
                                     document.addEventListener('mousemove', onMove);
                                     document.addEventListener('mouseup', onUp);
                                };

                                path.setAttribute("fill", "none");
                                path.setAttribute("stroke", finalColor);
                                path.setAttribute("stroke-width", finalWidth); 
                                path.setAttribute("stroke-dasharray", finalDash);
                                
                                path.setAttribute("marker-end", "url(#arrowhead-list)"); 
                                
                                // pointer-events:stroke ensures we can click through the empty parts
                                path.style.pointerEvents = "stroke"; 
                                
                                svgContainer.appendChild(path);
                            }
                        }
                    });
                }, 0);
                
                // Add Arrow Def if missing in SVG Container
                if (!document.getElementById('arrowhead-list')) {
                     const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
                     defs.innerHTML = `<marker id="arrowhead-list" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="4" markerHeight="4" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" fill="#94A3B8" /></marker>`;
                     svgContainer.appendChild(defs);
                }
            }
            
            initTips(); 
        }

        function confirmDeleteFromList(id) {
            selectedNodeIdForModal = id;
            const node = nodes.find(n => n.id === id);
            const nameEl = document.getElementById('delete-item-name');
            if (node && nameEl) {
                nameEl.textContent = node.title;
            } else if (nameEl) {
                nameEl.textContent = "";
            }
            document.getElementById('delete-item-modal').classList.remove('hidden');
        }
        
        // --- Utility Logic ---
        function generateId() {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                const uuid = crypto.randomUUID();
                return `nav_${uuid}`;
            }
            // Fallback for insecure contexts (file://)
            return 'nav_' + 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // --- Spinner & Onboarding Logic ---
        function showLoadingSpinner() {
            const el = document.getElementById('global-spinner');
            if(el) el.classList.remove('hidden');
        }

        function hideLoadingSpinner() {
            const el = document.getElementById('global-spinner');
            if(el) el.classList.add('hidden');
        }

        function saveNickname() {
            const input = document.getElementById('welcome-nickname');
            const name = input.value.trim();
            if (name) {
                localStorage.setItem('my_user_name', name);
                document.getElementById('welcome-modal').classList.add('hidden');
                updateSettingsInputs();
            }
        }

        function skipNickname() {
            if(!localStorage.getItem('my_user_name')) {
                 // Default to generic "User 1" initially. 
                 // Will be auto-renamed to User 2, User 3 etc. upon joining a room if taken.
                 localStorage.setItem('my_user_name', "User 1");
            }
            document.getElementById('welcome-modal').classList.add('hidden');
            updateSettingsInputs();
        }
        
        function updateSettingsInputs() {
            const name = localStorage.getItem('my_user_name');
            const color = localStorage.getItem('my_user_color');
            const nameInput = document.getElementById('settings-username');
            const colorInput = document.getElementById('settings-usercolor');
            
            if(nameInput && name) nameInput.value = name;
            if(colorInput && color) colorInput.value = color;
            
            // Also update header badge locally
            updateUserHeaderBadge(name, color);
        }

        function saveSettingsName() {
            const input = document.getElementById('settings-username');
            const name = input.value.trim();
            if(name) {
                localStorage.setItem('my_user_name', name);
                
                // Update Badge Immediately
                updateUserHeaderBadge(name, localStorage.getItem('my_user_color'));

                // If connected, update Firebase Presence immediately
                if(currentRoomId && fbDb && myUserId) {
                     fbDb.ref(`graphs/${currentRoomId}/users/${myUserId}`).update({ name: name }).catch(console.error);
                }
                
                showToast("Name Updated", "success");
            }
        }
        
        function saveSettingsColor(val) {
            localStorage.setItem('my_user_color', val);
            myUserColor = val;
            
            // Update Badge Immediately
            updateUserHeaderBadge(localStorage.getItem('my_user_name'), val);
            
            // If connected, update Firebase Presence immediately
            if(currentRoomId && fbDb && myUserId) {
                 fbDb.ref(`graphs/${currentRoomId}/users/${myUserId}`).update({ color: val }).catch(console.error);
            }
        }

        function checkFirstTimeUser() {
             const name = localStorage.getItem('my_user_name');
             // If no nickname, assumed first time or wiped data
             if(!name) {
                 document.getElementById('welcome-modal').classList.remove('hidden');
             }
        }

        async function refreshData(isCoolUpdate = false) {
            // Only show spinner on full refresh (not cool update)
            if (!isCoolUpdate) showLoadingSpinner();

            try {
                nodes = await dbOp('nodes', 'readonly', 'getAll');
                edges = await dbOp('edges', 'readonly', 'getAll');
                updateSelects();
                updateGraph(nodes, edges, isCoolUpdate);
                updateComponentList();
                updateGlobalLockBtnFromState();
            } catch (error) {
                console.error("Error refreshing data:", error);
                showToast("Failed to load graph data.", 'error');
            } finally {
                if (!isCoolUpdate) {
                     // small delay to smooth out the blink
                     setTimeout(hideLoadingSpinner, 300);
                }
            }
        }

        function adjustPoint(px, py, cx, cy, distance) {
            const dx = px - cx, dy = py - cy;
            const currentDist = Math.sqrt(dx * dx + dy * dy);
            const scale = (currentDist > 0) ? (currentDist + distance) / currentDist : 1;
            return { x: cx + dx * scale, y: cy + dy * scale };
        }

        function getNodeHeight(node) {
            const base = 85; // Header space increased for spacing
            const bottom = 20; // Bottom padding
            const pCount = node.props ? node.props.length : 0;
            // Always show all properties -> Calculate needed height
            const calculated = base + (pCount * PROP_LINE_HEIGHT) + bottom;
            return Math.max(BOX_HEIGHT, calculated);
        }

        function getPropertyY(node, propName) {
            const h = getNodeHeight(node);
            const props = node.props || [];
            const propIndex = props.findIndex(p => p.name === propName);
            if (propIndex >= 0) {
                // (-h/2) is the top edge relative to center 0
                return (-h/2 + 70 + (propIndex * PROP_LINE_HEIGHT)) - 4; 
            }
            return 0; 
        }

        // --- CSV IMPORT / EXPORT LOGIC (Combined) ---

        function openCSVModal() {
            document.getElementById('csv-modal').classList.remove('hidden');
        }

        function openHelpModal() {
            document.getElementById('help-modal').classList.remove('hidden');
        }

        function downloadSingleCSV() {
            // Define all possible columns.
            const graphName = document.getElementById('main-graph-title').value || "combined_graph_data";
            const safeName = graphName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            
            const headers = ["rowType","id","title","description","color","x","y","docLink","props","source","target","label","sourceProp","targetProp"];
            let csvContent = headers.join(",") + "\n";

            // 1. Add Components
            nodes.forEach(n => {
                const propsJson = JSON.stringify(n.props || []).replace(/"/g, '""');
                const row = [
                    "component",
                    n.id,
                    `"${(n.title||"").replace(/"/g, '""')}"`,
                    `"${(n.description||"").replace(/"/g, '""')}"`,
                    n.color,
                    Math.round(n.x),
                    Math.round(n.y),
                    `"${n.docLink||""}"`,
                    `"${propsJson}"`,
                    "", "", "", "", "" // Connection columns empty
                ];
                csvContent += row.join(",") + "\n";
            });

            // 2. Add Connections
            edges.forEach(e => {
                const sId = typeof e.source === 'object' ? e.source.id : e.source;
                const tId = typeof e.target === 'object' ? e.target.id : e.target;
                const row = [
                    "connection",
                    e.id,
                    "", "", "", "", "", "", "", // Component columns empty
                    sId,
                    tId,
                    `"${(e.label||"").replace(/"/g, '""')}"`,
                    e.sourceProp || "",
                    e.targetProp || ""
                ];
                csvContent += row.join(",") + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", `${safeName}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("CSV downloaded!");
        }

        function parseCSVText(text) {
             const lines = text.split('\n').filter(l => l.trim());
            if(lines.length < 1) return [];
            // Remove header
            const headers = lines[0].split(',').map(h => h.replace(/^"|"$/g, '').trim());
            const data = [];
            for(let i=1; i<lines.length; i++) {
                // Regex to split by comma, ignoring commas inside quotes
                const row = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cell => {
                    let c = cell.trim();
                    // Remove surrounding quotes if present
                    if(c.startsWith('"') && c.endsWith('"')) c = c.substring(1, c.length-1);
                    // Unescape double double-quotes to single double-quote
                    return c.replace(/""/g, '"'); 
                });
                
                let obj = {};
                headers.forEach((h, index) => {
                    const cleanH = h.replace(/^"|"$/g, '').trim(); // Ensure header is clean
                    if(index < row.length) {
                         let val = row[index];
                         // Basic type handling (optional but better)
                         if (val === 'null') val = null;
                         if (val === 'undefined') val = undefined;
                         obj[cleanH] = val;
                    }
                });
                data.push(obj);
            }
            return data;
        }

        async function processSingleCSVImport() {
            const fileInput = document.getElementById('upload-single-csv');
            const file = fileInput.files[0];
            if (!file) {
                showToast("Please select a file.", 'warning');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const text = e.target.result;
                    const data = parseCSVText(text);

                    const newNodes = [];
                    const newEdges = [];
                    let rowTypeHeader = Object.keys(data[0])[0]; // Detect if first col is rowType

                    data.forEach(row => {
                        // Check for 'rowType' field
                        if (row.rowType === 'component') {
                             newNodes.push({
                                id: row.id,
                                title: row.title,
                                description: row.description || "",
                                color: row.color || "#6366F1",
                                x: parseFloat(row.x) || 100,
                                y: parseFloat(row.y) || 100,
                                docLink: row.docLink || "",
                                createdAt: new Date().toISOString(),
                                props: row.props ? JSON.parse(row.props) : []
                            });
                        } else if (row.rowType === 'connection') {
                             newEdges.push({
                                id: row.id,
                                source: row.source,
                                target: row.target,
                                label: row.label || "", // Ensure label is imported
                                sourceProp: row.sourceProp || null,
                                targetProp: row.targetProp || null,
                                createdAt: new Date().toISOString(),
                                qX: null, qY: null
                            });
                        }
                    });

                    if (newNodes.length === 0 && newEdges.length === 0) {
                         showToast("No valid rows found. Check 'rowType' column.", 'warning');
                         return;
                    }

                    const tx = db.transaction(['nodes', 'edges'], 'readwrite');
                    // Ensure all imported nodes are LOCKED
                    newNodes = newNodes.map(n => ({...n, locked: true}));

                    await tx.objectStore('nodes').clear();
                    await tx.objectStore('edges').clear();

                    newNodes.forEach(n => tx.objectStore('nodes').put(n));
                    newEdges.forEach(e => tx.objectStore('edges').put(e));

                    tx.oncomplete = () => {
                        showToast(`Imported ${newNodes.length} nodes, ${newEdges.length} edges.`, 'success');
                        refreshData();
                        closeModal('csv');

                        // --- Added: Push to Firebase if connected ---
                        if(currentRoomId && fbDb) {
                             const updates = {};
                             const nodesMap = {};
                             newNodes.forEach(n => {
                                 const clean = sanitizeForFirebase(n, 'node'); 
                                 if(clean) nodesMap[n.id] = clean;
                             });
                             const edgesMap = {};
                             newEdges.forEach(e => {
                                 const clean = sanitizeForFirebase(e, 'edge');
                                 if(clean) edgesMap[e.id] = clean;
                             });
                             
                             // Overwrite the graph nodes/edges
                             fbDb.ref(`graphs/${currentRoomId}/nodes`).set(nodesMap);
                             fbDb.ref(`graphs/${currentRoomId}/edges`).set(edgesMap);
                             pushActivity('system', 'import', 'CSV Restored');
                        }
                    };

                } catch (error) {
                    console.error(error);
                    showToast("Error processing CSV. Check format.", 'error');
                }
            };
            reader.readAsText(file);
        }

        async function processBulkComponentFiles(inputElement) {
            const files = inputElement.files;
            if (!files || files.length === 0) return;

            let createdCount = 0;
            const containerEl = document.getElementById('diagram-container');
            const transform = d3.zoomTransform(svg.node()) || {x:0, y:0, k:1};
            
            // Calculate center of VIEWPORT, not just container
            const xCenter = (containerEl.clientWidth / 2 - transform.x) / transform.k;
            const yCenter = (containerEl.clientHeight / 2 - transform.y) / transform.k;
            
            for (const file of files) {
                try {
                // ... (rest of parsing logic, omitted for brevity, keeping same logic structure but updating X/Y calculation) ...
                    const text = await file.text();
                    let data;
                    try { data = JSON.parse(text); } catch(e) { console.error(e); continue; }

                    const itemsToCreate = [];

                    if (Array.isArray(data)) {
                        itemsToCreate.push(...data); 
                    } else {
                         if (data.title && Array.isArray(data.props)) {
                            itemsToCreate.push(data);
                        } else {
                             const props = [];
                             const entries = Object.entries(data);
                             let count = 0;
                             for (const [key, value] of entries) {
                                 if(count >= 20) break;
                                 let type = 'string';
                                 if (Array.isArray(value)) type = 'array';
                                 else if (typeof value === 'number') type = 'number';
                                 else if (typeof value === 'boolean') type = 'boolean';
                                 else if (typeof value === 'object' && value !== null) type = 'object';
                                 
                                 props.push({ name: key, type: type, color: getDefaultPropColor() });
                                 count++;
                             }
                             
                             itemsToCreate.push({
                                 title: file.name.replace(/\.[^/.]+$/, ""),
                                 props: props
                             });
                        }
                    }

                    for(const item of itemsToCreate) {
                         let finalTitle = item.title;
                         let finalProps = item.props;
                         
                         if (!finalTitle) continue;
                         
                         // Spread them out slightly around center
                         const randomOffset = (Math.random() - 0.5) * 100;

                         const newNode = {
                            id: generateId(),
                            title: finalTitle,
                            description: item.description || "",
                            docLink: "", 
                            createdAt: new Date().toISOString(),
                            color: item.color || getDefaultCompColor(),
                            props: finalProps || [], 
                            x: xCenter + randomOffset, 
                            y: yCenter + randomOffset
                        };

                        if (newNode.props.length > 0 && typeof newNode.props[0] === 'string') {
                             newNode.props = newNode.props.map(s => ({ name: s, type: 'string', color: getDefaultPropColor() }));
                        }
                        
                        await dbOp('nodes', 'readwrite', 'put', newNode);
                        createdCount++;
                    }
                    
                } catch (e) {
                    console.error(`Error parsing ${file.name}`, e);
                }
            }
            
            inputElement.value = ''; 
            if (createdCount > 0) {
                showToast(`Created ${createdCount} components from files.`, 'success');
                refreshData();
                setTimeout(() => simulation.alpha(0.5).restart(), 50);
            } else {
                showToast("No components created. Check files.", 'warning');
            }
        }

        // --- Standard Import / Export / History ---

        async function saveGraphConfig() {
            const name = document.getElementById('graph-name').value;
            try {
                await dbOp('config', 'readwrite', 'put', { key: 'graphName', value: name });
            } catch (e) { console.error("Could not save name", e); }
        }

        async function loadGraphName() {
            try {
                const res = await dbOp('config', 'readonly', 'get', 'graphName');
                if (res) {
                    document.getElementById('graph-name').value = res.value;
                    const titleInput = document.getElementById('main-graph-title');
                    if (titleInput) titleInput.value = res.value;
                }
            } catch (e) { console.error("Could not load name", e); }
        }

        function syncGraphName(val) {
            document.getElementById('graph-name').value = val;
            const titleInput = document.getElementById('main-graph-title');
            if (titleInput && titleInput.value !== val) titleInput.value = val;
            saveGraphConfig();
        }

        function exportJSON() {
            const graphName = document.getElementById('main-graph-title').value || "dashboard";
            const data = { 
                nodes: nodes, 
                edges: edges, 
                meta: { graphName: graphName },
                exportedAt: new Date().toISOString() 
            };
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${graphName}_backup.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("Backup saved to JSON.", 'success');
        }

        function importJSON(inputElement) {
            const file = inputElement.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data.nodes) || !Array.isArray(data.edges)) {
                        throw new Error("Invalid file format");
                    }
                    const tx = db.transaction(['nodes', 'edges'], 'readwrite');
                    await tx.objectStore('nodes').clear();
                    await tx.objectStore('edges').clear();

                    const nodesStore = tx.objectStore('nodes');
                    const edgesStore = tx.objectStore('edges');
                    
                    // Import Graph Name
                    if (data.meta && data.meta.graphName) {
                        try { 
                            const configStore = tx.objectStore('config');
                            configStore.put({ key: 'graphName', value: data.meta.graphName });
                            const titleEl = document.getElementById('main-graph-title');
                            if(titleEl) titleEl.value = data.meta.graphName;
                        } catch(e) {}
                    }

                    // Ensure all imported nodes are LOCKED
                    const lockedNodes = data.nodes.map(n => ({...n, locked: true}));
                    lockedNodes.forEach(n => nodesStore.put(n));

                    data.edges.forEach(edge => {
                        const cleanEdge = { ...edge };
                        if (typeof cleanEdge.source === 'object') cleanEdge.source = cleanEdge.source.id;
                        if (typeof cleanEdge.target === 'object') cleanEdge.target = cleanEdge.target.id;
                        edgesStore.put(cleanEdge);
                    });

                    tx.oncomplete = () => {
                        showToast("Dashboard restored successfully.", 'success');
                        refreshData();

                        // --- Added: Push to Firebase if connected ---
                         if(currentRoomId && fbDb) {
                             const nodesMap = {};
                             lockedNodes.forEach(n => {
                                 const clean = sanitizeForFirebase(n, 'node'); 
                                 if(clean) nodesMap[n.id] = clean;
                             });
                             const edgesMap = {};
                             data.edges.forEach(e => {
                                 const cleanEdge = { ...e };
                                 if (typeof cleanEdge.source === 'object') cleanEdge.source = cleanEdge.source.id;
                                 if (typeof cleanEdge.target === 'object') cleanEdge.target = cleanEdge.target.id;

                                 const clean = sanitizeForFirebase(cleanEdge, 'edge');
                                 if(clean) edgesMap[e.id] = clean;
                             });
                             
                             // Overwrite the graph
                             fbDb.ref(`graphs/${currentRoomId}/nodes`).set(nodesMap);
                             fbDb.ref(`graphs/${currentRoomId}/edges`).set(edgesMap);
                             
                             if(data.meta && data.meta.graphName) {
                                  fbDb.ref(`graphs/${currentRoomId}/meta/graphName`).set(data.meta.graphName);
                             }

                             pushActivity('system', 'import', 'JSON Restored');
                        }
                    };
                } catch (err) {
                    showToast("Failed to import file.", 'error');
                }
            };
            reader.readAsText(file);
            inputElement.value = '';
        }

        function showHistoryModal() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            
            // Shared History
            if(currentRoomId && activityLog.length > 0) {
                 activityLog.forEach(item => {
                     const d = document.createElement('div');
                     d.className = "flex flex-col border-b border-gray-700 pb-2 mb-2 last:border-0";
                     const timeStr = item.time ? new Date(item.time).toLocaleTimeString() : '';
                     d.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-bold px-2 py-0.5 rounded text-white" style="background-color: ${item.color || '#888'}">
                                ${item.user || 'Unknown'}
                            </span>
                            <span class="text-[10px] text-gray-500">${timeStr}</span>
                        </div>
                        <div class="text-sm text-gray-300 mt-1">${item.desc}</div>
                     `;
                     list.appendChild(d);
                 });
                 return;
            }

            let history = [];
            nodes.forEach(n => history.push({ type: 'Component', name: n.title, date: n.createdAt ? new Date(n.createdAt) : new Date(0), desc: 'Created new component' }));
            edges.forEach(e => {
                const s = typeof e.source === 'object' ? e.source.title : (nodes.find(n=>n.id===e.source)?.title || 'Unknown');
                const t = typeof e.target === 'object' ? e.target.title : (nodes.find(n=>n.id===e.target)?.title || 'Unknown');
                history.push({ type: 'Connection', name: `${s} -> ${t}`, date: e.createdAt ? new Date(e.createdAt) : new Date(0), desc: e.label ? `Connected with label "${e.label}"` : 'Connected' });
            });
            history.sort((a, b) => b.date - a.date);

            if(history.length === 0) list.innerHTML = '<div class="p-4 text-center text-gray-500">No history available yet.</div>';
            else history.forEach(item => {
                const el = document.createElement('div');
                el.className = "bg-white p-3 rounded shadow-sm border border-gray-100 flex justify-between items-center";
                const dateStr = item.date.getTime() === 0 ? "Unknown Date" : item.date.toLocaleString();
                el.innerHTML = `<div><span class="text-xs font-bold uppercase tracking-wide ${item.type === 'Component' ? 'text-indigo-500' : 'text-emerald-500'}">${item.type}</span><div class="font-medium text-gray-800">${item.name}</div><div class="text-xs text-gray-500">${item.desc}</div></div><div class="text-xs text-gray-400 text-right">${dateStr}</div>`;
                list.appendChild(el);
            });
            document.getElementById('history-modal').classList.remove('hidden');
        }


        // --- Component Management Functions ---
        
        async function createNewComponent() {
            const titleInput = document.getElementById('node-title');
            const title = titleInput.value.trim();
            if (!title) { showToast("Component Title is required!", 'error'); titleInput.focus(); return; }
            const containerEl = document.getElementById('diagram-container');
            const transform = d3.zoomTransform(svg.node()) || {x:0, y:0, k:1};

            const xCenter = (containerEl.clientWidth / 2 - transform.x) / transform.k;
            const yCenter = (containerEl.clientHeight / 2 - transform.y) / transform.k;

            // Add slight randomness to avoid perfect overlap which physics engine hates
            const randomOffset = (Math.random() - 0.5) * 50;

            const newNode = {
                id: generateId(),
                title: title,
                description: document.getElementById('node-description').value,
                docLink: "", 
                createdAt: new Date().toISOString(),
                color: document.getElementById('node-color').value,
                props: Array.from(document.querySelectorAll('#prop-list .prop-entry')).map(el => ({
                    name: el.querySelector('.p-name').value.trim(),
                    type: el.querySelector('.p-type').value.trim() || 'any',
                    color: el.querySelector('.p-color').value
                })).filter(p => p.name),
                x: xCenter + randomOffset, 
                y: yCenter + randomOffset
            };

            try {
                await dbOp('nodes', 'readwrite', 'put', newNode);
                showToast(`Component '${title}' created.`, 'success');
                resetComponentForm(); // Helper
                refreshData();
                // Gentle restart to integrate new node without explosion
                setTimeout(() => simulation.alpha(0.5).restart(), 50);
            } catch (error) {
                console.error("Create Component Error:", error);
                showToast("Failed to save new component.", 'error');
            }
        }
        
        function resetComponentForm() {
            document.getElementById('node-title').value = '';
            document.getElementById('node-description').value = '';
            document.getElementById('node-color').value = getDefaultCompColor();
            document.getElementById('prop-list').innerHTML = '';
            for(let i=0; i<1; i++) addPropInput(); 
        }

        function fastAddComponent() {
            // Open quick add modal instead of creating immediately
            document.getElementById('quickadd-title').value = 'New Component';
            document.getElementById('quickadd-description').value = '';
            document.getElementById('quickadd-color').value = getDefaultCompColor();
            document.getElementById('quickadd-prop-list').innerHTML = '';
            // Add one default property
            addQuickAddPropInput({name: 'id', type: 'string', color: getDefaultPropColor()});
            document.getElementById('quick-add-modal').classList.remove('hidden');
        }
        
        function addQuickAddPropInput(prop = null) {
            const list = document.getElementById('quickadd-prop-list');
            const div = document.createElement('div');
            div.className = 'prop-entry flex space-x-2 items-center';
            div.innerHTML = `
                <input type="text" class="p-name flex-1 bg-white border border-gray-200 rounded p-1 text-xs" placeholder="Name" value="${prop ? prop.name : ''}">
                <input type="text" class="p-type w-20 bg-white border border-gray-200 rounded p-1 text-xs" placeholder="Type" value="${prop ? prop.type : ''}">
                  <input type="color" class="p-color w-8 h-6 rounded-md cursor-pointer border border-gray-300" value="${prop ? prop.color : getDefaultPropColor()}">
                <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 font-bold px-1">&times;</button>
            `;
            list.appendChild(div);
        }

        async function saveQuickAddComponent() {
            const title = document.getElementById('quickadd-title').value.trim();
            if (!title) {
                showToast("Component Title is required!", 'error');
                return;
            }
            
            const containerEl = document.getElementById('diagram-container');
            const transform = d3.zoomTransform(svg.node()) || {x:0, y:0, k:1};
            
            const xCenter = (containerEl.clientWidth / 2 - transform.x) / transform.k;
            const yCenter = (containerEl.clientHeight / 2 - transform.y) / transform.k;
            // Add slight randomness to avoid physics overlap/explosion
            const randomOffset = (Math.random() - 0.5) * 50;

            const newNode = {
                id: generateId(),
                title: title,
                description: document.getElementById('quickadd-description').value,
                docLink: "", 
                createdAt: new Date().toISOString(),
                color: document.getElementById('quickadd-color').value,
                props: Array.from(document.querySelectorAll('#quickadd-prop-list .prop-entry')).map(el => ({
                    name: el.querySelector('.p-name').value.trim(),
                    type: el.querySelector('.p-type').value.trim() || 'any',
                    color: el.querySelector('.p-color').value
                })).filter(p => p.name),
                x: xCenter + randomOffset, 
                y: yCenter + randomOffset
            };

            try {
                await dbOp('nodes', 'readwrite', 'put', newNode);
                await refreshData();
                closeModal('quickadd');
                showToast(`Component '${title}' created.`, 'success');
                setTimeout(() => simulation.alpha(0.5).restart(), 50);
            } catch (error) {
                showToast("Failed to create component.", 'error');
            }
        }
        
        async function duplicateComponent(nodeId) {
            const originalNode = nodes.find(n => n.id === nodeId);
            if (!originalNode) return;
            const newNode = { ...originalNode, id: generateId(), title: originalNode.title + ' (Copy)', createdAt: new Date().toISOString(), x: originalNode.x + 50, y: originalNode.y + 50, fx: null, fy: null };
            try { await dbOp('nodes', 'readwrite', 'put', newNode); showToast(`Component copied.`, 'success'); refreshData(); } catch (error) { showToast("Failed to duplicate.", 'error'); }
        }

        async function createConnection() {
            const source = document.getElementById('conn-source').value;
            const target = document.getElementById('conn-target').value;
            const label = document.getElementById('conn-label').value.trim();
            if (!source || !target) { showToast("Please select both source and target.", 'error'); return; }
            if (source === target) { showToast("Cannot connect component to itself.", 'error'); return; }

            const newEdge = {
                id: generateId(),
                source, target,
                label: label || '',
                sourceProp: document.getElementById('conn-source-prop').value || null, 
                targetProp: document.getElementById('conn-target-prop').value || null,
                createdAt: new Date().toISOString(),
                qX: null, qY: null
            };
            try { await dbOp('edges', 'readwrite', 'put', newEdge); showToast(`Dependency created.`, 'success'); document.getElementById('conn-label').value = ''; refreshData(); } catch (error) { showToast("Failed to save dependency.", 'error'); }
        }
        
        async function updateConnectionDetails() {
            const id = selectedEdgeIdForModal;
            const edgeToUpdate = edges.find(e => e.id === id); 
            if (!edgeToUpdate) return;
            const sourceId = typeof edgeToUpdate.source === 'object' ? edgeToUpdate.source.id : edgeToUpdate.source;
            const targetId = typeof edgeToUpdate.target === 'object' ? edgeToUpdate.target.id : edgeToUpdate.target;
            const dbPayload = {
                ...edgeToUpdate, id: id, label: document.getElementById('modal-conn-label').value.trim(),
                color: document.getElementById('modal-conn-color').value,
                strokeType: document.getElementById('modal-conn-type').value,
                strokeWidth: parseInt(document.getElementById('modal-conn-width').value) || 2,
                sourceProp: document.getElementById('modal-conn-source-prop').value || null,
                targetProp: document.getElementById('modal-conn-target-prop').value || null,
                source: sourceId, target: targetId
            };
            try { await dbOp('edges', 'readwrite', 'put', dbPayload); showToast(`Dependency updated.`, 'success'); closeModal('conn'); refreshData(); } catch (error) { showToast("Failed to update dependency.", 'error'); }
        }

        async function deleteConnectionConfirmed() {
            try { 
                await dbOp('edges', 'readwrite', 'delete', selectedEdgeIdForModal); 
                showToast(translations[currentLang]?.msgDepDeleted || 'Dependency deleted.', 'success'); 
                closeModal('conn'); 
                refreshData(); 
            } catch (error) { 
                showToast(translations[currentLang]?.msgDepDeleteErr || "Failed to delete dependency.", 'error'); 
            }
        }


        function parseJsonProps(inputId, targetListId, mode = 'detect') {
            const inputEl = document.getElementById(inputId);
            const input = inputEl.value.trim();
            if(!input) return;
            
            try {
                const data = JSON.parse(input);
                
                if (typeof data !== 'object' || data === null || Array.isArray(data)) {
                    showToast(translations[currentLang]?.msgInvalidJson || 'Invalid format. Please paste a JSON object.', 'error');
                    return;
                }
                
                // Check if target list has only one empty entry and clear it
                const targetList = document.getElementById(targetListId);
                if (targetList && targetList.children.length === 1) {
                    const firstEntry = targetList.children[0];
                    const nameInput = firstEntry.querySelector('.p-name');
                    const typeInput = firstEntry.querySelector('.p-type');
                    // Ensure elements exist before checking value
                    if (nameInput && !nameInput.value.trim() && typeInput && !typeInput.value.trim()) {
                        targetList.innerHTML = '';
                    }
                }
                
                // Color Logic: Get last existing color or default to preference
                let lastColor = getDefaultPropColor();
                // Find existing color inputs in the target list
                const existingColors = targetList ? targetList.querySelectorAll('.p-color') : [];
                if (existingColors.length > 0) {
                    lastColor = existingColors[existingColors.length - 1].value;
                }
                
                let count = 0;
                
                const entries = Object.entries(data);

                // Limit check for imports (Max 20)
                if (entries.length > 20) {
                     const msg = (translations[currentLang]?.msgJsonLimit || "Notice: JSON contains properties. Maximum allowed is 20. Truncating...");
                     showToast(msg.replace('{n}', entries.length), 'warning');
                }
                
                for(const [key, value] of entries) {
                    if (count >= 20) break; // Hard limit for import loop

                    let type = 'string';
                    let valToUse = value;

                    if (mode === 'raw') {
                        // "Use Values as Types" Mode
                        if (Array.isArray(value)) type = 'array';
                        else if (value === null) type = 'null';
                        else if (typeof value === 'object') type = 'object';
                        else type = String(value); 
                    } else {
                        // "Detect Types" Mode (Analysis)
                        if (Array.isArray(value)) type = 'array';
                        else if (value === null) type = 'null'; 
                        else if (typeof value === 'number') type = 'number';
                        else if (typeof value === 'boolean') type = 'boolean';
                        else if (typeof value === 'object') type = 'object';
                        else type = 'string';
                    }
                    
                    // Route to correct add function based on target list
                    // Use lastColor for all new properties in this batch (or chain them if we wanted gradient)
                    // Requirement: "last color of latest property that exists" -> We determined this before the loop.
                    
                    if (targetListId === 'modal-prop-list') {
                        addModalPropInput({ name: key, type: type, color: lastColor });
                    } else if (targetListId === 'prop-list') { 
                        addPropInput({ name: key, type: type, color: lastColor });
                    } else if (targetListId === 'quickadd-prop-list') {
                         addQuickAddPropInput({ name: key, type: type, color: lastColor });
                    }
                    count++;
                }
                
                const successMsg = translations[currentLang]?.msgJsonSuccess || "Generated properties from JSON";
                showToast(`${successMsg} (${count})`, 'success');
                inputEl.value = ''; 
            } catch (e) {
                console.error(e);
                showToast(translations[currentLang]?.msgJsonErr || 'JSON Parse Error: Check syntax.', 'error');
            }
        }

        function addPropInput(prop = null) {
            const list = document.getElementById('prop-list');
            if(list.children.length >= MAX_PROPS) return;
            const div = document.createElement('div');
            div.className = 'prop-entry flex space-x-2 items-center';
            div.innerHTML = `
                <input type="text" class="p-name w-1/3 bg-white border border-gray-300 text-xs p-1 rounded" placeholder="Name" value="${prop ? prop.name : ''}">
                <input type="text" class="p-type w-1/3 bg-white border border-gray-300 text-xs p-1 rounded" placeholder="Type" value="${prop ? prop.type : ''}">
                <input type="color" class="p-color w-8 h-6 rounded-md cursor-pointer border border-gray-300" value="${prop && prop.color ? prop.color : getDefaultPropColor()}">
                <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 font-bold px-1">&times;</button>
            `;
            list.appendChild(div);
        }

        function addModalPropInput(prop = null) {
            const list = document.getElementById('modal-prop-list');
            const div = document.createElement('div');
            div.className = 'modal-prop-entry flex space-x-2 items-center';
            div.innerHTML = `
                <input type="text" class="p-name w-1/3 bg-gray-100 border border-gray-200 text-xs p-1 rounded" placeholder="Name" value="${prop ? prop.name : ''}">
                <input type="text" class="p-type w-1/3 bg-gray-100 border border-gray-200 text-xs p-1 rounded" placeholder="Type" value="${prop ? prop.type : ''}">
                <input type="color" class="p-color w-8 h-6 rounded cursor-pointer border border-gray-200" value="${prop ? prop.color : getDefaultPropColor()}">
                <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 font-bold px-2" title="Remove">&times;</button>
            `;
            list.appendChild(div);
        }

        function updatePropSelects(type) {
            const componentId = document.getElementById(`conn-${type}`).value;
            const propSelect = document.getElementById(`conn-${type}-prop`);
            propSelect.innerHTML = '<option value="">-- Select Property (Any) --</option>';
            propSelect.disabled = true;

            if (componentId) {
                const component = nodes.find(n => n.id === componentId);
                if (component && component.props.length > 0) {
                    component.props.forEach(prop => {
                        const option = document.createElement('option');
                        option.value = prop.name;
                        option.textContent = `${prop.name}: ${prop.type}`;
                        propSelect.appendChild(option);
                    });
                    propSelect.disabled = false;
                }
            }
        }
        
        // --- Lock Logic ---
        async function toggleNodeLock(e, d) {
            if (e) {
                e.stopPropagation();
                e.preventDefault();
            }
            
            const newStatus = !d.locked;
            d.locked = newStatus;
            
            // DB Update
            await dbOp('nodes', 'readwrite', 'put', d);
            
            // UI Update (Optimistic)
            const nodeEl = d3.select(`#node-${d.id}`);
            const iconPath = nodeEl.select(".lock-icon-path");
            
            if (newStatus) {
                // Locked (Closed Lock)
                iconPath.attr("d", "M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z");
                showToast("Component Locked", "success");
            } else {
                // Unlocked (Open Lock)
                iconPath.attr("d", "M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h1.9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10z");
                showToast("Component Unlocked", "success");
            }
            
            // Sync Global Button if needed (Optional: Check if all are locked/unlocked?)
            // For now just keep it simple.
            updateGlobalLockBtnFromState();
        }
        
        // Global Lock State
        let isGlobalLocked = false; 

        // Zoom Logic
        function zoomStep(direction) {
            if(!svg) return;
            const currentTransform = d3.zoomTransform(svg.node());
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // Calculate new scale
            const newK = currentTransform.k * direction;
            
            // Constrain if needed (optional)
            if (newK < 0.1 || newK > 10) return;
            
            // Smooth transition
            svg.transition().duration(300).call(
                zoom.transform,
                currentTransform
                    .translate(width/2, height/2)
                    .scale(direction)
                    .translate(-width/2, -height/2)
            );
        }

        async function toggleGlobalLock() {
            // Determine logic: If mixed, default to Lock All. If all locked, Unlock All.
            // Check current status of nodes
            const allNodes = await dbOp('nodes', 'readonly', 'getAll');
            const atLeastOneUnlocked = allNodes.some(n => !n.locked);
            
            let targetLockState = true; 
            if (atLeastOneUnlocked) {
                 targetLockState = true; // Lock everything
                 showToast("Locked All Components", "success");
            } else {
                 targetLockState = false; // Unlock everything
                 showToast("Unlocked All Components", "success");
            }

            // Update All Nodes
            const tx = db.transaction('nodes', 'readwrite');
            const store = tx.objectStore('nodes');
            
            // We can't use await inside a forEach loop with IndexedDB transactions easily if we want to be strict,
            // but dbOp handles single ops. For bulk, let's just do loop. 
            // Better: get all, modify, put back. 
            // Or since we already have allNodes from previous read (assumed fresh enough or we rely on refreshData)
            
            for (const n of allNodes) {
                // Only update if changed
                if (!!n.locked !== targetLockState) {
                    n.locked = targetLockState;
                    await dbOp('nodes', 'readwrite', 'put', n);
                }
            }
            
            // Update UI
            refreshData(); 
            // Button update handled by refresh or explicit call
            updateGlobalLockBtnState(targetLockState);
        }
        
        function updateGlobalLockBtnState(isLocked) {
             const btn = document.getElementById('global-lock-btn');
             const svg = btn.querySelector('svg');
             
             if (isLocked) {
                 // Closed Lock
                 svg.innerHTML = '<path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"></path>';
                 btn.title = "Unlock All Components";
                 // Active: Violet BG with WHITE text
                 btn.classList.add('bg-violet-600', 'text-white', 'hover:bg-violet-700', 'hover:text-white');
                 btn.classList.remove('text-gray-500', 'dark:text-gray-400', 'hover:bg-gray-50');
             } else {
                 // Open Lock
                 svg.innerHTML = '<path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h1.9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10z"></path>';
                 btn.title = "Lock All Components";
                 // Inactive: Dirty Gray
                 btn.classList.remove('bg-violet-600', 'text-white', 'hover:bg-violet-700', 'hover:text-white');
                 btn.classList.add('text-gray-500', 'dark:text-gray-400', 'hover:bg-gray-50');
             }
        }
        
        async function updateGlobalLockBtnFromState() {
             const allNodes = await dbOp('nodes', 'readonly', 'getAll');
             // If ALL are locked -> show Locked state
             // If ANY is unlocked -> show Unlocked state (ready to lock all)
             const allLocked = allNodes.length > 0 && allNodes.every(n => n.locked);
             updateGlobalLockBtnState(allLocked);
        }

        function blinkLock(nodeId) {
            const group = d3.select(`#node-${nodeId} .lock-icon-group`); 
            if (!group.empty()) {
                // Check if already animating to avoid stack
                if(!group.classed("blink-lock")) {
                    group.classed("blink-lock", true);
                    setTimeout(() => group.classed("blink-lock", false), 600);
                    showToast("Locked! Unlock to edit.", "warning");
                }
            }
        }

        function updateSelects() {
            const html = ['<option value="">-- Select --</option>', ...nodes.map(n => `<option value="${n.id}">${n.title}</option>`)].join('');
            document.getElementById('conn-source').innerHTML = html;
            document.getElementById('conn-target').innerHTML = html;
            updatePropSelects('source');
            updatePropSelects('target');
        }

        async function showNodeDetails(d) {
            if (d.locked) {
                blinkLock(d.id);
                return;
            }
            try {
                // Determine if we are just selecting or editing
                selectedNodeIdForModal = d.id;
                
                // Safe access to elements
                const titleEl = document.getElementById('modal-title');
                if(titleEl) titleEl.value = d.title || '';
                
                const colorInput = document.getElementById('modal-color');
                if(colorInput) colorInput.value = d.color || '#6366F1';
                
                const idSpan = document.getElementById('modal-id-span');
                if(idSpan) idSpan.innerText = d.id;
                
                const descEl = document.getElementById('modal-description');
                if(descEl) descEl.value = d.description || '';
                
                // Populate Props in Modal
                const propList = document.getElementById('modal-prop-list');
                if (propList) {
                    propList.innerHTML = '';
                    if (d.props && d.props.length > 0) {
                        d.props.forEach(p => addModalPropInput(p));
                    }
                }
                
                // Populate Connections List in Modal
                const listEl = document.getElementById('modal-connections-list');
                if (listEl) {
                    listEl.innerHTML = '';
                    
                    const relatedEdges = (typeof edges !== 'undefined' ? edges : []).filter(e => {
                        const sId = typeof e.source === 'object' ? e.source.id : e.source;
                        const tId = typeof e.target === 'object' ? e.target.id : e.target;
                        return sId === d.id || tId === d.id;
                    });
                    
                    if (relatedEdges.length === 0) {
                        listEl.innerHTML = `<span class="text-gray-400 italic">${(translations[currentLang] && translations[currentLang].msgNoConn) || 'No connections.'}</span>`;
                    } else {
                        relatedEdges.forEach(e => {
                            const sId = typeof e.source === 'object' ? e.source.id : e.source;
                            const tId = typeof e.target === 'object' ? e.target.id : e.target;
                            const isOutgoing = sId === d.id;
                            const partnerId = isOutgoing ? tId : sId;
                            const partnerNode = nodes.find(n => n.id === partnerId);
                            const partnerName = partnerNode ? partnerNode.title : 'Unknown';
                            
                            const div = document.createElement('div');
                            div.className = 'flex justify-between items-center bg-white p-2 border border-gray-100 rounded shadow-sm';
                            div.innerHTML = `
                                <div class="flex items-center gap-2 overflow-hidden">
                                    <span class="font-bold text-[10px] ${isOutgoing ? 'text-blue-500' : 'text-orange-500'}">${isOutgoing ? '‚Üí To' : '‚Üê From'}</span>
                                    <span class="truncate font-medium text-gray-700" title="${partnerName}">${partnerName}</span>
                                </div>
                                <button class="text-indigo-600 hover:text-indigo-800 text-[10px] underline shrink-0 px-2 py-1">${(translations[currentLang] && translations[currentLang].msgBtnEdit) || 'Edit'}</button>
                            `;
                            div.querySelector('button').onclick = () => { closeModal('node'); showConnectionDetails(e); };
                            listEl.appendChild(div);
                        });
                    }
                }

                // Populate Add Connect Target Select
                const targetSelect = document.getElementById('modal-new-conn-target');
                if (targetSelect) {
                    targetSelect.innerHTML = `<option value="">${(translations[currentLang] && translations[currentLang].optConnectTo) || '-- Connect to --'}</option>`;
                    nodes.filter(n => n.id !== d.id).forEach(n => {
                        const option = document.createElement('option');
                        option.value = n.id;
                        option.innerText = n.title;
                        targetSelect.appendChild(option);
                    });
                }
                
                // Reset Target Prop Select
                if (typeof updateModalTargetProps === 'function') updateModalTargetProps('');
                
                // Populate Add Connect Source Prop Select
                const srcPropSelect = document.getElementById('modal-new-conn-source-prop');
                if (srcPropSelect) {
                    srcPropSelect.innerHTML = `<option value="">${(translations[currentLang] && translations[currentLang].optNoProp) || '(No Prop / Entire Component)'}</option>`;
                    if (d.props) {
                        d.props.forEach(p => {
                            const opt = document.createElement('option');
                            opt.value = p.name;
                            opt.text = p.name;
                            srcPropSelect.appendChild(opt);
                        });
                    }
                }

                const modal = document.getElementById('node-detail-modal');
                if (modal) modal.classList.remove('hidden');
                
            } catch (e) {
                console.error("Error showing node details:", e);
                alert("Error opening details: " + e.message);
            }
        }
        
        function updateModalTargetProps(targetId) {
            const propSelect = document.getElementById('modal-new-conn-target-prop');
            propSelect.innerHTML = `<option value="">${translations[currentLang]?.optNoProp || '(No Prop / Entire Component)'}</option>`;
            propSelect.disabled = true;

            if (targetId) {
                const component = nodes.find(n => n.id === targetId);
                if (component && component.props && component.props.length > 0) {
                    component.props.forEach(prop => {
                        const option = document.createElement('option');
                        option.value = prop.name;
                        option.textContent = `${prop.name}: ${prop.type}`;
                        propSelect.appendChild(option);
                    });
                    propSelect.disabled = false;
                }
            }
        }

        async function addConnectionFromModal() {
            console.group('addConnectionFromModal');
            try {
                const source = selectedNodeIdForModal;
                const targetEl = document.getElementById('modal-new-conn-target');
                const target = targetEl ? targetEl.value : null;
                const sourceProp = document.getElementById('modal-new-conn-source-prop').value || null;
                const targetProp = document.getElementById('modal-new-conn-target-prop').value || null;

                console.log('Inputs:', { source, target, sourceProp, targetProp });

                if(!target) { 
                    console.warn('No target selected');
                    showToast(translations[currentLang]?.msgSelectTarget || "Please select a target component.", "error");
                    return; 
                }
                if(source === target) { 
                    console.warn('Source equals target');
                    showToast(translations[currentLang]?.msgSelfConnect || "Cannot connect component to itself.", "error");
                    return; 
                }
                
                const newEdge = {
                    id: generateId(),
                    source: source,
                    target: target,
                    label: null, // Use null to indicate default fallback
                    sourceProp: sourceProp,
                    targetProp: targetProp,
                    createdAt: new Date().toISOString(),
                    qX: null, qY: null
                };
                
                console.log('Generated Edge:', newEdge);
                
                console.time('dbPut');
                await dbOp('edges', 'readwrite', 'put', newEdge);
                console.timeEnd('dbPut');
                console.log('Edge saved to IndexedDB');

                console.time('refreshData');
                await refreshData();
                console.timeEnd('refreshData');
                console.log('Data refreshed. Total Edges:', edges.length);

                showToast(translations[currentLang]?.msgConnCreated || `Connection created successfully!`, 'success');
                
                // Re-open modal with updated data to show the new connection
                const freshNode = nodes.find(n => n.id === selectedNodeIdForModal);
                console.log('Reloading modal for node:', freshNode);
                
                if (freshNode) {
                    showNodeDetails(freshNode);
                    console.log('Modal updated via showNodeDetails');
                } else {
                    console.error('Could not find node after refresh:', selectedNodeIdForModal);
                }
            } catch (error) { 
                console.error('Connection creation error:', error);
                showToast(translations[currentLang]?.msgConnSaveErr || "Failed to save connection.", 'error');
            } finally {
                console.groupEnd();
            }
        }

        function showConnectionDetails(d) {
            selectedEdgeIdForModal = d.id;
            const sourceNode = d.source;
            const targetNode = d.target;
            
            document.getElementById('modal-conn-id').innerText = (translations[currentLang]?.idLabel || 'ID: ') + d.id;
            document.getElementById('modal-conn-source-name').innerText = sourceNode.title;
            document.getElementById('modal-conn-target-name').innerText = targetNode.title;
            document.getElementById('modal-conn-label').value = d.label || '';
            document.getElementById('modal-conn-color').value = d.color || '#9CA3AF';
            document.getElementById('modal-conn-type').value = d.strokeType || 'solid';
            document.getElementById('modal-conn-width').value = d.strokeWidth || 2;

            const srcPropSelect = document.getElementById('modal-conn-source-prop');
            const tgtPropSelect = document.getElementById('modal-conn-target-prop');

            const optAny = translations[currentLang]?.optSelectPropAny || '-- Select Property (Any) --';
            const srcOptions = [`<option value="">${optAny}</option>`, 
                ...(sourceNode.props || []).map(p => `<option value="${p.name}">${p.name}: ${p.type}</option>`)
            ].join('');
            
            const tgtOptions = [`<option value="">${optAny}</option>`, 
                ...(targetNode.props || []).map(p => `<option value="${p.name}">${p.name}: ${p.type}</option>`)
            ].join('');

            srcPropSelect.innerHTML = srcOptions;
            tgtPropSelect.innerHTML = tgtOptions;
            srcPropSelect.value = d.sourceProp || '';
            tgtPropSelect.value = d.targetProp || '';
            
            document.getElementById('connection-detail-modal').classList.remove('hidden');
        }

        function closeModal(type) { 
            if (type === 'node') document.getElementById('node-detail-modal').classList.add('hidden'); 
            else if (type === 'conn') document.getElementById('connection-detail-modal').classList.add('hidden');
            else if (type === 'reset') document.getElementById('reset-confirmation-modal').classList.add('hidden');
            else if (type === 'clearData') {
                const m = document.getElementById('clear-data-modal');
                if(m) {
                     m.classList.add('hidden');
                     m.classList.remove('flex');
                }
            }
            else if (type === 'deleteComment') {
                const m = document.getElementById('delete-comment-modal');
                if(m) {
                     m.classList.add('hidden');
                     m.classList.remove('flex');
                }
            }
            else if (type === 'deleteItem') document.getElementById('delete-item-modal').classList.add('hidden');
            else if (type === 'history') document.getElementById('history-modal').classList.add('hidden');
            else if (type === 'csv') document.getElementById('csv-modal').classList.add('hidden');
            else if (type === 'help') document.getElementById('help-modal').classList.add('hidden');
            else if (type === 'contact') document.getElementById('contact-modal').classList.add('hidden');
            else if (type === 'quickadd') document.getElementById('quick-add-modal').classList.add('hidden');
        }

        // --- Color Preferences ---
        function initColorPrefs() {
            const compBg = localStorage.getItem('pref_comp_bg') || '#6366F1';
            const propText = localStorage.getItem('pref_prop_text') || '#FFFFFF';
            
            const bgInput = document.getElementById('pref-comp-bg');
            if(bgInput) bgInput.value = compBg;
            
            const propInput = document.getElementById('pref-prop-text');
            if(propInput) propInput.value = propText;
            
            // Apply to Create Component form
            const nodeColorInput = document.getElementById('node-color');
            if(nodeColorInput) nodeColorInput.value = compBg;
        }

        function saveColorPref(type, value) {
            if(type === 'comp-bg') {
                 localStorage.setItem('pref_comp_bg', value);
                 const nodeColorInput = document.getElementById('node-color');
                 if(nodeColorInput) nodeColorInput.value = value;
            }
            else if(type === 'prop-text') localStorage.setItem('pref_prop_text', value);
            showToast("Preference saved", 'success');
        }

        function getDefaultCompColor() {
            return localStorage.getItem('pref_comp_bg') || '#6366F1';
        }

        function getDefaultPropColor() {
            return localStorage.getItem('pref_prop_text') || '#FFFFFF';
        }

        // --- Theme Logic ---
        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('dark');
            const isDark = body.classList.contains('dark');
            localStorage.setItem('app_theme', isDark ? 'dark' : 'light');
            const icon = isDark ? '‚òÄÔ∏è' : 'üåô';
            document.getElementById('theme-icon').innerText = icon;
            const sidebarIcon = document.getElementById('theme-icon-sidebar');
            if(sidebarIcon) sidebarIcon.innerText = icon;
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('app_theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark');
                const icon = '‚òÄÔ∏è';
                document.getElementById('theme-icon').innerText = icon;
                const sidebarIcon = document.getElementById('theme-icon-sidebar');
                if(sidebarIcon) sidebarIcon.innerText = icon;
            }
        }

        // --- Contact Logic ---
        function openContactModal() {
            document.getElementById('contact-modal').classList.remove('hidden');
        }

        function sendContactMessage() {
            const email = document.getElementById('contact-email').value;
            const msg = document.getElementById('contact-msg').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if(!email || !msg) {
                showToast(translations[currentLang]?.msgFillFields || "Please fill in all fields", "warning");
                return;
            }
            if(!emailRegex.test(email)) {
                showToast(translations[currentLang]?.msgValidEmail || "Please enter a valid email address", "warning");
                return;
            }
            
            // Generate mailto link
            const subject = encodeURIComponent("Contact from Graph Editor");
            const body = encodeURIComponent(`From: ${email}\n\nMessage:\n${msg}`);
            window.location.href = `mailto:magas.sergio@gmail.com?subject=${subject}&body=${body}`;
            
            // Simulation UI feedback
            setTimeout(() => {
                const sentMsg = translations[currentLang]?.msgSent || "Opening email client...";
                showToast(sentMsg, "success");
                document.getElementById('contact-email').value = "";
                document.getElementById('contact-msg').value = "";
                closeModal('contact');
            }, 1000);
        }


        async function saveModalProperties() {
            const id = selectedNodeIdForModal;
            const nodeToUpdate = nodes.find(n => n.id === id);
            if (!nodeToUpdate) return;

            // Gather Properties
            const newProps = Array.from(document.querySelectorAll('#modal-prop-list .modal-prop-entry')).map(el => ({
                name: el.querySelector('.p-name').value.trim(),
                type: el.querySelector('.p-type').value.trim() || 'any',
                color: el.querySelector('.p-color').value
            })).filter(p => p.name);
            
            nodeToUpdate.props = newProps;

            try {
                await dbOp('nodes', 'readwrite', 'put', nodeToUpdate);
                showToast(`Properties saved.`, 'success');
                await refreshData();
                
                // Update the "Source Prop" dropdown in the modal
                const srcPropSelect = document.getElementById('modal-new-conn-source-prop');
                if (srcPropSelect) {
                    const currentVal = srcPropSelect.value;
                    srcPropSelect.innerHTML = '<option value="">(No Prop / Entire Component)</option>';
                    if (nodeToUpdate.props) {
                        nodeToUpdate.props.forEach(p => {
                            const opt = document.createElement('option');
                            opt.value = p.name;
                            opt.text = p.name;
                            srcPropSelect.appendChild(opt);
                        });
                    }
                    if (currentVal && nodeToUpdate.props.some(p => p.name === currentVal)) {
                        srcPropSelect.value = currentVal;
                    }
                }
            } catch(e) {
                console.error(e);
                showToast("Failed to save properties.", 'error');
            }
        }

        async function updateComponentDetails() {
            const id = selectedNodeIdForModal;
            const title = document.getElementById('modal-title').value.trim();
            if (!title) return;

            const nodeToUpdate = nodes.find(n => n.id === id);
            if (nodeToUpdate) {
                nodeToUpdate.title = title;
                nodeToUpdate.description = document.getElementById('modal-description').value.trim();
                const colorInput = document.getElementById('modal-color');
                if(colorInput) nodeToUpdate.color = colorInput.value;

                // Save Props from Modal
                nodeToUpdate.props = Array.from(document.querySelectorAll('#modal-prop-list .modal-prop-entry')).map(el => ({
                    name: el.querySelector('.p-name').value.trim(),
                    type: el.querySelector('.p-type').value.trim() || 'any',
                    color: el.querySelector('.p-color').value
                })).filter(p => p.name);

                try {
                    await dbOp('nodes', 'readwrite', 'put', nodeToUpdate);
                    showToast(`Component updated.`, 'success');
                    closeModal('node');
                    refreshData();
                } catch (error) {
                    showToast("Failed to update.", 'error');
                }
            }
        }

        async function deleteComponentConfirmed() {
            try {
                await dbOp('nodes', 'readwrite', 'delete', selectedNodeIdForModal);
                const edgesToDelete = edges.filter(e => e.source.id === selectedNodeIdForModal || e.target.id === selectedNodeIdForModal);
                for (const edge of edgesToDelete) {
                    await dbOp('edges', 'readwrite', 'delete', edge.id);
                }
                showToast(`Component deleted.`, 'success');
                closeModal('node');
                refreshData();
            } catch (error) {
                showToast("Failed to delete.", 'error');
            }
        }

        async function deleteFromListConfirmed() {
            try {
                await dbOp('nodes', 'readwrite', 'delete', selectedNodeIdForModal);
                const edgesToDelete = edges.filter(e => e.source.id === selectedNodeIdForModal || e.target.id === selectedNodeIdForModal);
                for (const edge of edgesToDelete) {
                    await dbOp('edges', 'readwrite', 'delete', edge.id);
                }
                showToast(translations[currentLang].componentDeleted || "Component deleted.", 'success');
                closeModal('deleteItem');
                refreshData();
            } catch (error) {
                console.error(error);
                showToast(translations[currentLang].deleteFailed || "Failed to delete.", 'error');
            }
        }
        
        let isSidebarOpen = true;

        function updateUserHeaderBadge(name, color) {
             const badgeEl = document.getElementById('user-badge-circle');
             if(!badgeEl) return;
             
             // First Letter
             badgeEl.innerText = (name || '?').charAt(0).toUpperCase();
             badgeEl.style.backgroundColor = color || '#ccc';
             
             // Tooltip update
             const badgeContainer = document.getElementById('user-badge');
             if(badgeContainer) badgeContainer.title = `${name} (Click to Edit)`;
        }

        function switchTab(tabId) {
            // Hide all contents
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('animation-fade-in'); 
            });
            
            const target = document.getElementById(`tab-${tabId}`);
            if(target) {
                target.classList.remove('hidden');
                setTimeout(() => target.classList.add('animation-fade-in'), 10);
            }

            // Reset buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.className = 'nav-btn p-2 rounded-xl text-gray-400 hover:bg-gray-50 hover:text-gray-600 transition relative group';
            });

            // Activate button
            const btn = document.getElementById(`btn-tab-${tabId}`);
            if(btn) {
                if(tabId === 'create') btn.className = 'nav-btn p-2 rounded-xl hover:bg-indigo-50 text-indigo-600 transition relative group active-tab';
                else if(tabId === 'connect') btn.className = 'nav-btn p-2 rounded-xl hover:bg-emerald-50 text-emerald-600 transition relative group active-tab';
                else if(tabId === 'data') btn.className = 'nav-btn p-2 rounded-xl hover:bg-blue-50 text-blue-600 transition relative group active-tab';
                else if(tabId === 'settings') btn.className = 'nav-btn p-2 rounded-xl hover:bg-gray-100 text-gray-700 transition relative group active-tab';
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const nav = document.getElementById('sidebar-nav');
            const content = document.getElementById('sidebar-content');
            const icon = document.getElementById('sidebar-icon');
            
            // Footer elements
            const footer = document.getElementById('sidebar-footer');
            const contactBtn = document.getElementById('contact-btn');
            const contactIcon = document.getElementById('contact-icon');
            const contactText = document.getElementById('contact-btn-text');
            const copyrightWrapper = document.getElementById('footer-copyright-wrapper');
            const copyright = document.getElementById('footer-copyright');

            isSidebarOpen = !isSidebarOpen;
            
            if (isSidebarOpen) {
                // Open
                sidebar.classList.remove('w-16');
                sidebar.classList.add('w-80');
                if(nav) nav.style.opacity = '1';
                if(content) {
                    content.style.opacity = '1';
                    content.style.display = 'block';
                }
                icon.style.transform = 'rotate(180deg)'; // Point Left (Close)
                
                // Footer Open State
                if(footer) footer.classList.replace('p-2', 'p-4');
                
                // Reset Contact Button (White Box Style)
                if(contactBtn) {
                    contactBtn.classList.add('bg-white', 'border', 'border-gray-200', 'shadow-sm', 'hover:bg-gray-100', 'gap-2');
                    contactBtn.classList.remove('hover:bg-indigo-50', 'text-indigo-500'); // Remove folded hover
                }
                if(contactIcon) {
                    contactIcon.classList.replace('text-indigo-500', 'text-gray-600');
                }
                if(contactText) {
                    contactText.style.display = 'block';
                    setTimeout(() => {
                        contactText.style.opacity = '1';
                        contactText.style.width = 'auto';
                        contactText.style.marginLeft = '0.5rem'; 
                    }, 10);
                }
                
                // Reset Copyright (Horizontal)
                if(copyrightWrapper) {
                    copyrightWrapper.style.height = 'auto';
                    copyrightWrapper.style.marginTop = '0';
                    copyrightWrapper.style.display = 'block';
                }
                if(copyright) {
                    copyright.style.width = 'auto';
                    copyright.style.writingMode = 'horizontal-tb';
                    copyright.style.transform = 'none';
                    copyright.style.whiteSpace = 'nowrap';
                }

            } else {
                // Close
                sidebar.classList.remove('w-80');
                sidebar.classList.add('w-16');
                if(nav) nav.style.opacity = '0';
                if(content) {
                    content.style.opacity = '0';
                    setTimeout(() => { content.style.display = 'none'; }, 200);
                }
                icon.style.transform = 'rotate(0deg)'; // Point Right (Open)
                
                // Footer Closed State
                if(footer) footer.classList.replace('p-4', 'p-2');
                
                // Styled Contact Button (Clean Icon Style)
                if(contactBtn) {
                    contactBtn.classList.remove('bg-white', 'border', 'border-gray-200', 'shadow-sm', 'hover:bg-gray-100', 'gap-2');
                    contactBtn.classList.add('hover:bg-indigo-50'); // Violet hover
                }
                if(contactIcon) {
                    contactIcon.classList.replace('text-gray-600', 'text-indigo-500');
                }
                if(contactText) {
                    contactText.style.width = '0';
                    contactText.style.marginLeft = '0';
                    contactText.style.display = 'none'; // Fix alignment
                    contactText.style.opacity = '0';
                }
                
                // Footer Copyright: Folded State (Rotated)
                if(copyrightWrapper && copyright) {
                    // Start hidden to avoid jump
                    copyrightWrapper.style.transition = 'opacity 0.2s';
                    copyrightWrapper.style.opacity = '0';
                    
                    setTimeout(() => {
                        copyrightWrapper.style.display = 'flex';
                        copyrightWrapper.style.justifyContent = 'center';
                        copyrightWrapper.style.marginTop = 'auto'; // Push to bottom
                        copyrightWrapper.style.paddingBottom = '1.5rem';
                        
                        copyright.style.width = 'max-content';
                        copyright.style.writingMode = 'vertical-rl';
                        copyright.style.transform = 'rotate(180deg)';
                        copyright.style.whiteSpace = 'nowrap';
                        
                        // Show
                        copyrightWrapper.style.opacity = '1';
                    }, 300); // Wait for sidebar transition
                }
            }
            // Re-center graph slightly
            setTimeout(() => { simulation.alpha(0.1).restart(); }, 300);
        }

        function toggleDataManagement() {
            const section = document.getElementById('data-mgmt-section');
            const chevron = document.getElementById('data-mgmt-chevron');
            if(!section || !chevron) return;

            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                // Rotate Chevron Down (0deg)
                chevron.classList.remove('-rotate-90'); 
            } else {
                section.classList.add('hidden');
                chevron.classList.add('-rotate-90');
            }
        }

        function updateConnectionBadge(isLive) {
            const badge = document.getElementById('connection-status-badge');
            const dot = document.getElementById('conn-status-dot');
            const text = document.getElementById('conn-status-text');

            if(!badge || !dot || !text) return;
            
            // Ensure visible
            if(badge.classList.contains('hidden')) badge.classList.remove('hidden');
            if(!badge.classList.contains('flex')) badge.classList.add('flex'); // mobile handling?

            if(isLive) {
                // Live Style: Green without border, White Text
                dot.className = "w-1.5 h-1.5 rounded-full bg-white shadow-sm animate-pulse";
                text.innerText = translations[currentLang]?.liveMode || "Live Sync";
                
                badge.className = "hidden md:flex items-center gap-1.5 px-2 rounded-lg text-[10px] font-medium transition select-none cursor-pointer bg-emerald-500 text-white hover:bg-emerald-600";
            } else {
                // Local Style: Violet, White Text, Green Dot (as requested)
                dot.className = "w-1.5 h-1.5 rounded-full bg-green-400 shadow-sm";
                text.innerText = translations[currentLang]?.localMode || "Local Mode";
                
                badge.className = "hidden md:flex items-center gap-1.5 px-2 rounded-lg text-[10px] font-medium transition select-none cursor-pointer bg-violet-600 text-white hover:bg-violet-700";
            }
        }

        function downloadImage() {
            const hint = document.getElementById('drag-hint');
            const graphName = document.getElementById('main-graph-title').value || "graph";

            // Temp hide helper text
            if(hint) hint.style.visibility = 'hidden';
            
            // Capture Diagram Container
            html2canvas(document.getElementById('diagram-container'), { backgroundColor: '#ffffff', scale: 2 })
            .then(canvas => {
                try {
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png');
                    link.download = `${graphName.replace(/\s+/g, '_')}_export.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast('Image downloaded!', 'success');
                } catch(e) {
                     showToast("Failed to save image.", 'error');
                }
            })
            .catch(err => {
                showToast("Image generation failed.", 'error');
            })
            .finally(() => {
                if(hint) hint.style.visibility = 'visible';
            });
        }
        
        async function resetDashboard() {
            document.getElementById('reset-confirmation-modal').classList.remove('hidden');
        }

        async function resetDashboardConfirmed() {
            closeModal('reset');
            try {
                const tx = db.transaction(['nodes', 'edges'], 'readwrite');
                tx.objectStore('nodes').clear();
                tx.objectStore('edges').clear();
                tx.oncomplete = () => { showToast("Dashboard cleared.", 'success'); refreshData(); };
            } catch (error) {
                showToast("Reset failed.", 'error');
            }
        }
        
        // --- D3 Logic ---
        const container = document.getElementById('diagram-container');
        const svg = d3.select(container).append("svg")
            .attr("id", "main-svg") // Added ID
            .attr("width", "100%").attr("height", "100%");
        const g = svg.append("g").attr("id", "zoom-group"); // Added ID
        
        // Custom Zoom Filter: Allow wheel only if Ctrl or Meta is pressed (to allow page scroll)
        // OR simply disable wheel zoom if user prefers buttons. 
        // User request: "possible to scroll only if cursor on sidebar" -> IMPLIES graph EATS scroll.
        // Fix: Don't eat scroll.
        const zoom = d3.zoom()
            .filter(event => {
                // Allow wheel zoom primarily with Ctrl/Meta key, or always allow panning (mousedown)
                // If type is wheel, only return true if Ctrl/Meta is pressed.
                if (event.type === 'wheel') return event.ctrlKey || event.metaKey;
                // Allow other events (mousedown, touch, etc)
                return !event.button; // standard filter ref
            })
            .on("zoom", (event) => g.attr("transform", event.transform));
            
        svg.call(zoom)
           .on("wheel.zoom", null); // Explicitly unbind default wheel handler to be safe if custom filter misses, but filter handles it.
           // Actually, d3.zoom rebinds wheel. If filter returns false, it should propagate? 
           // If filter returns false, D3 ignores it. The event bubbles up to the window/div, allowing scrolling.
        
        // Re-attach zoom with correct filter
        svg.call(zoom);

        // Define arrowhead marker
        svg.append("defs").append("marker")
            .attr("id", "arrowhead")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 0).attr("refY", 0).attr("orient", "auto")
            .attr("markerWidth", 6).attr("markerHeight", 6)
            .append("path").attr("d", "M 0,-5 L 10,0 L 0,5").attr("fill", "context-stroke");

        // Define start dot marker
        svg.append("defs").append("marker")
            .attr("id", "startDot")
            .attr("viewBox", "0 0 10 10")
            .attr("refX", 5).attr("refY", 5).attr("markerWidth", 5).attr("markerHeight", 5)
            .append("circle").attr("cx", 5).attr("cy", 5).attr("r", 4).attr("fill", "context-stroke"); 

        const simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(d => d.id).distance(250))
            .force("charge", d3.forceManyBody().strength(-300)) // Reduced charge from -1000
            .force("center", d3.forceCenter(container.clientWidth / 2, container.clientHeight / 2))
            .force("collide", d3.forceCollide(BOX_HEIGHT / 2 + 20).iterations(2)); 

        // --- Drag-to-Connect Logic ---

        function startPropDrag(event, sourceNode, propName) {
            if (sourceNode.locked) {
                blinkLock(sourceNode.id);
                return;
            }
            event.sourceEvent.stopPropagation(); 
            simulation.alphaTarget(0); 

            // Robust Left/Right Detection using the clicked element
            // We clicked a specific dot circle.
            const dotEl = event.sourceEvent.target;
            // Check if it's the left or right dot based on CX attribute or just bounding rect
            let isLeft = false;
            
            if (dotEl && dotEl.tagName === 'circle') {
                // If cx is negative (relative to node center), it's left.
                // Or simply check screen position vs node center
                const rect = dotEl.getBoundingClientRect();
                // node.x is in SVG coordinates, rect is screen. 
                // Let's use getAttribute('cx') if available (it is set in d3 append)
                const cx = parseFloat(dotEl.getAttribute('cx'));
                if (!isNaN(cx)) {
                    isLeft = cx < 0; // Left dots have negative cx (-MIN_BOX_WIDTH/2 + 5)
                }
            }

            dragState.isDragging = true;
            dragState.sourceNodeId = sourceNode.id;
            dragState.sourcePropName = propName;
            dragState.isLeftStart = isLeft;
            
            const propYOffset = getPropertyY(sourceNode, propName);
            // StartX based on side
            const startX = isLeft ? sourceNode.x - MIN_BOX_WIDTH/2 + 5 : sourceNode.x + MIN_BOX_WIDTH/2 - 5;
            const startY = sourceNode.y + propYOffset; 

            if(tempLink) tempLink.remove();
            tempLink = g.append("path").attr("class", "temp-link")
                .attr("stroke", "#EF4444").attr("stroke-width", 3).attr("stroke-dasharray", "5,5") 
                .attr("fill", "none").attr("d", `M ${startX} ${startY} L ${startX} ${startY}`).attr("pointer-events", "none"); 
        }

        function duringPropDrag(event) {
            if (!dragState.isDragging) return;
            const [tx, ty] = d3.pointer(event, g.node());
            const sourceNode = nodes.find(n => n.id === dragState.sourceNodeId);
            const propYOffset = getPropertyY(sourceNode, dragState.sourcePropName);
            
            const s_x = dragState.isLeftStart ? sourceNode.x - MIN_BOX_WIDTH/2 + 5 : sourceNode.x + MIN_BOX_WIDTH/2 - 5;
            const s_y = sourceNode.y + propYOffset;
            
            const midX = (s_x + tx) / 2;
            const midY = (s_y + ty) / 2;
            // ... (rest)
            const qx = midX + 50, qy = midY; // Simplify curve for temp line? No, keep existing logic 
            
            const dx = tx - s_x, dy = ty - s_y;
            const len = Math.sqrt(dx * dx + dy * dy) || 1;
            const nx = -dy / len, ny = dx / len;
            const offset = Math.min(60, len / 5) + 20;
            const cqx = midX + nx * offset, cqy = midY + ny * offset;

            tempLink.attr("d", `M ${s_x} ${s_y} Q ${cqx} ${cqy} ${tx} ${ty}`);

            // HIT DETECTION - UPDATED FOR PROP SNAP
            // Reset styles
            d3.selectAll('.node-group .node-rect').classed('border-4 border-red-500', false);
            d3.selectAll('.prop-drag-dot').attr('r', 4).attr('fill', d => d.color || '#6366F1'); // Reset dots
            
            // Find Target Node
            const targetNode = nodes.find(n => Math.abs(tx - n.x) < MIN_BOX_WIDTH/2 + 20 && Math.abs(ty - n.y) < BOX_HEIGHT/2 + 20);
            
            if (targetNode && targetNode.id !== dragState.sourceNodeId) {
                // Highlight Node
                d3.select(`#node-${targetNode.id} .node-rect`).classed('border-4 border-red-500', true);
                
                // Find Specific Prop?
                // Calculate Mouse Y relative to Node Y
                const relY = ty - targetNode.y;
                // Props start around -height/2 + 70 ...
                // Let's iterate props and find closest Y
                let closestProp = null;
                let minDist = 20; // Snap threshold
                
                if (targetNode.props) {
                    targetNode.props.forEach(p => {
                        const pY = getPropertyY(targetNode, p.name);
                        // Check distance to Left or Right dot
                        // Right Dot: targetNode.x + width/2 - 5
                        // Left Dot: targetNode.x - width/2 + 5
                        // For simply connecting "to a property", user shouldn't care which side if dragging "into" the node. 
                        // But if dragging explicitly to a dot, we check distance to dots.
                        
                        const pyAbs = targetNode.y + pY;
                        const distY = Math.abs(ty - pyAbs);
                        
                        if (distY < 15) { // Vertical match
                             // Check horizontal to highlight specific dot?
                             closestProp = p;
                        }
                    });
                }
                
                dragState.hoverTargetProp = closestProp ? closestProp.name : null;
                
                if (closestProp) {
                    // Highlight the specific dots for this prop on target node
                    d3.select(`#node-${targetNode.id}`)
                      .selectAll(`.prop-drag-dot[data-prop-name="${closestProp.name}"]`)
                      .attr('r', 8)
                      .attr('fill', '#8B5CF6'); // Highlight Violet
                }
            } else {
                dragState.hoverTargetProp = null;
            }
        }

        async function endPropDrag(event) {
            if (!dragState.isDragging) return;
            if(tempLink) tempLink.remove();
            
            // Reset Styles
            d3.selectAll('.node-group .node-rect').classed('border-4 border-red-500', false); 
            d3.selectAll('.prop-drag-dot').attr('r', 4).attr('fill', function() { 
                // Revert to original color logic (tricky without data binding access here easily, 
                // but usually they are styled by class or data attributes. 
                // Actually they have fill set on creation. We overwrote it.
                // We should re-apply their data color or just standard.
                // Let's just remove the override attributes and let CSS/d3 restore or set to standard.
                // Actually, in `enter()` we set fill to `prop.color`.
                // We can't easily get `prop.color` back without data binding.
                // Simplest: Refresh Graph or read from data attribute if we stored it?
                // We didn't store color in data attr. 
                // Wait, refreshing data is safe.
                return d3.select(this).attr("fill"); // This gets the CURRENT value (Red). 
            }); 
            // Better: just refreshData() at the end deals with it, but for smooth UI, maybe just remove the highlight attr?
            // Re-render removes them anyway.

            const [tx, ty] = d3.pointer(event, g.node());
            
            // Relaxed hit detection for prop snapping
            const targetNode = nodes.find(n => Math.abs(tx - n.x) < MIN_BOX_WIDTH/2 + 20 && Math.abs(ty - n.y) < BOX_HEIGHT/2 + 20);

            if (targetNode && targetNode.id !== dragState.sourceNodeId) {
                // Use the hovered prop detected in duringPropDrag, OR recalculate
                let targetProp = dragState.hoverTargetProp || null;
                
                // If not set yet (mouse up happened quickly), try one last check
                if (!targetProp) {
                     if (targetNode.props) {
                        targetNode.props.forEach(p => {
                            const pY = getPropertyY(targetNode, p.name);
                            const pyAbs = targetNode.y + pY;
                            if (Math.abs(ty - pyAbs) < 15) targetProp = p.name;
                        });
                    }
                }

                const newEdge = {
                    id: generateId(),
                    source: dragState.sourceNodeId, 
                    target: targetNode.id,
                    label: null, // Start with NULL to show default fallback
                    sourceProp: dragState.sourcePropName,
                    targetProp: targetProp, // NOW WE LINK TO SPECIFIC PROP
                    startSide: dragState.isLeftStart ? 'left' : 'right', 
                    createdAt: new Date().toISOString(),
                    qX: null, qY: null
                };
                try {
                    await dbOp('edges', 'readwrite', 'put', newEdge);
                    const label = targetProp ? `${targetNode.title}:${targetProp}` : targetNode.title;
                    showToast(`Connected: ${dragState.sourcePropName} -> ${label}`, 'success');
                    refreshData();
                } catch (error) {
                    showToast("Failed to connect.", 'error');
                }
            } else if (targetNode) {
                showToast("Cannot connect to itself.", 'error');
            } else {
                 // Reset dots if no connection made
                 refreshData(); 
            }

            dragState.isDragging = false;
            dragState.hoverTargetProp = null;
            d3.select(`#node-${dragState.sourceNodeId}`).selectAll(".prop-drag-dot").attr("opacity", 0);
            simulation.alphaTarget(0);
        }

        // --- Curve Control Logic ---
        let curveDrag = d3.drag()
            .on("start", (event, d) => {
                const s = typeof d.source === 'object' ? d.source : nodes.find(n => n.id === d.source);
                const t = typeof d.target === 'object' ? d.target : nodes.find(n => n.id === d.target);
                if ((s && s.locked) || (t && t.locked)) {
                    if(s && s.locked) blinkLock(s.id);
                    if(t && t.locked) blinkLock(t.id);
                    return;
                }
                d3.select(`#link-handle-${d.id}`).classed("curve-handle", false).attr("opacity", 1);
            })
            .on("drag", function(event, d) {
                const sNode = nodes.find(n => n.id === (d.source.id || d.source));
                const tNode = nodes.find(n => n.id === (d.target.id || d.target));
                if ((sNode && sNode.locked) || (tNode && tNode.locked)) return;

                // Re-use logic from path drag
                if(!sNode || !tNode) return;
                
                const sx = sNode.x, sy = sNode.y;
                const tx = tNode.x, ty = tNode.y;
                
                const dx = tx - sx;
                const dy = ty - sy;
                const len = Math.sqrt(dx * dx + dy * dy) || 1;
                
                const ex = event.x - sx;
                const ey = event.y - sy;
                
                const parDist = (ex * dx + ey * dy) / len;
                d.curveRatio = parDist / len;
                d.curveDist = (ex * (-dy) + ey * dx) / len;
                
                simulation.alpha(0.01).restart();
            })
            .on("end", async (event, d) => {
                d3.select(`#link-handle-${d.id}`).classed("curve-handle", true).attr("opacity", 0);
                simulation.alphaTarget(0);
                const rawEdge = edges.find(e => e.id === d.id);
                if (rawEdge) {
                     delete rawEdge.qX; 
                     delete rawEdge.qY;
                     await dbOp('edges', 'readwrite', 'put', { 
                        ...rawEdge, 
                        curveRatio: d.curveRatio, 
                        curveDist: d.curveDist 
                    });
                }
            });
        
        function updateGraph(nodesData, edgesData, isCoolUpdate = false) {
            // Restore Fixed Positions (Pin nodes to saved x/y)
            nodesData.forEach(node => {
                if (node.x != null && node.y != null && !isNaN(node.x) && !isNaN(node.y) && (node.x !== 0 || node.y !== 0)) {
                    node.fx = node.x;
                    node.fy = node.y;
                } else {
                    node.fx = null;
                    node.fy = null;
                }
            });
            
            // Fix: Dynamic Markers for Custom Colors
            const defs = svg.select("defs");
            const uniqueColors = [...new Set(edgesData.map(e => e.color || '#9CA3AF'))];
            
            uniqueColors.forEach(color => {
                const safeColorId = color.replace(/[^a-z0-9]/gi, '');
                const arrowId = "arrow-" + safeColorId;
                const dotId = "dot-" + safeColorId;

                // Arrow Marker
                if (defs.select(`#${arrowId}`).empty()) {
                    defs.append("marker")
                        .attr("id", arrowId)
                        .attr("viewBox", "0 -5 10 10")
                        .attr("refX", 0).attr("refY", 0)
                        .attr("orient", "auto")
                        .attr("markerWidth", 6).attr("markerHeight", 6)
                        .append("path")
                        .attr("d", "M 0,-5 L 10,0 L 0,5")
                        .attr("fill", color);
                }

                // Dot Marker (Start)
                if (defs.select(`#${dotId}`).empty()) {
                    defs.append("marker")
                        .attr("id", dotId)
                        .attr("viewBox", "0 0 10 10")
                        .attr("refX", 5).attr("refY", 5)
                        .attr("markerWidth", 5).attr("markerHeight", 5)
                        .append("circle")
                        .attr("cx", 5).attr("cy", 5).attr("r", 4)
                        .attr("fill", color);
                }
            });

            const linkSelection = g.selectAll(".link-path").data(edgesData, d => d.id);
            linkSelection.exit().remove(); 
            let link = linkSelection.enter().append("path") 
                .attr("class", "link-line link-path shadow-sm")
                .attr("id", d => `link-${d.id}`)
                .attr("marker-start", "url(#startDot)").attr("marker-end", "url(#arrowhead)") 
                .on("click", (e, d) => { 
                    e.stopPropagation(); 
                    const s = typeof d.source === 'object' ? d.source : nodes.find(n => n.id === d.source);
                    const t = typeof d.target === 'object' ? d.target : nodes.find(n => n.id === d.target);
                    if ((s && s.locked) || (t && t.locked)) {
                        if(s && s.locked) blinkLock(s.id);
                        if(t && t.locked) blinkLock(t.id);
                        return;
                    }
                    showConnectionDetails(d); 
                })
                .call(d3.drag() // Ensure entire path is draggable to deform
                    .on("start", (event, d) => d3.select(`#link-handle-${d.id}`).attr("opacity", 1))
                    .on("drag", (event, d) => { 
                        // Calculate Relative Offsets instead of Absolute X/Y
                        const sNode = nodes.find(n => n.id === (d.source.id || d.source));
                        const tNode = nodes.find(n => n.id === (d.target.id || d.target));
                        if(!sNode || !tNode) return;

                        // Basic centers (approximate, since we don't have exact anchor points available easily outside tick)
                        // Actually, using node centers is safer for the math than trying to recalculate border intersections here.
                        // Or we can use the current d._calcQX logic to reverse engineer.
                        
                        const sx = sNode.x, sy = sNode.y;
                        const tx = tNode.x, ty = tNode.y;
                        
                        const dx = tx - sx;
                        const dy = ty - sy;
                        const len = Math.sqrt(dx * dx + dy * dy) || 1;
                        
                        // Current Drag Position relative to Source
                        const ex = event.x - sx;
                        const ey = event.y - sy;
                        
                        // Project onto vector (Parallel Ratio)
                        // Unit vector u = (dx/len, dy/len)
                        // Parallel Dist = (ex, ey) . u
                        const parDist = (ex * dx + ey * dy) / len;
                        const ratio = parDist / len;
                        
                        // Project onto normal (Perpendicular Dist)
                        // Normal vector n = (-dy/len, dx/len)
                        const perpDist = (ex * (-dy) + ey * dx) / len;

                        d.curveRatio = ratio;
                        d.curveDist = perpDist;
                        
                        simulation.alpha(0.01).restart(); 
                    })
                    .on("end", async (event, d) => {
                        d3.select(`#link-handle-${d.id}`).attr("opacity", 0);
                        simulation.alphaTarget(0);
                        // Save calculated offsets
                        const rawEdge = edges.find(e => e.id === d.id);
                        if(rawEdge) {
                             // Clean up absolute coords if they exist
                             delete rawEdge.qX; 
                             delete rawEdge.qY;
                             await dbOp('edges', 'readwrite', 'put', {
                                 ...rawEdge, 
                                 curveRatio: d.curveRatio, 
                                 curveDist: d.curveDist 
                             });
                        }
                    }));

            link = link.merge(linkSelection);
            link.attr("stroke", d => d.color || '#9CA3AF')
                .attr("stroke-width", d => d.strokeWidth || 2)
                .attr("stroke-dasharray", d => {
                    if (d.strokeType === 'dashed') return '10,5';
                    if (d.strokeType === 'dotted') return '3,3';
                    return null;
                })
                .attr("marker-end", d => {
                    const c = d.color || '#9CA3AF';
                    const safeId = "arrow-" + c.replace(/[^a-z0-9]/gi, '');
                    return `url(#${safeId})`;
                })
                .attr("marker-start", d => {
                    const c = d.color || '#9CA3AF';
                    const safeId = "dot-" + c.replace(/[^a-z0-9]/gi, '');
                    return `url(#${safeId})`;
                });

            const linkLabelSelection = g.selectAll(".link-label-group").data(edgesData, d => d.id);
            linkLabelSelection.exit().remove();
            
            let labelGroup = linkLabelSelection.enter().append("g")
                .attr("class", "link-label-group")
                .attr("cursor", "move")
                .call(d3.drag()
                    .on("start", (e, d) => { 
                        const s = typeof d.source === 'object' ? d.source : nodes.find(n => n.id === d.source);
                        const t = typeof d.target === 'object' ? d.target : nodes.find(n => n.id === d.target);
                        if ((s && s.locked) || (t && t.locked)) {
                            if(s && s.locked) blinkLock(s.id);
                            if(t && t.locked) blinkLock(t.id);
                            return;
                        }
                        e.sourceEvent.stopPropagation(); simulation.alphaTarget(0); 
                    })
                    .on("drag", function(e, d) {
                        const s = typeof d.source === 'object' ? d.source : nodes.find(n => n.id === d.source);
                        const t = typeof d.target === 'object' ? d.target : nodes.find(n => n.id === d.target);
                        if ((s && s.locked) || (t && t.locked)) return;
                        
                        d.labelX = (d.labelX || (d._calcQX || d.qX || 0)) + e.dx;
                        d.labelY = (d.labelY || (d._calcQY || d.qY || 0)) + e.dy;
                        d3.select(this).attr("transform", `translate(${d.labelX}, ${d.labelY}) rotate(${d.labelRotate || 0})`);
                        d3.select(`path[id='link-${d.id}']`).attr('stroke-width', (d.strokeWidth||2) + 2);
                    })
                    .on("end", async (e, d) => {
                        d3.select(`path[id='link-${d.id}']`).attr('stroke-width', d.strokeWidth || 2);
                        simulation.alphaTarget(0);
                        const rawEdge = edges.find(ed => ed.id === d.id);
                        if(rawEdge) {
                             await dbOp('edges', 'readwrite', 'put', {...rawEdge, labelX: d.labelX, labelY: d.labelY});
                        }
                    })
                )
                .on("mouseover", function(e, d) {
                     d3.select(`path[id='link-${d.id}']`).attr('stroke', '#4F46E5').attr('stroke-width', (d.strokeWidth||2)+1);
                     // Show delete button if there is ANY label text visible (User or Default)
                     const currentText = d3.select(this).select("text").text();
                     if(currentText) d3.select(this).select(".label-delete-btn").attr("opacity", 1);
                })
                .on("mouseout", function(e, d) {
                     d3.select(`path[id='link-${d.id}']`).attr('stroke', d.color || '#9CA3AF').attr('stroke-width', d.strokeWidth||2);
                     d3.select(this).select(".label-delete-btn").attr("opacity", 0);
                })
                .on("dblclick", (e, d) => {
                    e.stopPropagation();
                    const s = typeof d.source === 'object' ? d.source : nodes.find(n => n.id === d.source);
                    const t = typeof d.target === 'object' ? d.target : nodes.find(n => n.id === d.target);
                    if ((s && s.locked) || (t && t.locked)) {
                        if(s && s.locked) blinkLock(s.id);
                        if(t && t.locked) blinkLock(t.id);
                        return;
                    }
                    const group = d3.select(e.currentTarget);
                    if(!group.select("foreignObject").empty()) return;
                    group.select("text").attr("opacity", 0);
                    group.select(".label-delete-btn").attr("opacity", 0).style("display", "none");
                    
                    const fo = group.append("foreignObject")
                        .attr("x", -80).attr("y", -15).attr("width", 160).attr("height", 30);
                    
                    const div = fo.append("xhtml:div")
                        .style("display", "flex").style("align-items", "center").style("justify-content", "center").style("gap", "4px")
                        .style("width", "100%").style("height", "100%");

                    const input = div.append("xhtml:input")
                        .attr("value", d.label || "") 
                        .style("flex", "1")
                        .style("min-width", "0")
                        .style("height", "24px")
                        .style("border", "1px solid #6366F1").style("border-radius", "4px").style("padding", "0 4px")
                        .style("font-size", "12px").style("outline", "none").style("text-align", "center").style("background", "white");
                    
                    // Set property specifically to ensure value is present
                    const src = d.sourceProp || '*'; const tgt = d.targetProp || '*';
                    const fallback = `(${src}‚Üí${tgt})`;
                    // If label is null/undefined (Default), show fallback in input for editing
                    // If label is "" (Empty), show empty
                    // If label has value, show value
                    let initialVal = "";
                    if (d.label != null) initialVal = d.label; // Can be "" or "text"
                    else initialVal = fallback; // Null means default
                    
                    input.node().value = initialVal;
                    
                    const btn = div.append("xhtml:button")
                        .text("‚úì")
                        .style("width", "24px").style("height", "24px")
                        .style("background", "#10B981").style("color", "white").style("border", "none").style("border-radius", "50%")
                        .style("cursor", "pointer").style("display", "flex").style("align-items", "center").style("justify-content", "center")
                        .style("font-size", "14px").style("font-weight", "bold").style("flex-shrink", "0");
                    
                    let saved = false;
                    const save = async () => {
                         if(saved) return;
                         saved = true;
                         const val = input.property("value");
                         const edges = await dbOp('edges', 'readonly', 'getAll');
                         const edge = edges.find(ed => ed.id === d.id);
                         if(edge) { 
                             // Sanitize source/target to ensure they are IDs not objects
                             const sId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                             const tId = typeof edge.target === 'object' ? edge.target.id : edge.target;
                             
                             await dbOp('edges', 'readwrite', 'put', {...edge, label: val, source: sId, target: tId}); 
                             refreshData(); // Match modal behavior (full refresh) to ensure links re-bind correctly
                         } else { 
                             fo.remove(); 
                             group.select("text").attr("opacity", 1);  
                             group.select(".label-delete-btn").style("display", null);
                         }
                    };
                    
                    // Blur on input triggers save, but if we click button, button click fires (mousedown/click)
                    // If we use mousedown on button, it fires before blur on input.
                    btn.on("mousedown", (e) => { e.preventDefault(); save(); });
                    input.on("blur", () => { setTimeout(save, 100); }); // Delay slightly to allow button click if that was the target
                    input.on("keydown", (e) => { if(e.key==="Enter") { e.preventDefault(); input.node().blur(); }});
                    
                    setTimeout(() => input.node().select(), 10);
                });

            labelGroup.append("rect").attr("x", -50).attr("y", -15).attr("width", 100).attr("height", 30).attr("fill", "transparent");
            labelGroup.append("text").attr("class", "link-label-text").attr("dy", 4).attr("text-anchor", "middle")
                .attr("fill", "#374151").attr("font-size", "12px").attr("font-weight", "bold").style("pointer-events", "none");
            
            const delBtn = labelGroup.append("g").attr("class", "label-delete-btn").attr("opacity", 0).attr("cursor", "pointer")
                .on("click", async (e, d) => {
                    e.stopPropagation();
                    const s = typeof d.source === 'object' ? d.source : nodes.find(n => n.id === d.source);
                    const t = typeof d.target === 'object' ? d.target : nodes.find(n => n.id === d.target);
                    if ((s && s.locked) || (t && t.locked)) {
                        if(s && s.locked) blinkLock(s.id);
                        if(t && t.locked) blinkLock(t.id);
                        return;
                    }
                    const edges = await dbOp('edges', 'readonly', 'getAll');
                    const edge = edges.find(ed => ed.id === d.id);
                    if(edge) { 
                        // Sanitize source/target
                        const sId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                        const tId = typeof edge.target === 'object' ? edge.target.id : edge.target;
                        
                        await dbOp('edges', 'readwrite', 'put', {...edge, label: "", source: sId, target: tId}); 
                        showToast("Label removed", "success"); 
                        refreshData(); // Match modal behavior
                    }
                });
            delBtn.append("circle").attr("r", 12).attr("fill", "#EF4444").attr("stroke", "white").attr("stroke-width", 1);
            delBtn.append("text").attr("text-anchor", "middle").attr("dy", 4).attr("fill", "white").attr("font-size", "14px").attr("font-weight", "bold").text("‚úï");

            labelGroup = labelGroup.merge(linkLabelSelection);
            
            // Clean up any lingering foreignObjects from update selection
            // This fixes the issue where confirm button "doesn't finish" because the input stays in the DOM
            // if refreshData re-uses the group but doesn't clear children.
            labelGroup.selectAll("foreignObject").remove();
            
            labelGroup.select("text").attr("opacity", 1).text(d => {
                const src = d.sourceProp || '*'; const tgt = d.targetProp || '*';
                // d.label === "" -> Shows Nothing (Deleted)
                if (d.label === "") return "";
                // d.label === null/undefined -> Shows Default Fallback
                // d.label === "text" -> Shows "text"
                if (d.label != null) return d.label;
                return `(${src}‚Üí${tgt})`;
            });
            
            labelGroup.each(function(d) {
                 const textEl = d3.select(this).select("text").node();
                 const delBtn = d3.select(this).select(".label-delete-btn"); 
                 
                 // Explicitly ensure Display is reset on update
                 if(delBtn.style("display") === "none") delBtn.style("display", null);
                 
                 if(textEl) {
                     const bbox = textEl.getBBox();
                     const w = Math.max(60, bbox.width + 20);
                     d3.select(this).select("rect").attr("x", -w/2).attr("width", w);
                     // Vertically align with text (y=0 is center of group)
                     // Rect y is -15, h 30. Center 0.
                     // Text dy is 4. Match text baseline for visual centering.
                     delBtn.attr("transform", `translate(${w/2}, 4)`);
                 }
            });

            const handlesSelection = g.selectAll(".curve-handle").data(edgesData, d => d.id);
            handlesSelection.exit().remove();
            let handles = handlesSelection.enter().append("circle").attr("id", d => `link-handle-${d.id}`).attr("class", "curve-handle")
                .attr("r", 8).attr("fill", "#6366F1").attr("stroke", "white").attr("stroke-width", 2).attr("cursor", "move").call(curveDrag).merge(handlesSelection);

            let node = g.selectAll(".node-group").data(nodesData, d => d.id);
            node.exit().remove(); 
            
            const nEnter = node.enter().append("g").attr("class", "node-group")
                .attr("id", d => `node-${d.id}`)
                .on("click", (e, d) => { 
                    e.stopPropagation(); 
                    if (typeof pendingConnectionSource !== 'undefined' && pendingConnectionSource) {
                        completeQuickConnection(d.id);
                    } else {
                        showNodeDetails(d); 
                    }
                })
                .on("mouseenter", function() { d3.select(this).selectAll(".prop-drag-dot").attr("opacity", 1); })
                .on("mouseleave", function() { if (!dragState.isDragging) d3.select(this).selectAll(".prop-drag-dot").attr("opacity", 0); })
                .call(d3.drag().on("start", (e, d) => { 
                    if (d.locked) {
                        blinkLock(d.id);
                        return;
                    }
                    if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; 
                })
                .on("drag", (e, d) => { d.fx = e.x; d.fy = e.y; })
                .on("end", async (e, d) => { if (!e.active) simulation.alphaTarget(0); await dbOp('nodes', 'readwrite', 'put', {...d, x: d.fx, y: d.fy}); }));

            // Initial Rect (will be resized on merge/update)
            nEnter.append("rect").attr("class", "node-rect").attr("width", MIN_BOX_WIDTH).attr("x", -MIN_BOX_WIDTH/2);
            // Title & Desc & Icon placeholders
            nEnter.append("text").attr("class", "node-title text-lg font-bold").attr("text-anchor", "middle").attr("fill", "white");
            nEnter.append("text").attr("class", "node-description text-xs opacity-80").attr("text-anchor", "middle").attr("fill", "white");
            
            // Doc Link Icon
            nEnter.append("text").attr("class", "doc-link-icon").attr("text-anchor", "end").attr("dx", MIN_BOX_WIDTH/2 - 30).text("üîó")
                .on("click", (e, d) => { 
                    e.stopPropagation(); 
                    if(d.docLink) window.open(d.docLink, '_blank'); 
                });

            // Lock Icon Group
            const lockGroup = nEnter.append("g")
                .attr("class", "lock-icon-group")
                .attr("cursor", "pointer")
                .on("click", toggleNodeLock)
                .on("mouseenter", (e) => showTooltip("Click to lock/unlock component", e))
                .on("mouseleave", hideTooltip)
                .on("mousedown", (e) => e.stopPropagation()) // Prevent drag start when clicking lock
                .on("dblclick", (e) => e.stopPropagation()); 

            // Transparent rect for easier clicking
            lockGroup.append("rect")
                .attr("x", MIN_BOX_WIDTH/2 - 25) 
                .attr("y", -10)
                .attr("width", 20)
                .attr("height", 20)
                .attr("fill", "transparent");

            // The icon path - Centered inside group logic or absolute?
            // Material icons are 24x24 viewBox. We scale them down.
            lockGroup.append("path")
                .attr("class", "lock-icon-path")
                .attr("transform", `translate(${MIN_BOX_WIDTH/2 - 24}, -8) scale(0.7)`) 
                .attr("fill", "#EF4444"); // Default red/white? White usually on colored node header.
                // Wait, headers are colored. White is better. But blinking red.
                // CSS Blink uses fill red.

            nEnter.append("g").attr("class", "props-list");

            node = nEnter.merge(node); 
            
            // --- Update Node Visuals (Dynamic Height) ---
            node.each(function(d) {
                const h = getNodeHeight(d);
                const top = -h / 2;
                
                // Update Rect
                d3.select(this).select("rect")
                    .attr("height", h)
                    .attr("y", top)
                    .attr("fill", d.color);
                    
                // Update Text Positions relative to new Top
                // Moved down for more spacing
                d3.select(this).select(".node-title")
                    .attr("dy", `${top + 35}px`)
                    .text(() => {
                        const maxLen = 18; 
                        return (d.title && d.title.length > maxLen) ? d.title.substring(0, maxLen) + '...' : d.title;
                    });
                    
                d3.select(this).select(".node-description")
                    .attr("dy", `${top + 55}px`)
                    .text(() => (d.description || "").substring(0, 30) + ((d.description||"").length > 30 ? '...' : ''));

                d3.select(this).select(".doc-link-icon")
                    .attr("dy", top + 22)
                    .attr("dx", MIN_BOX_WIDTH/2 - 35) // Shifted left to make room for lock
                    .attr("display", d.docLink ? "block" : "none");
                
                // Update Lock Icon
                const lockIcon = d3.select(this).select(".lock-icon-path");
                const lockGroup = d3.select(this).select(".lock-icon-group");
                
                // Position relative to top - Moved down (+15)
                lockGroup.attr("transform", `translate(0, ${top + 15})`); 

                // Set Icon Path
                const unlockedPath = "M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h1.9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10z";
                const lockedPath = "M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z";
                
                lockIcon.attr("d", d.locked ? lockedPath : unlockedPath);
                
                // Position the lock group rect for easier clicking
                // We want it at right edge: MIN_BOX_WIDTH/2 - 25 is start x.
                // Let's adjust path and rect to be consistent. 
                // Group is at (0, top+15).
                // Path is at (WIDTH/2 - 24, -8).
                
                // Tooltip managed by mouse events

                // Update Style
                // We use white for default state on colored header, but red for blinking/locked emphasis?
                // Visual consistency: White is good for header. 
                lockIcon.attr("fill", "white");
                    
                // Render Properties
                const propsGroup = d3.select(this).select(".props-list");
                propsGroup.selectAll("*").remove(); 
                const props = d.props || [];
                const propYOffsetStart = top + 80; 

                // Show ALL properties
                props.forEach((prop, i) => { 
                    const propY = propYOffsetStart + (i * PROP_LINE_HEIGHT);
                    
                    // Create group for tooltip and text
                    const propGroupEnter = propsGroup.append("g");
                    
                    // Background for hit area (optional, improving hover)
                    propGroupEnter.append("rect")
                        .attr("x", -MIN_BOX_WIDTH/2 + 10)
                        .attr("y", propY - 10)
                        .attr("width", MIN_BOX_WIDTH - 30) // Leave space for dot
                        .attr("height", PROP_LINE_HEIGHT)
                        .attr("fill", "transparent");

                    const textEl = propGroupEnter.append("text")
                        .attr("text-anchor", "start")
                        .attr("x", -MIN_BOX_WIDTH/2 + 10)
                        .attr("y", propY)
                        .attr("font-size", "10px")
                        .attr("font-family", "monospace")
                        .attr("fill", prop.color);

                    // Truncate logic
                    const fullText = `${prop.name}: ${prop.type}`;
                    // Approx char limit for 200px width at 10px monospace (~6px per char) -> ~33 chars
                    // But we want to bold the name, so we construct it manually
                    
                    // Add Tooltip (Custom)
                    textEl.on("mouseenter", (e) => showTooltip(fullText, e))
                          .on("mouseleave", hideTooltip);

                    // Render Bold Name
                    textEl.append("tspan")
                        .attr("font-weight", "bold")
                        .text(prop.name.length > 25 ? prop.name.substring(0, 22) + "..." : prop.name);
                        
                    // Render Type (if space permits)
                    // If name is long, type might get pushed out or we just truncate the whole thing visually via logic
                    // Simple approach: show type if name isn't super long
                    if (prop.name.length < 25) {
                        const remaining = 30 - prop.name.length;
                        const typeText = `: ${prop.type}`;
                        textEl.append("tspan")
                            .attr("font-weight", "normal")
                            .text(typeText.length > remaining ? typeText.substring(0, remaining) + "..." : typeText);
                    }

                    // Connection Dot (Right)
                    propsGroup.append("circle").attr("class", "prop-drag-dot").attr("opacity", 0).attr("r", 4).attr("cx", MIN_BOX_WIDTH/2 - 5).attr("cy", propY - 4)
                        .attr("fill", prop.color).attr("stroke", "white").attr("stroke-width", 1).attr("cursor", "crosshair").attr("data-prop-name", prop.name)
                        .call(d3.drag().on("start", (e) => startPropDrag(e, d, prop.name)).on("drag", (e) => duringPropDrag(e)).on("end", (e) => endPropDrag(e)));

                    // Connection Dot (Left)
                    propsGroup.append("circle").attr("class", "prop-drag-dot").attr("opacity", 0).attr("r", 4).attr("cx", -MIN_BOX_WIDTH/2 + 5).attr("cy", propY - 4)
                        .attr("fill", prop.color).attr("stroke", "white").attr("stroke-width", 1).attr("cursor", "crosshair").attr("data-prop-name", prop.name)
                        .call(d3.drag().on("start", (e) => startPropDrag(e, d, prop.name)).on("drag", (e) => duringPropDrag(e)).on("end", (e) => endPropDrag(e)));
                });
            });

            simulation.nodes(nodesData).on("tick", ticked);
            simulation.force("link").links(edgesData);
            
            // Initial manual tick to ensure static render is correct even if simulation doesn't start
            ticked();

            // FIX: Do not aggressively restart simulation if nodes are already positioned.
            // Only heat up slightly to settle new connections
            if (!isCoolUpdate) simulation.alpha(0.1).restart();
            else simulation.alphaTarget(0); 

            function ticked() {
                link.attr("d", d => {
                    // Safety check: if d.source is ID string, wait for D3
                    if (typeof d.source !== 'object' || !d.source.x) return ""; 

                    const s = d.source, t = d.target;
                    let s_x = s.x, s_y = s.y;
                    
                    const sH = getNodeHeight(s);
                    const tH = getNodeHeight(t);

                    // Robust Data Lookup: Use fresh reference for props/titles, but keep physics (s.x/s.y)
                    const freshS = nodesData.find(n => n.id === s.id);
                    const freshT = nodesData.find(n => n.id === t.id);
                    const sNode = freshS || s;
                    const tNode = freshT || t;
                    
                    // Source Logic
                    if (d.sourceProp) {
                        if(sNode) {
                             const pY = getPropertyY(sNode, d.sourceProp);
                             // Only apply offset if property was actually found (non-zero or special check)
                             // getPropertyY returns 0 if not found. But 0 is also valid center-relative Y.
                             // Let's assume if it returns 0 and prop exists it's fine.
                             s_y = s.y + pY; 
                             
                             // Smart Side Selection
                             if (t.x < s.x) {
                                 // Target is Left -> Start from Left
                                 s_x = s.x - MIN_BOX_WIDTH/2 - START_GAP - 2;
                             } else {
                                 // Target is Right -> Start from Right
                                 s_x = s.x + MIN_BOX_WIDTH/2 + START_GAP + 2;
                             }
                        }
                    } else {
                        // Standard Center-to-Center with Boundary Logic (Using Dynamic Height)
                        const dx = t.x - s.x, dy = t.y - s.y;
                        if (Math.abs(dx * sH) > Math.abs(dy * MIN_BOX_WIDTH)) { 
                             s_x = s.x + Math.sign(dx) * MIN_BOX_WIDTH/2; 
                             s_y = s.y + dy * (MIN_BOX_WIDTH/2) / Math.abs(dx); 
                         } else { 
                             s_y = s.y + Math.sign(dy) * sH/2; 
                             s_x = s.x + dx * (sH/2) / Math.abs(dy); 
                         }
                         // Push out slightly
                         const adj = adjustPoint(s_x, s_y, s.x, s.y, START_GAP); 
                         s_x = adj.x; s_y = adj.y;
                    }

                    // Target Logic
                    let t_x = t.x, t_y = t.y;
                    if (d.targetProp) {
                        if(tNode) {
                            t_y = t.y + getPropertyY(tNode, d.targetProp);
                            
                            // Smart Side Selection
                            if (s.x > t.x) {
                                // Source is Right -> Connect to Right
                                t_x = t.x + MIN_BOX_WIDTH/2 + ARROW_PULLBACK + 2;
                            } else {
                                // Source is Left -> Connect to Left
                                t_x = t.x - MIN_BOX_WIDTH/2 - ARROW_PULLBACK - 2;
                            }
                        }
                    } else {
                        const dx = s.x - t.x, dy = s.y - t.y;
                        if (Math.abs(dx * tH) > Math.abs(dy * MIN_BOX_WIDTH)) { 
                            t_x = t.x + Math.sign(dx) * MIN_BOX_WIDTH/2; 
                            t_y = t.y + dy * (MIN_BOX_WIDTH/2) / Math.abs(dx); 
                        } else { 
                            t_y = t.y + Math.sign(dy) * tH/2; 
                            t_x = t.x + dx * (tH/2) / Math.abs(dy); 
                        }
                        const adj = adjustPoint(t_x, t_y, t.x, t.y, 0); 
                        t_x = adj.x; t_y = adj.y;
                    }

                    // Curve Control Point Calculation
                    let qx, qy;
                    let cp1 = null, cp2 = null;
                    
                    if (d.folding && d.folding.length > 0) {
                        // MULTI-FOLDING LOGIC WITH ROUNDED CORNERS
                        
                        const points = [
                            {x: s_x, y: s_y}, 
                            ...d.folding, 
                            {x: t_x, y: t_y}
                        ];

                        const radius = 20; // Radius for rounded corners

                        // Begin Path
                        let pathD = `M ${points[0].x} ${points[0].y}`;

                        for (let i = 1; i < points.length - 1; i++) {
                            const prev = points[i-1];
                            const curr = points[i];
                            const next = points[i+1];

                            // Vector prev -> curr
                            const dx1 = curr.x - prev.x;
                            const dy1 = curr.y - prev.y;
                            const dist1 = Math.sqrt(dx1*dx1 + dy1*dy1);

                            // Vector curr -> next
                            const dx2 = next.x - curr.x;
                            const dy2 = next.y - curr.y;
                            const dist2 = Math.sqrt(dx2*dx2 + dy2*dy2);

                            // Limit radius if segments are short
                            const r = Math.min(radius, dist1/2, dist2/2);

                            // Start of curve (move back r from curr towards prev)
                            const openX = curr.x - (dx1 / dist1) * r;
                            const openY = curr.y - (dy1 / dist1) * r;

                            // End of curve (move forward r from curr towards next)
                            const exitX = curr.x + (dx2 / dist2) * r;
                            const exitY = curr.y + (dy2 / dist2) * r;

                            pathD += ` L ${openX} ${openY}`;
                            pathD += ` Q ${curr.x} ${curr.y} ${exitX} ${exitY}`;
                        }
                        
                        pathD += ` L ${points[points.length-1].x} ${points[points.length-1].y}`;
                        return pathD;

                    } else if (d.curveDist !== undefined && d.curveRatio !== undefined) {
                        // User has customized the curve - adhere to relative offsets
                        const dx = t_x - s_x;
                        const dy = t_y - s_y;
                        const len = Math.sqrt(dx * dx + dy * dy) || 1;
                        
                        const nx = -dy / len;
                        const ny = dx / len;
                        
                        qx = s_x + (dx * d.curveRatio) + (nx * d.curveDist);
                        qy = s_y + (dy * d.curveRatio) + (ny * d.curveDist);
                    } else {
                        // Intelligent Spaghetti Routing with Obstacle Avoidance (Auto-Half-Square)
                        const dx = t_x - s_x, dy = t_y - s_y;
                        
                        // Default Bezier Logic (Gentle Arc)
                        cp1 = { x: s_x + dx * 0.25, y: s_y + dy * 0.1 };
                        cp2 = { x: t_x - dx * 0.25, y: t_y - dy * 0.1 };
                        
                        // Check for Intersecting Obstacles (The "Half Square" detector)
                        // Define a bounding box for the connection + margin
                        const bbox = {
                            minX: Math.min(s_x, t_x), maxX: Math.max(s_x, t_x),
                            minY: Math.min(s_y, t_y), maxY: Math.max(s_y, t_y)
                        };
                        
                        // Expand bbox slightly for detection
                        const detectionMargin = 60;
                        const obstacles = nodesData.filter(n => {
                            if (n.id === s.id || n.id === t.id) return false;
                            // Check rough overlap
                            return (n.x > bbox.minX - detectionMargin && n.x < bbox.maxX + detectionMargin &&
                                    n.y > bbox.minY - detectionMargin && n.y < bbox.maxY + detectionMargin);
                        });

                        if (obstacles.length > 0) {
                            // "Digital Logic" Routing - Find clean "Lanes"
                            // Decide if we should go Top/Bottom or Left/Right
                            // For horizontal-ish connections, prefer Top/Bottom bypass.
                            // For vertical-ish, prefer Left/Right.
                            
                            const isHorizontal = Math.abs(dx) > Math.abs(dy);
                            
                            if (isHorizontal) {
                                // Find MAX Top and MAX Bottom of obstacles
                                let maxTop = -Infinity;   // Highest Y (lowest number)
                                let maxBottom = Infinity; // Lowest Y (highest number)
                                
                                obstacles.forEach(n => {
                                    // Remember: Y increases downwards
                                    const topY = n.y - getNodeHeight(n)/2 - 40; // 40px padding
                                    const botY = n.y + getNodeHeight(n)/2 + 40;
                                    if(topY > maxTop) maxTop = topY; // Actually we want MINIMUM Y for top path
                                });
                                
                                // Actually let's just find the extreme boundaries of the OBSTACLE CLUSTER
                                const obsMinY = d3.min(obstacles, n => n.y - getNodeHeight(n)/2) - 50;
                                const obsMaxY = d3.max(obstacles, n => n.y + getNodeHeight(n)/2) + 50;
                                
                                // Compare with current path Y
                                const midY = (s_y + t_y)/2;
                                const distToTop = Math.abs(midY - obsMinY);
                                const distToBot = Math.abs(midY - obsMaxY);
                                
                                // Pick the shorter/cleaner detour
                                const targetY = (distToTop < distToBot) ? obsMinY : obsMaxY;
                                
                                // Create "Table Top" shape (Half Square)
                                // Move Control Points to the target Y level
                                cp1.y = targetY; 
                                cp2.y = targetY;
                                
                                // Pull X coordinates in to create steeper rise/fall
                                // If we are avoiding UP, we want to go UP first.
                                cp1.x = s_x + (dx * 0.05); // Stay near start X
                                cp2.x = t_x - (dx * 0.05); // Stay near target X
                                
                            } else {
                                // Vertical Mode
                                const obsMinX = d3.min(obstacles, n => n.x - MIN_BOX_WIDTH/2) - 50;
                                const obsMaxX = d3.max(obstacles, n => n.x + MIN_BOX_WIDTH/2) + 50;
                                
                                const midX = (s_x + t_x)/2;
                                const targetX = (Math.abs(midX - obsMinX) < Math.abs(midX - obsMaxX)) ? obsMinX : obsMaxX;
                                
                                cp1.x = targetX;
                                cp2.x = targetX;
                                cp1.y = s_y + (dy * 0.05);
                                cp2.y = t_y - (dy * 0.05);
                            }
                        } else {
                            // No direct Blockers - Just minor Repulsion for nearby drift
                            // ... Keep existing Repulsion for "Drifting" nodes ...
                            const safeR = 140; // Increased Safe Radius
                            nodesData.forEach(n => {
                                if (n.id === s.id || n.id === t.id) return;
                                const repulse = (pt) => {
                                    const rdx = pt.x - n.x;
                                    const rdy = pt.y - n.y;
                                    const dist = Math.sqrt(rdx*rdx + rdy*rdy);
                                    if (dist < safeR) {
                                        const force = (safeR - dist) * 3; // Hard push
                                        pt.x += (rdx/dist) * force;
                                        pt.y += (rdy/dist) * force;
                                    }
                                };
                                repulse(cp1);
                                repulse(cp2);
                            });
                        }
                        
                        // Handle Manual Drag (if user is dragging the curve handle)
                        // If d.curveDist is set, we use the user's wish primarily?
                        // No, the block asks d.curveDist in 'else if'. 
                        // But if we want to allow dragging THIS intelligent curve:
                        // The UI currently supports dragging 'd.curveDist' (Quadratic).
                        // If we render Cubic, the drag handle (qx, qy) might be misleading or snap the line to Quadratic.
                        // Ideally, we keep the smart cubic until the user drags, then it becomes manual Quadratic.
                        // (Which is what the current if/else structure does).

                        // Calculate Midpoint Q for Handles/Labels
                        qx = 0.125 * s_x + 0.375 * cp1.x + 0.375 * cp2.x + 0.125 * t_x;
                        qy = 0.125 * s_y + 0.375 * cp1.y + 0.375 * cp2.y + 0.125 * t_y;
                    }
                    
                    // ORTHOGONAL ENTRY / "Rounded 90 degree"
                    // If targetProp is set, we use Cubic Bezier to land horizontally
                    let pathD = "";
                    let endSegLen = 40; 
                    
                    if (d.targetProp) {
                         // Force horizontal entry
                         let approachX = t_x < t.x ? t_x - endSegLen : t_x + endSegLen;
                         
                         // Use computed Q (midpoint) as control 1, approach as control 2
                         pathD = `M ${s_x} ${s_y} C ${qx} ${qy}, ${approachX} ${t_y}, ${t_x} ${t_y}`;
                         
                    } else {
                        if (cp1 && cp2) {
                            pathD = `M ${s_x} ${s_y} C ${cp1.x} ${cp1.y} ${cp2.x} ${cp2.y} ${t_x} ${t_y}`;
                        } else {
                            pathD = `M ${s_x} ${s_y} Q ${qx} ${qy} ${t_x} ${t_y}`;
                        }
                    }

                    // Store calculated Q for other elements (labels/handles) to use
                    d._calcQX = qx;
                    d._calcQY = qy;

                    return pathD;
                });

                g.selectAll(".link-label-group").attr("transform", d => {
                     const x = d.labelX || d._calcQX || d.qX || 0;
                     const y = d.labelY || d._calcQY || d.qY || 0;
                     const rot = d.labelRotate || 0;
                     return `translate(${x}, ${y}) rotate(${rot})`;
                });
                handles.attr("cx", d => d._calcQX || d.qX || 0).attr("cy", d => d._calcQY || d.qY || 0);
                node.attr("transform", d => `translate(${d.x},${d.y})`);
            }
            simulation.force("link").links(edgesData);
            // FIX: Do not aggressively restart simulation if nodes are already positioned.
            // Only heat up slightly to settle new connections
            if (!isCoolUpdate) simulation.alpha(0.1).restart();
            else simulation.alphaTarget(0); // Ensure it stops if it was running? Or just don't restart.
        }

        /* --- Helper for FAB Click vs Drag --- */
        let globalFabMoved = false; // Flag to track if the last interaction was a drag
        
        function handleFabClick(type) {
            if (globalFabMoved) {
                globalFabMoved = false; // Reset and ignore click
                return;
            }
            if (type === 'help') openHelpModal();
            if (type === 'add') fastAddComponent();
        }


   

        /* --- AI Chatbot Logic --- */
        
        // Extended Knowledge Base for Databases
        const kmDatabase = [
             {
                 keywords: ["sql", "mysql", "postgres", "relational"],
                 answers: {
                     en: "SQL (Relational) databases like MySQL and PostgreSQL store data in tables with strict schemas. \n\n**MySQL**: Great for web apps, read-heavy loads. \n**PostgreSQL**: Advanced, supports JSONB, complex queries, robust integrity. \n\n*Tip: Create 'Tables' and connect them to define Foreign Keys.*",
                     de: "SQL-Datenbanken wie MySQL und PostgreSQL speichern Daten in Tabellen.",
                     uk: "SQL (—Ä–µ–ª—è—Ü—ñ–π–Ω—ñ) –±–∞–∑–∏ –¥–∞–Ω–∏—Ö, —Ç–∞–∫—ñ —è–∫ MySQL —Ç–∞ PostgreSQL, –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å –¥–∞–Ω—ñ –≤ —Ç–∞–±–ª–∏—Ü—è—Ö –∑—ñ —Å—Ç—Ä–æ–≥–æ—é —Å—Ö–µ–º–æ—é. \n\n**MySQL**: –ß—É–¥–æ–≤–æ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è –≤–µ–±-–¥–æ–¥–∞—Ç–∫—ñ–≤. \n**PostgreSQL**: –ü—ñ–¥—Ç—Ä–∏–º—É—î JSONB, —Å–∫–ª–∞–¥–Ω—ñ –∑–∞–ø–∏—Ç–∏ —Ç–∞ –Ω–∞–¥—ñ–π–Ω—É —Ü—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å.",
                 }
             },
             {
                 keywords: ["nosql", "mongo", "mongodb", "document"],
                 answers: {
                     en: "NoSQL databases like MongoDB store data as flexible documents (JSON/BSON). \n\n**MongoDB**: Best for rapid prototyping, unstructured data, and scalability. Does not enforce strict joins like SQL. \n\n*Tip: Create 'Collections' and nesting properties.*",
                     uk: "NoSQL –±–∞–∑–∏ –¥–∞–Ω–∏—Ö, —Ç–∞–∫—ñ —è–∫ MongoDB, –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å –¥–∞–Ω—ñ —è–∫ –≥–Ω—É—á–∫—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏ (JSON/BSON). –Ü–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —à–≤–∏–¥–∫–æ—ó —Ä–æ–∑—Ä–æ–±–∫–∏ —Ç–∞ –Ω–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö.",
                 }
             },
             {
                 keywords: ["json", "import"],
                 answers: {
                     en: "You can import properties from JSON! Open a component, expand 'Import Properties', paste your JSON, and click 'Detect Types'.",
                     uk: "–í–∏ –º–æ–∂–µ—Ç–µ —ñ–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ –∑ JSON! –í—ñ–¥–∫—Ä–∏–π—Ç–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, —Ä–æ–∑–≥–æ—Ä–Ω—ñ—Ç—å '–Ü–º–ø–æ—Ä—Ç –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π', –≤—Å—Ç–∞–≤—Ç–µ JSON —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å '–í–∏–∑–Ω–∞—á–∏—Ç–∏ —Ç–∏–ø–∏'.",
                 }
             },
             {
                 keywords: ["drop", "clear", "delete room", "reset"],
                 answers: {
                     en: "**Danger Zone**: To clear the room data, click the **Drop / Clear (üí£)** button in the top toolbar (visible when connected). This removes ALL nodes and edges for everyone.",
                     uk: "**–ù–µ–±–µ–∑–ø–µ—á–Ω–∞ –∑–æ–Ω–∞**: –©–æ–± –æ—á–∏—Å—Ç–∏—Ç–∏ –¥–∞–Ω—ñ –∫—ñ–º–Ω–∞—Ç–∏, –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É **–°–∫–∏–Ω—É—Ç–∏ / –û—á–∏—Å—Ç–∏—Ç–∏ (üí£)** –Ω–∞ –≤–µ—Ä—Ö–Ω—ñ–π –ø–∞–Ω–µ–ª—ñ (–¥–æ—Å—Ç—É–ø–Ω–∞ –ø—Ä–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—ñ). –¶–µ –≤–∏–¥–∞–ª—è—î –í–°–Ü –≤—É–∑–ª–∏ —Ç–∞ –∑–≤'—è–∑–∫–∏ –¥–ª—è –≤—Å—ñ—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤.",
                 }
             },
             {
                 keywords: ["comment", "thread", "reply", "edit", "chat", "talk", "message"],
                 answers: {
                     en: "**Collaboration**: \n- **Global Chat**: Use the chat bubble (bottom-right) to talk to everyone in the room. \n- **Node Comments**: Select a node and click the **Quote Icon** to discuss specific topics.",
                     uk: "**–°–ø—ñ–≤–ø—Ä–∞—Ü—è**: \n- **–ì–ª–æ–±–∞–ª—å–Ω–∏–π —á–∞—Ç**: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —ñ–∫–æ–Ω–∫—É —á–∞—Ç—É (–≤–Ω–∏–∑—É –ø—Ä–∞–≤–æ—Ä—É—á) –¥–ª—è —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è. \n- **–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ –¥–æ –≤—É–∑–ª—ñ–≤**: –í–∏–±–µ—Ä—ñ—Ç—å –≤—É–∑–æ–ª —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å **—ñ–∫–æ–Ω–∫—É —Ü–∏—Ç–∞—Ç–∏**, —â–æ–± –æ–±–≥–æ–≤–æ—Ä–∏—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ —Ç–µ–º–∏.",
                 }
             },
             {
                 keywords: ["magic link", "share", "invite"],
                 answers: {
                     en: "**Sharing**: Click the **Copy Link (üîó)** button to get a secure Magic Link. It contains an encrypted version of your Firebase Config so your team can join instantly without setup.",
                     uk: "**–°–ø—ñ–ª—å–Ω–∏–π –¥–æ—Å—Ç—É–ø**: –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É **–ö–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è (üîó)**, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑–∞—Ö–∏—â–µ–Ω–µ –º–∞–≥—ñ—á–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è. –í–æ–Ω–æ –º—ñ—Å—Ç–∏—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—É –≤–µ—Ä—Å—ñ—é –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó Firebase, —Ç–æ–∂ –≤–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ –º–æ–∂–µ –ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –º–∏—Ç—Ç—î–≤–æ –±–µ–∑ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å.",
                 }
             },
             {
                 keywords: ["restore", "backup", "upload"],
                 answers: {
                     en: "**Backup/Restore**: Go to the **Data Tab**. \n- **Download**: Save a .json backup. \n- **Restore**: Upload a .json backup. \n*Note: Restoring while connected will Sync/Overwrite the room data for everyone!*",
                     uk: "**–†–µ–∑–µ—Ä–≤–Ω–µ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è/–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è**: –ü–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ –≤–∫–ª–∞–¥–∫—É **–î–∞–Ω—ñ**. \n- **–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏**: –ó–±–µ—Ä–µ–∂—ñ—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É –∫–æ–ø—ñ—é .json. \n- **–í—ñ–¥–Ω–æ–≤–∏—Ç–∏**: –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É –∫–æ–ø—ñ—é. \n*–ü—Ä–∏–º—ñ—Ç–∫–∞: –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ–¥ —á–∞—Å –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î/–ø–µ—Ä–µ–∑–∞–ø–∏—à–µ –¥–∞–Ω—ñ –∫—ñ–º–Ω–∞—Ç–∏ –¥–ª—è –≤—Å—ñ—Ö!*",
                 }
             }
        ];
        
        // Chat Context for Multi-turn Conversation
        let chatCtx = {
            lastNodeId: null,
            awaiting: null // e.g., { type: 'prop_type', propName: 'age', nodeId: '...' }
        };

        function cleanInput(str) {
            return str.replace(/^(pls|please|kindly)\s+/i, '').trim();
        }

        async function processUserIntent(rawMsg) {
            const msg = cleanInput(rawMsg);
            const lower = msg.toLowerCase().trim();
            
            // --- INFO: FIREBASE / COLLABORATION ---
            if (lower.includes('firebase') || lower.includes('sync') || lower.includes('collaborat') || (lower.includes('share') && lower.includes('room'))) {
                 return "To **collaborate** in real-time:\n" +
                        "1. **Create Project** at [firebase.google.com](https://console.firebase.google.com). Add a 'Web App' (</>).\n" +
                        "2. **IMPORTANT**: Create Database in **Build > Realtime Database**.\n" +
                        "3. **Get Config** from Project Overview (</>) or Settings.\n" +
                        "4. Go to **Data Tab**, paste config, set **Room ID**, & **Connect**.";
            }

            // --- INFO: OFFLINE STATUS ---
            if (lower.includes('offline') || lower.includes('internet') || lower.includes('network') || lower.includes('online')) {
                return "I am an **offline-first AI assistant** running directly in your browser. I do not send your chat data to any external server (except for the real-time room sync if you use Firebase).";
            }

            // --- CONTEXT: WAIT FOR TYPE ---
            if (chatCtx.awaiting && chatCtx.awaiting.type === 'prop_type') {
                const node = nodes.find(n => n.id === chatCtx.awaiting.nodeId);
                if (node) {
                    const type = lower.split(' ')[0] || "string"; // Take first word
                    // Add the property
                    if (!node.props) node.props = [];
                    node.props.push({ name: chatCtx.awaiting.propName, type: type, color: getDefaultPropColor() });
                    await dbOp('nodes', 'readwrite', 'put', node);
                    await refreshData();
                    const pName = chatCtx.awaiting.propName;
                    chatCtx.awaiting = null; // Clear context
                    return `Added property **${pName}** : *${type}* to ${node.title}.`;
                }
                chatCtx.awaiting = null; // Expired context
            }
            
            // --- ACTION: CREATE COMPONENT ---
            // Pattern: "create component/table/collection [named/called/with name] [Title]"
            // Regex handles: "create table users", "create new table named users", "make box title users"
            // Ignore "pls" handled by cleanInput
            const createMatch = lower.match(/(?:create|add|make|new)\s+(?:new\s+)?(?:component|table|collection|node|box)\s+(?:named\s+|called\s+|with\s+name\s+|title\s+)?(.+)/i);
            
            if (createMatch) {
                let titleCandidate = createMatch[1].trim();
                // Remove trailing punctuation
                titleCandidate = titleCandidate.replace(/[.,;!?]$/, '');
                
                // Heuristic: If title starts with "name ", strip it (user typed "create table name users")
                if (titleCandidate.startsWith("name ")) {
                    titleCandidate = titleCandidate.substring(5).trim();
                }

                if(titleCandidate) {
                    const id = generateId();
                    const containerEl = document.getElementById('diagram-container');
                    const t = d3.zoomTransform(svg.node()) || {x:0, y:0, k:1};
                    const cx = (containerEl.clientWidth/2 - t.x)/t.k;
                    const cy = (containerEl.clientHeight/2 - t.y)/t.k;
                    
                    // Try to preserve original casing from raw message if possible
                    let displayTitle = titleCandidate;
                    try {
                        const regex = new RegExp(titleCandidate.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
                        const match = cleanInput(rawMsg).match(regex);
                        if (match) displayTitle = match[0];
                    } catch(e) {}

                    const newNode = {
                        id: id,
                        title: displayTitle,
                        description: "Created via Chat",
                        color: getDefaultCompColor(),
                        x: cx + (Math.random()-0.5)*50,
                        y: cy + (Math.random()-0.5)*50,
                        props: [{name: 'id', type: 'UUID', color: getDefaultPropColor()}],
                        createdAt: new Date().toISOString()
                    };
                    
                    await dbOp('nodes', 'readwrite', 'put', newNode);
                    await refreshData();
                    
                    chatCtx.lastNodeId = id;
                    simulation.alpha(0.3).restart();
                    
                    return `Created component **${newNode.title}**. \nWant to add a property? Type e.g. "email" or "name string".`;
                }
            }

            // --- ACTION: ADD PROPERTY ---
            // Detect various forms:
            // 1. "add property [name] [type?] to [table]"
            // 2. "add to [table] property [name] [type?]"
            // 3. "add [name] [type]" (uses context)
            // 4. "name:type" (uses context)
            // 5. "name" (uses context, asks for type)
            
            let targetNodeId = chatCtx.lastNodeId;
            let propName = null;
            let propType = null;
            let explicitTarget = false;

            // Check for explicit target syntax: "add to users property email"
            const addToMatch = lower.match(/add\s+(?:property\s+)?(?:to|in|for)\s+(?:(?:table|component)\s+)?(\w+)\s+(?:property\s+|field\s+|column\s+)?(\w+)(?::\s*|\s+)?(\w+)?/i);
            if (addToMatch) {
                const targetName = addToMatch[1];
                propName = addToMatch[2];
                propType = addToMatch[3];
                
                const node = nodes.find(n => n.title.toLowerCase() === targetName.toLowerCase());
                if (node) {
                    targetNodeId = node.id;
                    explicitTarget = true;
                } else {
                    return `Could not find component named **${targetName}** to add property to.`;
                }
            } 
            else if (lower.startsWith("add ")) {
                 // "add email string"
                 const parts = lower.replace("add ", "").trim().split(/\s+|:/);
                 // Handle "add property email string"
                 if (parts[0] === 'property' || parts[0] === 'prop' || parts[0] === 'column') parts.shift();
                 
                 propName = parts[0];
                 propType = parts[1];
            }
            else if (chatCtx.lastNodeId) {
                // Short syntax check: "name:string" or "name string" or just "name"
                // Only if last action was creating/modifying a node
                const parts = lower.split(/\s+|:/);
                if (parts.length <= 2 && /^[a-z0-9_]+$/i.test(parts[0])) {
                    // Start of heuristic: Avoid common conversational words if single word
                    const commonWords = ["ok", "thanks", "cool", "yes", "no", "hello"];
                    if (parts.length === 1 && commonWords.includes(parts[0])) {
                        // Ignore conversational filler
                    } else {
                        propName = parts[0];
                        propType = parts[1];
                    }
                }
            }

            // EXECUTE PROPERTY ADDITION
            if (propName && targetNodeId) {
                 const node = nodes.find(n => n.id === targetNodeId);
                 if (node) {
                     // If type is missing, ASK user
                     if (!propType) {
                         chatCtx.awaiting = { type: 'prop_type', propName: propName, nodeId: node.id };
                         chatCtx.lastNodeId = node.id; // Refresh context
                         return `Adding property **${propName}** to ${node.title}. What is the **type**? (e.g. string, int)`;
                     }

                     if (!node.props) node.props = [];
                     node.props.push({ name: propName, type: propType, color: getDefaultPropColor() });
                     await dbOp('nodes', 'readwrite', 'put', node);
                     await refreshData();
                     
                     chatCtx.lastNodeId = node.id; // Keep context focus
                     return `Added property **${propName}** : *${propType}* to ${node.title}.`;
                 }
            }

            // --- ACTION: CONNECT ---
            // Pattern: "connect [A] to [B]"
            const connectMatch = lower.match(/connect\s+(.+)\s+(?:to|with)\s+(.+)/);
            if (connectMatch) {
                const name1 = connectMatch[1].trim();
                const name2 = connectMatch[2].trim();
                
                const n1 = nodes.find(n => n.title.toLowerCase() === name1);
                const n2 = nodes.find(n => n.title.toLowerCase() === name2);
                
                if (n1 && n2) {
                     const newEdge = {
                        id: generateId(),
                        source: n1.id,
                        target: n2.id,
                        label: null,
                        createdAt: new Date().toISOString()
                    };
                    await dbOp('edges', 'readwrite', 'put', newEdge);
                    await refreshData();
                    simulation.alpha(0.3).restart();
                    return `Connected **${n1.title}** to **${n2.title}**.`;
                } else {
                    return `Could not find components '${name1}' and/or '${name2}'. Check spelling.`;
                }
            }
            
            // --- ACTION: SUGGEST CONNECTION ---
            if (lower.includes("suggest") || lower.includes("help me connect")) {
                 if (nodes.length < 2) return "You need at least 2 components to connect. Try creating another one.";
                 return `You have ${nodes.length} components. You can connect them by typing "connect [Name1] to [Name2]". \nFor example: "connect ${nodes[0].title} to ${nodes[1].title}".`;
            }

            // --- KNOWLEDGE FALLBACK ---
            let found = kmDatabase.find(qa => qa.keywords.some(k => lower.includes(k)));
            if (found) {
                return found.answers[currentLang] || found.answers['en'];
            }

            return null; // No match
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const history = document.getElementById('chat-history');
            const msg = input.value.trim(); // Do not lower case yet, preserve formatting for display
            if (!msg) return;

            // User Message
            history.innerHTML += `
               <div class="flex items-start gap-2.5 justify-end animation-fade-in-up">
                   <div class="bg-indigo-600 text-white p-2 rounded-lg rounded-tr-none max-w-[85%] text-xs shadow-sm text-left">
                       ${msg.replace(/</g, "&lt;")}
                   </div>
                   <div class="w-6 h-6 rounded-full bg-indigo-600 flex items-center justify-center text-xs text-white">You</div>
               </div>
            `;

            const originalText = input.value;
            input.value = '';
            history.scrollTop = history.scrollHeight;

            // Bot Processing
            // Show typing indicator?
            
            setTimeout(async () => {
                let response = await processUserIntent(originalText);
                
                // Fallback Logic
                if (!response) {
                    const lower = originalText.toLowerCase();
                    if (lower.includes("hello") || lower.includes("hi")) {
                         response = "Hello! I can help you build your database schema. Try 'create table Users' or 'tell me about mongodb'.";
                    } else {
                        response = "I'm not sure about that. I can help you **create components**, **add properties**, or **connect them**. \n\nTry: *'Create table Orders'* or *'Connect Users to Orders'*";
                    }
                }

                // Format Headers and Bolds
                // Simple Markdown-ish parser
                let formatted = response
                    .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                    .replace(/\n/g, '<br>');

                history.innerHTML += `
                    <div class="flex items-start gap-2.5 animate-pulse-once">
                       <div class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center text-xs">ü§ñ</div>
                       <div class="bg-indigo-50 text-indigo-800 p-2 rounded-lg rounded-tl-none max-w-[85%] text-xs shadow-sm">
                           ${formatted}
                       </div>
                    </div>
                `;
                history.scrollTop = history.scrollHeight;
            }, 500);
        }



        window.onload = async () => {
            await initDB();
            checkFirstTimeUser(); // Check nickname
            
            // Init User Badge & Color
            let myName = localStorage.getItem('my_user_name');
            let myColor = localStorage.getItem('my_user_color');
            
            if(!myColor) {
               // Generate random user color if missing
               const colors = ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#6366F1', '#8B5CF6', '#EC4899'];
               myColor = colors[Math.floor(Math.random() * colors.length)];
               localStorage.setItem('my_user_color', myColor);
            }
            // Update global var if defined
            if(typeof myUserColor !== 'undefined') myUserColor = myColor;
            
            updateUserHeaderBadge(myName, myColor);
            
            initTheme(); // Load Theme
            initColorPrefs(); // Load Default Colors
            updateConnectionBadge(false); // Set Initial Badge State (Local)
            for(let i=0; i<1; i++) addPropInput(); // Default 1 property
            simulation.force("center", d3.forceCenter(container.clientWidth / 2, container.clientHeight / 2));
            refreshData();

            // restore Config if remembered
            const cachedConfig = localStorage.getItem('fb_config_str');
            if(cachedConfig) {
                const confArea = document.getElementById('fb-config-json');
                const remCheck = document.getElementById('fb-remember');
                if(confArea) confArea.value = cachedConfig;
                if(remCheck) remCheck.checked = true;
            }

            // Auto-Init Firebase if config field has value (cached/autofilled)
            if(document.getElementById('fb-config-json') && document.getElementById('fb-config-json').value) {
                initFirebase();
            } else {
                 // 1. Check URL for Config Payload (Magic Link)
                 const urlParams = new URLSearchParams(window.location.search);
                 const encodedConfig = urlParams.get('config');
                 let autoInit = false;
                 
                 if (encodedConfig) {
                     try {
                         const raw = atob(encodedConfig);
                         let decodedConf = raw;
                         
                         // Determine if Legacy (Plain JSON) or Encrypted
                         // JSON usually starts with {
                         let isLegacy = false;
                         try {
                              if(raw.trim().startsWith('{')) {
                                  JSON.parse(raw);
                                  isLegacy = true; 
                              }
                         } catch(e) {}

                         if(!isLegacy) {
                             // Decrypt
                             decodedConf = simpleCipher(raw);
                         }

                         // Validate structure basic check
                         if(decodedConf.includes("apiKey")) {
                             document.getElementById('fb-config-json').value = decodedConf;
                             showToast("Configuration Loaded from Link", "success");
                             // Default to NOT remembering shared config unless user checks box
                             document.getElementById('fb-remember').checked = false;
                             autoInit = true;
                         }
                     } catch(e) {
                         console.error("Config Decode Failed", e);
                         showToast("Invalid Configuration Link", "error");
                     }
                 }
                 
                 // 2. Fallback to LocalStorage if not in URL
                 if (!autoInit) {
                     const savedConfig = localStorage.getItem('fb_config_str');
                     if(savedConfig) { 
                         document.getElementById('fb-config-json').value = savedConfig;
                         // If we loaded from local storage, auto-check Remember Box 
                         document.getElementById('fb-remember').checked = true;
                         autoInit = true;
                     }
                 }

                 // 3. Trigger Init if we have config
                 if(autoInit) {
                     // Brief delay to ensure UI ready
                     setTimeout(initFirebase, 100); 
                 } else {
                     // Default Remember to TRUE for fresh users manually entering
                     document.getElementById('fb-remember').checked = true;
                 }
                 
                 // If room parameter exists, ensure Data Tab is open so user sees they need to config
                 if(urlParams.get('room')) {
                      // Switch to Data Tab
                      switchTab('data');
                      if(!autoInit) {
                          showToast("Please paste Firebase Config to connect", "info");
                      }
                 }
            }

            // Initialize Draggables
            makeDraggable('fab-help');
            makeDraggable('fab-add');
            makeDraggable('zoom-controls');
            makeDraggable('component-window', 'comp-window-header');
            makeDraggable('comments-window', 'comments-header'); // Init Comments Window
            makeDraggable('fab-components'); // Restore missing draggable

            // Restore Component Window State safely after DOM load
            if (localStorage.getItem('compWindowOpen') === 'true') {
                 toggleComponentWindow(true);
            }

            // Initialize Search
            const searchInput = document.getElementById('comp-search');
            if(searchInput) {
                 searchInput.addEventListener('input', updateComponentList);
            }

            // Initialize Language and sync both selects
            const langSelect = document.getElementById('lang-select');
            const langSelectSidebar = document.getElementById('lang-select-sidebar');
            if(langSelect) langSelect.value = currentLang;
            if(langSelectSidebar) langSelectSidebar.value = currentLang;
            changeLanguage(currentLang);
            
            // Set initial tab to 'create'
            switchTab('create');
            
            // Populate settings inputs
            updateSettingsInputs();
        };

        window.addEventListener('resize', () => {
             simulation.force("center", d3.forceCenter(container.clientWidth / 2, container.clientHeight / 2));
             simulation.alpha(0.3).restart(); 
        });
    </script>

    <!-- Global Loading Spinner -->
    <div id="global-spinner" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[9999] flex flex-col items-center justify-center hidden transition-opacity duration-300">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
        <div class="text-indigo-800 font-medium">Loading DB Schema...</div>
    </div>

    <!-- Welcome / Nickname Modal -->
    <div id="welcome-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[9999] flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md transform transition-all scale-100 opacity-100">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl">üëã</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Welcome!</h2>
                <p class="text-gray-600 mt-2">Please set a nickname for collaboration.</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Your Nickname</label>
                    <input type="text" id="welcome-nickname" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="e.g. Database Architect">
                    <p class="text-[10px] text-gray-400 mt-1">This name will be shown to other users when you move your cursor.</p>
                </div>
                
                <button onclick="saveNickname()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition shadow-lg transform active:scale-95">
                    Start Using App
                </button>
                
                <button onclick="skipNickname()" class="w-full bg-white hover:bg-gray-50 text-gray-500 font-medium py-2 rounded-lg transition border border-gray-200">
                    Skip (Join as Guest)
                </button>
            </div>
        </div>
    </div>

    <!-- Comments Window -->
    <div id="comments-window" class="fixed hidden flex flex-col bg-white rounded-xl shadow-2xl border border-gray-200 z-40 transition-all duration-300 overflow-hidden" style="top: 100px; right: 20px; width: 300px; height: 350px; min-height: 200px; max-height: 90vh;">
        <!-- Header -->
        <div id="comments-header" class="bg-gradient-to-r from-gray-50 to-white p-3 border-b border-gray-100 flex justify-between items-center cursor-move select-none shrink-0">
             <div class="flex items-center gap-2">
                 <svg class="w-4 h-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg>
                 <h3 class="font-bold text-gray-700 text-xs uppercase tracking-wide">Comments</h3>
             </div>
             <div class="flex items-center gap-1">
                 <button onclick="toggleCommentsHeight()" class="p-1 hover:bg-gray-100 rounded text-gray-400 hover:text-gray-600 transition" title="Toggle Full Height">
                     <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                 </button>
                 <button onclick="toggleCommentsWindow(false)" class="p-1 hover:bg-red-50 rounded text-gray-400 hover:text-red-500 transition">
                     <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                 </button>
             </div>
        </div>

        <!-- Filter -->
        <div class="px-3 py-2 border-b border-gray-100 flex gap-2 shrink-0">
             <label class="flex items-center gap-1.5 cursor-pointer select-none">
                 <input type="checkbox" id="show-resolved-check" class="w-3 h-3 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500" onchange="renderCommentsList()">
                 <span class="text-[10px] font-medium text-gray-600">Show Resolved</span>
             </label>
        </div>
        
        <!-- List -->
        <div id="comments-list" class="flex-grow overflow-y-auto p-0 space-y-0 custom-scrollbar bg-gray-50/50">
             <!-- Comments injected here -->
             <div class="text-center p-8 text-gray-400 text-xs">No comments yet.</div>
        </div>
        
        <!-- Footer -->
        <div class="p-3 border-t border-gray-100 bg-gray-50 shrink-0">
             <div class="text-[10px] text-gray-500 text-center">
                 Click on canvas to add a comment <br/>
                 <span class="text-[9px] text-gray-400">(When this window is open)</span>
             </div>
        </div>
    </div>

    <!-- Custom Comment Input Popover -->
    <div id="comment-input-popover" class="fixed hidden z-[100] bg-white rounded-lg shadow-xl border border-gray-200 p-3 w-64">
        <h4 class="text-xs font-bold text-gray-500 mb-2">New Comment Thread</h4>
        <textarea id="new-comment-text" class="w-full text-xs p-2 border border-gray-300 rounded mb-2 focus:ring-2 focus:ring-indigo-500 outline-none resize-none" rows="3" placeholder="Type your comment..."></textarea>
        <div class="flex justify-end gap-2">
            <button onclick="hideCommentPopover()" class="text-xs text-gray-500 hover:text-gray-700 px-2 py-1">Cancel</button>
            <button onclick="submitNewComment()" class="text-xs bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700 font-bold">Post</button>
        </div>
    </div>

</body>
</html>
